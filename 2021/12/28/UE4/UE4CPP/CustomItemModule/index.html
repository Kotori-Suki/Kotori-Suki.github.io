<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="一个年轻人奔向梦想的足迹" href="https://kotori_suki.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="一个年轻人奔向梦想的足迹" href="https://kotori_suki.github.io/atom.xml"><link rel="alternate" type="application/json" title="一个年轻人奔向梦想的足迹" href="https://kotori_suki.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://kotori_suki.github.io/2021/12/28/UE4/UE4CPP/CustomItemModule/"><title>Custom Item Module - ModuleDesign - UE4_C++ - UE4 | Afei's Blog = 一个年轻人奔向梦想的足迹 = Welcome to my blog !</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Custom Item Module</h1><div class="meta"><span class="item" title="创建时间：2021-12-28 16:36:11"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-12-28T16:36:11+08:00">2021-12-28</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Afei's Blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeyvx1d4j20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclwuom7cj20zk0m8dvn.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclxp31goj20zk0m8qv5.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeu7txpzj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/UE4/" itemprop="item" rel="index" title="分类于 UE4"><span itemprop="name">UE4</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/UE4/UE4CPP/" itemprop="item" rel="index" title="分类于 UE4_C++"><span itemprop="name">UE4_C++</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/UE4/UE4CPP/ModuleDesign/" itemprop="item" rel="index" title="分类于 ModuleDesign"><span itemprop="name">ModuleDesign</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://kotori_suki.github.io/2021/12/28/UE4/UE4CPP/CustomItemModule/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="-YIFEI-"><meta itemprop="description" content="Welcome to my blog !, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="一个年轻人奔向梦想的足迹"></span><div class="body md" itemprop="articleBody"><h1 id="custom-item-module"><a class="anchor" href="#custom-item-module">#</a> Custom Item Module</h1><p>简介：本篇主要记录写者 “自定义物品模组” 的框架设计与实现思路。整篇代码实现较为简单 (只是雏形，代码不免有点粗糙)，但涉及的方面比较多。所以，阅读本篇之前希望读者对以下知识点有一定了解。</p><ul><li>UObject 的网络复制与 RPC</li><li>FFastArraySerializer 与 FFastArraySerializerItem 的工作原理</li><li>Unreal 的自旋锁 FScopeLock</li><li>GAS 系统 (主要用在武器，食物等物品的使用效果中)</li><li>UObject 的初始化流程 (生成 ItemName 与 CDO 的映射时间点)</li></ul><p>话不多说，直接开冲！</p><h2 id="总览"><a class="anchor" href="#总览">#</a> 总览</h2><p>先上<strong>类图</strong>：</p><p><img data-src="ItemModule%E7%B1%BB%E5%9B%BE.png" alt="ItemModule类图"></p><p>再来看看每个类的<strong>简要定义</strong>：</p><p><img data-src="ItemModule%E5%AE%9A%E4%B9%89.png" alt="ItemModule定义"></p><p>以上二图描述了我们本次自定义模组 &quot;CustomItemModule&quot; 的六个主要类，其职责分别如下：</p><ul><li>ItemInfo：所有物品信息类的基类，描述了所有物品共有的属性和方法</li><li>SubItem：子物品类，如：武器，材料，食物等。每个类有各自的属性和方法完成特定逻辑</li><li>ItemInteface：访问玩家拥有物品的接口。如：GetSingleItem，AddSingleItem 等</li><li>ItemComponent：安装在玩家控制器上的组件，记录此玩家所拥有的所有物品，持有访问 / 使用物品等函数</li><li>ItemContainer：记录玩家拥有物品的容器，其中包含需要网络序列化的 Items 数组，与仅供本地使用的 TMap (提高对拥有物品的访问效率)</li><li>OwnedItem：描述玩家拥有的单件物品</li></ul><p>类图中可以发现，最上层的类其实是 &quot;UItemComponent&quot;。该组件拥有关于玩家物品的所有信息 (UItemContainers) ，同时也拥有访问与操作所有物品的函数 (Get，Use，Sell 等)。组件类基于其他所有类，其他所有类的实现保证了组件类可以正常运行。而多样化的 SubItem 实现了不同物品的不同使用方法，保证了 ItemModule 的扩展。</p><h2 id="源码解析"><a class="anchor" href="#源码解析">#</a> 源码解析</h2><p>为了提高源码之间的逻辑关联，源码部分写者将按开发顺序来逐步分析。</p><h3 id="iteminfo"><a class="anchor" href="#iteminfo">#</a> ItemInfo</h3><p>首先咱们需要把所有物品信息的基类定义出来，以便确定物品所共有的属性，以及关于物品的通用方法。源码如下：</p><p></p><figure class="highlight c++"><figcaption><span>ItemInfo.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  所有 Item 的基类，记录 Item 的共有数据与虚方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UCLASS</span>(ClassGroup = ItemModule)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ITEM_API</span> <span class="title">UItemInfo</span> :</span> <span class="keyword">public</span> UObject</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 默认构造函数 */</span></span><br><span class="line">	<span class="built_in">UItemInfo</span>()</span><br><span class="line">	: <span class="built_in">Name</span>(NAME_None)</span><br><span class="line">	, <span class="built_in">Rarity</span>(ERarity::Common)</span><br><span class="line">	, <span class="built_in">Icon</span>(TSoftObjectPtr&lt;UTexture2D&gt;())</span><br><span class="line">	, <span class="built_in">Mesh</span>(TSoftObjectPtr&lt;UStaticMesh&gt;())</span><br><span class="line">	, <span class="built_in">bUsable</span>(<span class="literal">false</span>)</span><br><span class="line">	, <span class="built_in">Description</span>(<span class="built_in">FString</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line">	, <span class="built_in">ProductionPlace</span>(<span class="built_in">FString</span>(<span class="string">&quot;&quot;</span>))</span><br><span class="line">	&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostCDOContruct</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 物品名获取物品信息 CDO 的静态方法</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> UItemInfo* <span class="title">GetInfoByName</span><span class="params">(FName Name)</span></span>;</span><br><span class="line">	<span class="keyword">static</span> TMap&lt;FName, UItemInfo*&gt; ItemInfos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 使用该物品</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">TryUseItem</span><span class="params">(AActor* Instigator)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 提供给蓝图的 CanUse 接口</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintImplementableEvent, Category = <span class="string">&quot;ItemInfo&quot;</span>, meta = (DisplayName = <span class="string">&quot;RequirementForUsing&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">K2_CanUse</span><span class="params">(AActor* Instigator)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 本地 CanUse 函数</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">CanUse</span><span class="params">(AActor* Instigator)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 提供给蓝图的 ApplyItemEffect 接口</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintImplementableEvent, Category = <span class="string">&quot;ItemInfo&quot;</span>, meta = (DisplayName = <span class="string">&quot;UseItemEffect&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_ApplyItemEffect</span><span class="params">(AActor* Instigator)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 本地 ApplyItemEffect 函数</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ApplyItemEffect</span><span class="params">(AActor* Instigator)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品名称，同时作为获取该物品 CDO 的键 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	FName Name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品稀有度 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	ERarity Rarity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品类型，不同类型的物品对应存在不同的容器中，以减少CPU性能和网络带宽的消耗 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	EItemType Type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品图标，用于 UI 显示 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	TSoftObjectPtr&lt;UTexture2D&gt; Icon;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品的静态网格体，在 ItemActor 实例化时使用 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	TSoftObjectPtr&lt;UStaticMesh&gt; Mesh;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 该物品是否可以使用，如: 武器，食物可以直接使用；而材料则不行 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	<span class="keyword">bool</span> bUsable;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否每个实例都与 CDO 一样 (例如: 武器就是每把都不一样的，所以是 false)</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	<span class="keyword">bool</span> bStatic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品价格 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	int32 Price;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品描述 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	FString Description;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 物品产出地描述 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadWrite, Category = <span class="string">&quot;ItemInfo&quot;</span>)</span><br><span class="line">	FString ProductionPlace;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight c++"><figcaption><span>ItemInfo.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemInfo::PostCDOContruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ItemInfos.<span class="built_in">Add</span>(Name, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">UItemInfo* <span class="title">UItemInfo::GetInfoByName</span><span class="params">(FName Name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> *(ItemInfos.<span class="built_in">Find</span>(Name));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemInfo::TryUseItem</span><span class="params">(AActor* Instigator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">CanUse</span>(Instigator))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ApplyItemEffect</span>(Instigator);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TMap&lt;FName, UItemInfo*&gt; UItemInfo::ItemInfos;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemInfo::CanUse</span><span class="params">(AActor* Instigator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">K2_CanUse</span>(Instigator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemInfo::ApplyItemEffect</span><span class="params">(AActor* Instigator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_ApplyItemEffect</span>(Instigator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&quot;ItemInfo&quot; 的属性和方法都比较基础，必要的说明也已经写在注释中。这只是 &quot;ItemInfo&quot; 的雏形，如有需要可以继续拓展。在后续的游戏版本迭代中出现的物品子类，其实也都是此物品类的拓展。</p><h2 id="iteminterface"><a class="anchor" href="#iteminterface">#</a> ItemInterface</h2><p>在确定了 &quot;ItemInfo&quot; 后，我们还需要确定访问玩家拥有物品的方法，并将其独立出来做成抽象接口。当前主要包括 对拥有物品的增删查改 这些基础方法，后续开发可以按需扩展。代码定义如下：</p><p></p><figure class="highlight c++"><figcaption><span>ItemInterface</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UINTERFACE</span>(MinimalAPI)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UItemInterface</span> :</span> <span class="keyword">public</span> UInterface</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UItemInfo</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ITEM_API</span> <span class="title">IItemInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加单个 Item 到 ItemContainer 中</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">AddSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 AddNum = <span class="number">1</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从 ItemContainer 中移除指定数量的单个 Item ，数量为 0 则全部移除</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">RemoveSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 RemoveNum = <span class="number">0</span>)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 清空指定类别的 ItemContainer</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">ClearTypeItem</span><span class="params">(EItemType InItemType)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 清空所有的 ItemContainer</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ClearAllItem</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 修改 ItemContainer 中指定项的数量，没有则添加该项。添加成功或修改成功返回真，否则返回假</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SetSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*---------------------------------------------- LocalOnly ---------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取玩家拥有的给定 Item 的数量。非静态 Item 永远返回 1 或 0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetSingleItemData</span><span class="params">(UItemInfo* OutItemInfo)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取给定类型的 Item 的所有数据，包括 Mesh，Icon，Num 等。</span></span><br><span class="line"><span class="comment">	 * 获取成功返回真，否则返回假</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">GetTypeItemData</span><span class="params">(EItemType InItemType, TMap&lt;UItemInfo*, int32&gt;&amp; OutItemContainer)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取所有类型的 Item 的所有数据，包括 Mesh，Icon，Num 等。</span></span><br><span class="line"><span class="comment">	 * 获取成功返回真，否则返回假</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetAllItemData</span><span class="params">(TMap&lt;UItemInfo*, int32&gt;&amp; OutItemContainer)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>&quot;增删查改&quot; 中，写操作主要由服务器调用，改后通过属性复制同步给客户端。而读操作则是纯客户端操作，主要用于获取 Items 数据显示到 UI 等。</p><h2 id="itemcomponent-的定义"><a class="anchor" href="#itemcomponent-的定义">#</a> ItemComponent 的定义</h2><p>接下来，我们可以先定义组件类需要实现的方法 (但先不实现)。然后构思实现这些方法所需的其他类和方法。此阶段我们可以先把整个模块的类图确定下来，然后一步步实现。上文的类图和简要定义图皆是此阶段所做的。代码如下：</p><p></p><figure class="highlight c++"><figcaption><span>ItemComponent.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DECLARE_MULTICAST_DELEGATE_OneParam</span>(FNotifyItemOpera, FString);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AItemActor</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">UCLASS</span>(ClassGroup = ItemModule, editinlinenew, meta = (BlueprintSpawnableComponent))</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ITEM_API</span> <span class="title">UItemComponent</span> :</span> <span class="keyword">public</span> UActorComponent, <span class="keyword">public</span> IItemInterface</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** 拾取地图中的物品实例 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;PickItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_PickItem</span><span class="params">(AItemActor* PickUpItem, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加物品</span></span><br><span class="line"><span class="comment">	 * @param ItemInfo			如果 Item 为静态的(即. 物体的效果不因实例的改变而改变)，则使用CDO，否则使用 UItemInfo 的实例</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;AddItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_AddItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 使用物品 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;UseItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_UseItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 主要用于卸下装备时，复原角色基本属性等 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;DisuseItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_DisuseItem</span><span class="params">(UItemInfo* ItemInfo)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 移除物品 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;RemoveItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_RemoveItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 出售物品 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;SellItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_SellItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 可用于添加或减少 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;AddCoin&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_AddCoin</span><span class="params">(int32 Num, <span class="keyword">const</span> FString&amp; AddCoinReason)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">CheakItemEnough</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintNativeEvent, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;RequirementForPickItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">CanPickItem</span><span class="params">(AItemActor* PickUpItem, int32 Num = <span class="number">1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintNativeEvent, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;RequirementForUseItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">CanUseItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintNativeEvent, Category = <span class="string">&quot;Items&quot;</span>, meta = (DisplayName = <span class="string">&quot;RequirementForAddItem&quot;</span>))</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">CanAddCoin</span><span class="params">(int32 Num, <span class="keyword">const</span> FString&amp; AddCoinReason)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*------------------------------------ RPC ------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Server,Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AskServerAddItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Server, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AskServerRemoveItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Server, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AskServerUseItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Server, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AskServerDisuseItem</span><span class="params">(UItemInfo* ItemInfo)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Server, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AskServerSellItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num = <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Server, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AskServerAddCoin</span><span class="params">(int32 Num, <span class="keyword">const</span> FString&amp; AddCoinReason)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ItemInterface Function Begin~~~ */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">AddSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 AddNum = <span class="number">1</span>)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">RemoveSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 RemoveNum = <span class="number">0</span>)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">ClearTypeItem</span><span class="params">(EItemType InItemType)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ClearAllItem</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">SetSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetSingleItemData</span><span class="params">(UItemInfo* ItemInfo)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">GetTypeItemData</span><span class="params">(EItemType InItemType, TMap&lt;UItemInfo*, int32&gt;&amp; OutItemCounter)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetAllItemData</span><span class="params">(TMap&lt;UItemInfo*, int32&gt;&amp; OutItemCounter)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="comment">/* ItemInterface Function End~~~ */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*------------------------------------ Container , Counter 相关 ------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 将给定 Container 重置，并更新为给定 TMap */</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">SetItemContainer</span><span class="params">(EItemType ItemType, TMap&lt;UItemInfo*, int32&gt;&amp;&amp; InItemContainer)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 检查传入 ItemName 是否有效。无效返回假，有效返回真，且将 Name 的类型返回 */</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">CheakItemNameValid</span><span class="params">(FName ItemName, EItemType&amp; OutItemType, UItemInfo*&amp; ItemInfo)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 获取给定类型的 ItemContainer，一般用于服务器 */</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">GetContainerFromType</span><span class="params">(EItemType InType, FItemContainer&amp; OutContainter)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 SubItemsCounter 中的指定一项更新为 Num</span></span><br><span class="line"><span class="comment">	 * 如果没有给定 Name 的项则添加一条新记录，如果 Num 为 0，则移除该记录</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Client, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用 Items 更新 SubItemsCounter 中的所有项</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(Client, Reliable)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateAllItem</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** 提高网络复制效率，减少带宽消耗 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_1;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_2;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_3;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_4;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_5;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_6;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_7;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_8;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_9;</span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	FItemContainer SubItems_10;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 玩家拥有的金币数 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(Replicated)</span><br><span class="line">	int32 CoinNum;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 对 Item 的操作失败时调用 */</span></span><br><span class="line">	FNotifyItemOpera NotifyItemOperaFails;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>如此得知，为了实现 &quot;PickItem&quot; 等操作，我们需要存储 Item 的容器，交易 Item 时需要的 CoinNum，以及通知服务器 / 客户端执行相关 RPC 函数等。这样一来，我们就必须先把容器做出来，才能进一步实现其他函数。所以 &quot;ItemComponent&quot; 源文件的实现可以暂时搁置。</p><h2 id="fowneditem"><a class="anchor" href="#fowneditem">#</a> FOwnedItem</h2><p>&quot;FItemContainer&quot; 容器中的子项。此结构表示玩家所拥有的某一种 Item 的相关数据，定义如下：</p><p></p><figure class="highlight c++"><figcaption><span>FOwnedItem.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FOwnedItem</span> :</span> <span class="keyword">public</span> FFastArraySerializerItem</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_USTRUCT_BODY</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 默认构造函数 */</span></span><br><span class="line">	<span class="built_in">FOwnedItem</span>()</span><br><span class="line">		: <span class="built_in">ItemInfo</span>(<span class="literal">nullptr</span>)</span><br><span class="line">		, <span class="built_in">ItemNum</span>(<span class="number">0</span>)</span><br><span class="line">	&#123; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FOwnedItem</span>(UItemInfo* InInfo, int32 InNum)</span><br><span class="line">		: <span class="built_in">ItemInfo</span>(InInfo)</span><br><span class="line">		, <span class="built_in">ItemNum</span>(InNum)</span><br><span class="line">	&#123; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** 主要用于移除数组元素时的元素比较 */</span></span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FOwnedItem&amp; R_OwnedItem)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ItemInfo == R_OwnedItem.ItemInfo;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/** 静态 Item 为指向其 CDO 的指针，非静态 Item 则为该 Item 的实例 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	UItemInfo* ItemInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 此 Item 的数量，非静态 Item 永远为 1 */</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	int32 ItemNum;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* FFastArraySerializerItem Interface Begin~~~ */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PreReplicatedRemove</span><span class="params">(<span class="keyword">const</span> struct FItemContainer&amp; InArray)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PostReplicatedAdd</span><span class="params">(<span class="keyword">const</span> struct FItemContainer&amp; InArray)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PostReplicatedChange</span><span class="params">(<span class="keyword">const</span> struct FItemContainer&amp; InArray)</span></span>;</span><br><span class="line">    </span><br><span class="line">	<span class="function">FString <span class="title">GetDebugString</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/* FFastArraySerializerItem Interface End~~~ */</span></span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight c++"><figcaption><span>FOwnedItem.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FOwnedItem::PreReplicatedRemove</span><span class="params">(<span class="keyword">const</span> struct FItemContainer&amp; InArray)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Client 函数，只更新客户端的 SubItemsCounter</span></span><br><span class="line">	InArray.Owner-&gt;<span class="built_in">UpdateSingleItem</span>(ItemInfo, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FOwnedItem::PostReplicatedAdd</span><span class="params">(<span class="keyword">const</span> struct FItemContainer&amp; InArray)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Client 函数，只更新客户端的 SubItemsCounter</span></span><br><span class="line">	InArray.Owner-&gt;<span class="built_in">UpdateSingleItem</span>(ItemInfo, ItemNum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FOwnedItem::PostReplicatedChange</span><span class="params">(<span class="keyword">const</span> struct FItemContainer&amp; InArray)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Client 函数，只更新客户端的 SubItemsCounter</span></span><br><span class="line">	InArray.Owner-&gt;<span class="built_in">UpdateSingleItem</span>(ItemInfo, ItemNum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FString <span class="title">FOwnedItem::GetDebugString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;FOwnedItem::GetDebugString&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>实现的函数全部是 &quot;FFastArraySerializerItem&quot; 的接口，此类提供了 &quot;TArray&quot; 的网络增量复制方法。具体实现方法我们不做展开。重写的函数体里调用 Client 函数，因为我们不想让服务器的 SubItemCounters (记录容器中所有 Items 的 TMap，仅存在客户端，在 Items 数组更新时更新，主要用于客户端的快速访问) 也一起更新。</p><h2 id="fitemcontainer"><a class="anchor" href="#fitemcontainer">#</a> FItemContainer</h2><p>&quot;FItemContainer&quot; 即 记录玩家所拥有的 Item 的容器。其中包含需要网络同步的 Items 数组和仅限客户端使用的 SubItemCounters (ItemInfo* 到 ItemNum 的映射），定义如下：</p><p></p><figure class="highlight c++"><figcaption><span>FItemContainer.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">USTRUCT</span>(BlueprintType)</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ITEM_API</span> <span class="title">FItemContainer</span> :</span> <span class="keyword">public</span> FFastArraySerializer</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_USTRUCT_BODY</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Default Constructor */</span></span><br><span class="line">	<span class="built_in">FItemContainer</span>()</span><br><span class="line">	&#123; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FItemContainer</span>(<span class="keyword">const</span> TArray&lt;FOwnedItem&gt;&amp; InItems, UItemComponent* InOwner)</span><br><span class="line">		: <span class="built_in">Items</span>(InItems)</span><br><span class="line">		, <span class="built_in">Owner</span>(InOwner)</span><br><span class="line">	&#123; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FItemContainer</span>(TArray&lt;FOwnedItem&gt;&amp;&amp; InItems, UItemComponent* InOwner)</span><br><span class="line">		: <span class="built_in">Items</span>(<span class="built_in">MoveTemp</span>(InItems))</span><br><span class="line">		, <span class="built_in">Owner</span>(InOwner)</span><br><span class="line">	&#123; </span><br><span class="line">		InOwner = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FItemContainer&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FItemContainer&amp; R_ItemContainer)</span><br><span class="line">	&#123;</span><br><span class="line">		Items = R_ItemContainer.Items;</span><br><span class="line">		Owner = R_ItemContainer.Owner;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FItemContainer&amp; <span class="keyword">operator</span>=(FItemContainer&amp;&amp; R_ItemContainer)</span><br><span class="line">	&#123;</span><br><span class="line">		Items = <span class="built_in">MoveTemp</span>(R_ItemContainer.Items);</span><br><span class="line">		Owner = R_ItemContainer.Owner;</span><br><span class="line">		R_ItemContainer.Owner = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FItemContainer&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> TMap&lt;UItemInfo*, int32&gt;&amp; R_ItemContainer)</span><br><span class="line">	&#123;</span><br><span class="line">		Items.<span class="built_in">Empty</span>(R_ItemContainer.<span class="built_in">Num</span>());</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> R_Item : R_ItemContainer)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AddSingleItem</span>(R_Item.Key, R_Item.Value);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FItemContainer&amp; <span class="keyword">operator</span>=(TMap&lt;UItemInfo*, int32&gt;&amp;&amp; R_ItemContainer)</span><br><span class="line">	&#123;</span><br><span class="line">		Items.<span class="built_in">Empty</span>(R_ItemContainer.<span class="built_in">Num</span>());</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span> R_Item : R_ItemContainer)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AddSingleItem</span>(R_Item.Key, R_Item.Value);</span><br><span class="line">		&#125;</span><br><span class="line">		R_ItemContainer.<span class="built_in">Empty</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*------------------------------------- Counter 相关，仅限客户端使用 -------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取 Counter 中的 Item</span></span><br><span class="line">	<span class="function">int32 <span class="title">GetSingleItem</span><span class="params">(UItemInfo* OutItemInfo)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取 Counter 列表</span></span><br><span class="line">	<span class="function">TMap&lt;UItemInfo*, int32&gt; <span class="title">GetAllItems</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新 Counter 中的单个 Item</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 更新 Counter 中的所有 Item</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">UpdateAllItems</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*------------------------------------- Container 相关，仅限服务器使用 -------------------------------------*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 此容器中是否包含传入名字的 Item </span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">ContainItem</span><span class="params">(UItemInfo* ItemInfo)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置此容器中传入名称的 Item 的数量，没有则添加新记录</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SetSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将传入名称的 Item 的数量增加 Num 个，没有则添加一条记录</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">AddSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将传入名称的 Item 的数量减少 Num 个，不足或没有则返回 false</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">RemoveSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 清空此 Items 中的所有项</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ClearItems</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 网络增量序列化，在 Items 数组中的元素被标记为脏时调用</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">NetDeltaSerialize</span><span class="params">(FNetDeltaSerializeInfo&amp; DeltaParms)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 此容器所装载的玩家拥有的某一类 Item 的所有物品，包括 ItemInfo 和 ItemNum</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	TArray&lt;FOwnedItem&gt; Items;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拥有此容器的 ItemComponent</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>()</span><br><span class="line">	UItemComponent* Owner;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TMap 版 Items, 在 Items 同步时更新。仅存在于客户端，以提高获取 Items 数据的效率</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(NotReplicated)</span><br><span class="line">	TMap&lt;UItemInfo*, int32&gt; SubItemsCounter;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">mutable</span> FRWLock ContainerLock;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight c++"><figcaption><span>ItemContainer.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FItemContainer::GetSingleItem</span><span class="params">(UItemInfo* OutItemInfo)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> *SubItemsCounter.<span class="built_in">Find</span>(OutItemInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">TMap&lt;UItemInfo*, int32&gt; <span class="title">FItemContainer::GetAllItems</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> SubItemsCounter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FItemContainer::UpdateSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SubItemsCounter.<span class="built_in">FindOrAdd</span>(ItemInfo) = Num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FItemContainer::UpdateAllItems</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SubItemsCounter.<span class="built_in">Reset</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> Item : Items)</span><br><span class="line">	&#123;</span><br><span class="line">		SubItemsCounter.<span class="built_in">FindOrAdd</span>(Item.ItemInfo) = Item.ItemNum;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FItemContainer::ContainItem</span><span class="params">(UItemInfo* ItemInfo)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 加读锁</span></span><br><span class="line">	<span class="function">FRWScopeLock <span class="title">ReadLock</span><span class="params">(ContainerLock, FRWScopeLockType::SLT_ReadOnly)</span></span>;</span><br><span class="line">	<span class="keyword">return</span> Items.<span class="built_in">FindByPredicate</span>([&amp;](FOwnedItem InItem)&#123; <span class="keyword">return</span> InItem.ItemInfo == ItemInfo; &#125;) != <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FItemContainer::SetSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 加写锁</span></span><br><span class="line">	<span class="function">FRWScopeLock <span class="title">WriteLock</span><span class="params">(ContainerLock, FRWScopeLockType::SLT_Write)</span></span>;</span><br><span class="line"></span><br><span class="line">	FOwnedItem* Item = Items.<span class="built_in">FindByPredicate</span>([&amp;](FOwnedItem InItem) &#123; <span class="keyword">return</span> InItem.ItemInfo == ItemInfo; &#125;);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (Item != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Item-&gt;ItemNum = Num;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// FOwnedItem 的数据结构简单，由 TArray 完全管理其内存</span></span><br><span class="line">		Item = <span class="keyword">new</span> <span class="built_in">FOwnedItem</span>(ItemInfo, Num);</span><br><span class="line">		Items.<span class="built_in">Add</span>(*Item);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">MarkItemDirty</span>(*Item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FItemContainer::AddSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 加写锁</span></span><br><span class="line">	<span class="function">FRWScopeLock <span class="title">WriteLock</span><span class="params">(ContainerLock, FRWScopeLockType::SLT_Write)</span></span>;</span><br><span class="line"></span><br><span class="line">	FOwnedItem* Item = Items.<span class="built_in">FindByPredicate</span>([&amp;](FOwnedItem InItem) &#123; <span class="keyword">return</span> InItem.ItemInfo == ItemInfo; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Item != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Item-&gt;ItemNum += Num;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// FOwnedItem 的数据结构简单，由 TArray 完全管理其内存</span></span><br><span class="line">		Item = <span class="keyword">new</span> <span class="built_in">FOwnedItem</span>(ItemInfo, Num);</span><br><span class="line">		Items.<span class="built_in">Add</span>(*Item);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">MarkItemDirty</span>(*Item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FItemContainer::RemoveSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 加写锁</span></span><br><span class="line">	<span class="function">FRWScopeLock <span class="title">WriteLock</span><span class="params">(ContainerLock, FRWScopeLockType::SLT_Write)</span></span>;</span><br><span class="line"></span><br><span class="line">	FOwnedItem* Item = Items.<span class="built_in">FindByPredicate</span>([&amp;](FOwnedItem InItem) &#123; <span class="keyword">return</span> InItem.ItemInfo == ItemInfo; &#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Item != <span class="literal">nullptr</span> &amp;&amp; (*Item).ItemNum &gt;= Num)</span><br><span class="line">	&#123;</span><br><span class="line">		Item-&gt;ItemNum -= Num;</span><br><span class="line">		<span class="keyword">if</span> (Item-&gt;ItemNum == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Items.<span class="built_in">Remove</span>(*Item);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">MarkItemDirty</span>(*Item);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FItemContainer::ClearItems</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 加写锁</span></span><br><span class="line">	<span class="function">FRWScopeLock <span class="title">WriteLock</span><span class="params">(ContainerLock, FRWScopeLockType::SLT_Write)</span></span>;</span><br><span class="line"></span><br><span class="line">	Items.<span class="built_in">Empty</span>();</span><br><span class="line">	<span class="built_in">MarkArrayDirty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">FItemContainer::NetDeltaSerialize</span><span class="params">(FNetDeltaSerializeInfo&amp; DeltaParms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ..... </span></span><br><span class="line">	<span class="keyword">return</span> FastArrayDeltaSerialize&lt;FOwnedItem&gt;(Items, DeltaParms, *<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>&quot;FItemContainer&quot; 容器的实现思路</strong>：</p><ol><li>如果此 Item 为静态 Item (即 Item 不会因为实例的不同而出现不同效果，如：食物，材料等)，则直接使用其 CDO 来存储其 ItemInfo</li><li>如果此 Item 非静态 Item (即 Item 会因为实例的不同为出现不同效果，如：武器，装备等)，则实例化后，使用其实例存储其 ItemInfo</li></ol><p>**&quot;FItemContainer&quot; 容器中的方法只是对其内部两个容器 (TArray 和 TMap) 的增删查改，为什么需要两个容器？** 原因如下：</p><ul><li>Unreal 中不支持 TMap 的网络同步</li><li>TArray 在数据量过大时访问效率非常低，而某些模块对访问的效率要求较高 (如：背包模块)</li><li>TArray 用于网络同步，保证数据的权威性。TMap 的数据基于 TArray，用于优化数据访问效率</li></ul><h2 id="itemcomponent-的实现"><a class="anchor" href="#itemcomponent-的实现">#</a> ItemComponent 的实现</h2><p>&quot;FItemContainer&quot; 和 &quot;UItemInfo&quot; 都已完成，接下来可以试着实现 &quot;ItemComponent&quot; 。</p><p></p><figure class="highlight c++"><figcaption><span>ItemComponent.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----------------------------------------- BlueprintCallable -----------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::K2_PickItem</span><span class="params">(AItemActor* PickUpItem, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Num &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Operation Num is %d, it is invalid&quot;</span>, Num));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CanPickItem</span>(PickUpItem, Num))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">AskServerAddItem</span>(PickUpItem-&gt;ItemInfo, Num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::K2_AddItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Num &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Operation Num is %d, it is invalid&quot;</span>, Num));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Passed ItemInfo is invalid&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_AutonomousProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AskServerAddItem</span>(ItemInfo, Num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_Authority)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 静态Item，直接用其 CDO 来添加</span></span><br><span class="line">		<span class="keyword">if</span> (ItemInfo-&gt;bStatic == <span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AddSingleItem</span>(ItemInfo, Num);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			UItemInfo* NewItem = NewObject&lt;UItemInfo&gt;(<span class="keyword">this</span>, ItemInfo-&gt;<span class="built_in">GetClass</span>());</span><br><span class="line">			<span class="keyword">if</span> (NewItem != <span class="literal">nullptr</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 实例化物品一次只能添加一件</span></span><br><span class="line">				<span class="built_in">AddSingleItem</span>(ItemInfo);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::K2_UseItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Num &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Operation Num is %d, it is invalid&quot;</span>, Num));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Passed ItemInfo is invalid&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CheakItemEnough</span>(ItemInfo, Num))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CanUseItem</span>(ItemInfo, Num))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_AutonomousProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AskServerUseItem</span>(ItemInfo, Num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_Authority)</span><br><span class="line">	&#123;</span><br><span class="line">		ItemInfo-&gt;<span class="built_in">TryUseItem</span>(<span class="built_in">GetOwner</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::K2_DisuseItem</span><span class="params">(UItemInfo* ItemInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Passed ItemInfo is invalid&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Passed ItemInfo is invalid&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_AutonomousProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AskServerDisuseItem</span>(ItemInfo);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_Authority)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// GetOwner()-&gt;DisuseItem(ItemInfo);</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> UItemComponent::<span class="built_in">K2_RemoveItem</span>(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (Num &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Operation Num is %d, it is invalid&quot;</span>, Num));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Passed ItemInfo is invalid&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CheakItemEnough</span>(ItemInfo, Num))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_AutonomousProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AskServerRemoveItem</span>(ItemInfo, Num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_Authority)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 如果 ItemInfo 为实例化物品，则 Num 应始终为 1 或 0</span></span><br><span class="line">		<span class="built_in">RemoveSingleItem</span>(ItemInfo, Num);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::K2_SellItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Num &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Operation Num is %d, it is invalid&quot;</span>, Num));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;Passed ItemInfo is invalid&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CheakItemEnough</span>(ItemInfo, Num))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_AutonomousProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AskServerSellItem</span>(ItemInfo, Num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_Authority)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">RemoveSingleItem</span>(ItemInfo, Num);</span><br><span class="line">		int32 AddCoinNum = ItemInfo-&gt;Price * Num;</span><br><span class="line">		<span class="built_in">AskServerAddCoin</span>(AddCoinNum, <span class="built_in">FString</span>(<span class="string">&quot;SellItem&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::K2_AddCoin</span><span class="params">(int32 Num, <span class="keyword">const</span> FString&amp; AddCoinReason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CanAddCoin</span>(Num, AddCoinReason))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_AutonomousProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">AskServerAddCoin</span>(Num, AddCoinReason);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">GetOwnerRole</span>() == ROLE_Authority)</span><br><span class="line">	&#123;</span><br><span class="line">		FPlatformAtomics::<span class="built_in">InterlockedAdd</span>(&amp;CoinNum, Num);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*----------------------------------------- CheakCode -----------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::CheakItemEnough</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 OwnedNum = <span class="built_in">GetSingleItemData</span>(ItemInfo);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (OwnedNum &lt; Num)</span><br><span class="line">	&#123;</span><br><span class="line">		FString FailReason;</span><br><span class="line">		FailReason = ItemInfo-&gt;Name.<span class="built_in">ToString</span>() + <span class="built_in">FString</span>(<span class="string">&quot;is Not Enough.&quot;</span>);</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(FailReason);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::CanPickItem_Implementation</span><span class="params">(AItemActor* PickUpItem, int32 Num <span class="comment">/*= 1*/</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;	<span class="comment">// 重写此函数</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if (false)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		NotifyItemOperaFails.Broadcast(FString(&quot;Fails Reason&quot;));</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::CanUseItem_Implementation</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;	<span class="comment">// 重写此函数</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if (false)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		NotifyItemOperaFails.Broadcast(FString(&quot;Fails Reason&quot;));</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::CanAddCoin_Implementation</span><span class="params">(int32 Num, <span class="keyword">const</span> FString&amp; AddCoinReason)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;	<span class="comment">// 重写此函数</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	if (false)</span></span><br><span class="line"><span class="comment">	&#123;</span></span><br><span class="line"><span class="comment">		NotifyItemOperaFails.Broadcast(FString(&quot;Fails Reason&quot;));</span></span><br><span class="line"><span class="comment">		return false;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*----------------------------------------- RPC -----------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::AskServerAddItem_Implementation</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_AddItem</span>(ItemInfo, Num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::AskServerRemoveItem_Implementation</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_RemoveItem</span>(ItemInfo, Num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::AskServerUseItem_Implementation</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_UseItem</span>(ItemInfo, Num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::AskServerDisuseItem_Implementation</span><span class="params">(UItemInfo* ItemInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_DisuseItem</span>(ItemInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::AskServerSellItem_Implementation</span><span class="params">(UItemInfo* ItemInfo, int32 Num <span class="comment">/*= 1*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_SellItem</span>(ItemInfo, Num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::AskServerAddCoin_Implementation</span><span class="params">(int32 Num, <span class="keyword">const</span> FString&amp; AddCoinReason)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">K2_AddCoin</span>(Num, AddCoinReason);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*----------------------------------------- ItemInterface Function -----------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::AddSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 AddNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(ItemInfo-&gt;Type, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TargetContainer.<span class="built_in">AddSingleItem</span>(ItemInfo, AddNum);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::RemoveSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 RemoveNum <span class="comment">/*= 0*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(ItemInfo-&gt;Type, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TargetContainer.<span class="built_in">RemoveSingleItem</span>(ItemInfo, RemoveNum);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::ClearTypeItem</span><span class="params">(EItemType InItemType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InItemType &gt; EItemType::Max)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;The Max ItemType is 10. @see EItemType&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(InItemType, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	TargetContainer.<span class="built_in">ClearItems</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::ClearAllItem</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SubItems_1.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_2.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_3.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_4.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_5.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_6.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_7.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_8.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_9.<span class="built_in">ClearItems</span>();</span><br><span class="line">	SubItems_10.<span class="built_in">ClearItems</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::SetSingleItem</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(ItemInfo-&gt;Type, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TargetContainer.<span class="built_in">SetSingleItem</span>(ItemInfo, Num);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">UItemComponent::GetSingleItemData</span><span class="params">(UItemInfo* ItemInfo)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(ItemInfo-&gt;Type, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TargetContainer.<span class="built_in">GetSingleItem</span>(ItemInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::GetTypeItemData</span><span class="params">(EItemType InItemType, TMap&lt;UItemInfo*, int32&gt;&amp; OutItemCounter)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (InItemType &gt; EItemType::Max)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;The Max ItemType is 10. @see EItemType&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(InItemType, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OutItemCounter = TargetContainer.<span class="built_in">GetAllItems</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::GetAllItemData</span><span class="params">(TMap&lt;UItemInfo*, int32&gt;&amp; OutItemCounter)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	OutItemCounter.<span class="built_in">Reset</span>();</span><br><span class="line">	<span class="keyword">if</span> (SubItems_1.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_1.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_2.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_2.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_3.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_3.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_4.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_4.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_5.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_5.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_6.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_6.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_7.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_7.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_8.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_8.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_9.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_9.SubItemsCounter);</span><br><span class="line">	<span class="keyword">if</span> (SubItems_10.SubItemsCounter.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)	OutItemCounter.<span class="built_in">Append</span>(SubItems_10.SubItemsCounter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*------------------------------------ Container , Counter 相关 ------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::SetItemContainer</span><span class="params">(EItemType ItemType, TMap&lt;UItemInfo*, int32&gt;&amp;&amp; InItemContainer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(ItemType, TargetContainer))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TargetContainer = Forward&lt;TMap&lt;UItemInfo*, int32&gt;&gt;(InItemContainer);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::CheakItemNameValid</span><span class="params">(FName ItemName, EItemType&amp; OutItemType, UItemInfo*&amp; ItemInfo)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ItemInfo = UItemInfo::<span class="built_in">GetInfoByName</span>(ItemName);</span><br><span class="line">	<span class="keyword">if</span> (!ItemInfo)</span><br><span class="line">	&#123;</span><br><span class="line">		FString FailReason;</span><br><span class="line">		FailReason = ItemName.<span class="built_in">ToString</span>() + <span class="built_in">FString</span>(<span class="string">&quot;is invalid.&quot;</span>);</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(FailReason);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	EItemType ItemType = ItemInfo-&gt;Type;</span><br><span class="line">	<span class="keyword">if</span> (ItemType &gt;= EItemType::Max)</span><br><span class="line">	&#123;</span><br><span class="line">		NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;The Max ItemType is 10. @see EItemType&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	OutItemType = ItemType;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UItemComponent::GetContainerFromType</span><span class="params">(EItemType InType, FItemContainer&amp; OutContainter)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	int32 Index = <span class="keyword">static_cast</span>&lt;int32&gt;(InType);</span><br><span class="line">	<span class="built_in"><span class="keyword">switch</span></span> (Index)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>: </span><br><span class="line">		OutContainter = SubItems_1;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		OutContainter = SubItems_2;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		OutContainter = SubItems_3;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">		OutContainter = SubItems_4;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">		OutContainter = SubItems_5;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">		OutContainter = SubItems_6;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">		OutContainter = SubItems_7;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">		OutContainter = SubItems_8;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">		OutContainter = SubItems_9;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">		OutContainter = SubItems_10;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	NotifyItemOperaFails.<span class="built_in">Broadcast</span>(<span class="built_in">FString</span>(<span class="string">&quot;The Max ItemType is 10. @see EItemType&quot;</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::UpdateSingleItem_Implementation</span><span class="params">(UItemInfo* ItemInfo, int32 Num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FItemContainer TargetContainer;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">GetContainerFromType</span>(ItemInfo-&gt;Type, TargetContainer)) </span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TargetContainer.<span class="built_in">UpdateSingleItem</span>(ItemInfo, Num);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::UpdateAllItem_Implementation</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SubItems_1.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_2.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_3.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_4.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_5.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_6.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_7.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_8.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_9.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">	SubItems_10.<span class="built_in">UpdateAllItems</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*----------------------------------------- NetWork -----------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UItemComponent::GetLifetimeReplicatedProps</span><span class="params">(TArray&lt; FLifetimeProperty &gt;&amp; OutLifetimeProps)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 数据只复制给所属 Owner</span></span><br><span class="line">	FDoRepLifetimeParams Params;</span><br><span class="line">	Params.Condition = COND_OwnerOnly;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_1, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_2, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_3, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_4, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_5, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_6, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_7, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_8, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_9, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, SubItems_10, Params);</span><br><span class="line">	<span class="built_in">DOREPLIFETIME_WITH_PARAMS_FAST</span>(UItemComponent, CoinNum, Params);</span><br><span class="line"></span><br><span class="line">	Super::<span class="built_in">GetLifetimeReplicatedProps</span>(OutLifetimeProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>代码实现比较粗糙，只实现了基本的逻辑，省去了较多的条件判断，Debug 与优化代码。主要实现思路如下：</p><ol><li>明确需要进行网络复制的属性，并限定其复制状态</li><li>实现对容器的增删查改函数的封装</li><li>实现提供给蓝图使用的 &quot;K2_&quot; 函数接口<ol><li>分别实现客户端调用和服务器调用版本</li><li>客户端在确认函数调用无误后，需要请求服务器调用此函数 (可执行相关客户端显示效果)</li><li>服务器负责对网络权威数据的修改，并以属性复制的方式修改客户端数据 (可修改客户端预先执行的显示效果，或通知客户端执行数据修改成功的显示效果等)</li></ol></li></ol><p>代码整体实现较为简单。值得注意的是，静态物品和非静态物品在容器中存储的形式是不一样的 (静态物品堆叠存放，而非静态物品分别存放)，导致一些方法的处理上有所区别。</p><h2 id="subiteminfo"><a class="anchor" href="#subiteminfo">#</a> SubItemInfo</h2><p>&quot;SubItemInfo&quot; 为 &quot;ItemInfo&quot; 的子类，可以是 &quot;WeaponInfo&quot;，&quot;FoodInfo&quot;，&quot;MaterialInfo&quot; 等。&quot;WeaponInfo&quot; 显然是非静态的 ItemInfo 子类，而后两者皆是静态 ItemInfo 子类。以下只对 &quot;WeaponInfo&quot; 进行举例，代码如下：</p><p></p><figure class="highlight c++"><figcaption><span>WeaponInfo.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UENUM</span>()</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">EWeaponType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="function">Sword					<span class="title">UMETA</span><span class="params">(DisplayName = <span class="string">&quot;Sword&quot;</span>)</span>,</span></span><br><span class="line"><span class="function">	Polearms				<span class="title">UMETA</span><span class="params">(DisplayName = <span class="string">&quot;Polearms&quot;</span>)</span>,</span></span><br><span class="line"><span class="function">	MagicInstrument			<span class="title">UMETA</span><span class="params">(DisplayName = <span class="string">&quot;Magic Instrument&quot;</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">	<span class="comment">// .......</span></span></span><br><span class="line"><span class="function">&#125;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UItemInfo 的子类之一，用于记录武器的相关信息，但不表示武器在游戏世界中的实体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">UCLASS</span>(Blueprintable)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ITEM_API</span> <span class="title">UWeaponInfo</span> :</span> <span class="keyword">public</span> UItemInfo</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">GENERATED_BODY</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 武器的基础属性，如: 基础攻击力，暴击率等</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadOnly, Category = WeaponInfo)</span><br><span class="line">	TArray&lt;FGameplayModifierInfo&gt; Modifiers;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 武器等级，不同等级影响 Modifiers 对角色属性的加成</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditInstanceOnly, BlueprintReadWrite, Category = WeaponInfo)</span><br><span class="line">	int32 Level;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 武器类型</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditDefaultsOnly, BlueprintReadOnly, Category = WeaponInfo)</span><br><span class="line">	EWeaponType Category;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当前是否已装备该武器</span></span><br><span class="line">	<span class="built_in">UPROPERTY</span>(EditInstanceOnly, BlueprintReadWrite, Category = WeaponInfo)</span><br><span class="line">	<span class="keyword">bool</span> bUsing;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 提供给蓝图编辑武器特殊效果的机会</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>(BlueprintImplementableEvent, DisplayName = <span class="string">&quot;ApplyWeaponEffect&quot;</span>, Category = WeaponInfo)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">K2_ApplyExtraEffect</span><span class="params">(AActor* WeaponOwner)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 本地编辑武器特殊效果的函数。如果在子类中重写，记得调用 &quot;K2_ApplyExtraEffect&quot; 函数，以支持蓝图编程</span></span><br><span class="line"><span class="comment">	 * 此函数往往被注册到某些 Controller 的事件中 (如: 玩家开始战斗的 &quot;StartFight&quot; 事件，玩家状态改变事件 &quot;AttributeModify&quot; 等)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">UFUNCTION</span>()</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">ApplyExtraEffect</span><span class="params">(AActor* WeaponOwner)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 如有需要，可以添加应用武器效果的预处理和后处理函数</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * UFUNCTION()</span></span><br><span class="line"><span class="comment">	 * void OnPreApplyExtraEffect(AController* WeaponOwner);</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * UFUNCTION()</span></span><br><span class="line"><span class="comment">	 * void OnPostApplyExtraEffect(AController* WeaponOwner);</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** UObject Interface Begin~~~ */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PostInitProperties</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="comment">/** UObject Interface End~~~ */</span></span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight c++"><figcaption><span>WeaponInfo.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UWeaponInfo::ApplyExtraEffect</span><span class="params">(AActor* WeaponOwner)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Code .....</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">K2_ApplyExtraEffect</span>(WeaponOwner);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Code .....</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UWeaponInfo::PostInitProperties</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Super::<span class="built_in">PostInitProperties</span>();</span><br><span class="line">	bStatic = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&quot;WeaponInfo&quot; 类包含游戏中武器的所有信息。如以下武器效果及其实现思路 (武器来自原神)：</p><p><img data-src="WeaponEx.jpg" alt="WeaponEx"></p><p>武器实现思路：</p><ol><li>名称，武器类型，稀有度等直接在蓝图设置</li><li>初始属性对应我们的 &quot;Modifiers&quot; 数组。&quot;FGameplayModifierInfo&quot; 是 GAS 系统中的编辑人物属性的结构体，其中包括初始值以及根据等级获得的加成倍数，还可以自定义加成方法。&quot;Modifiers&quot; 数组会在我们装备武器时被应用到角色身上。</li><li>装备效果对应我们的 &quot;K2_ApplyExtraEffect&quot; 函数。此函数将添加到相关对象的代理中，如上文武器效果将添加到自身的属性值改变的代理中。每次属性值改变时都会触发此函数，函数体内判断生命值是否符合要求，符合则应用特定效果。</li></ol><p>&quot;SubItemInfo&quot; 的实现其实都类似，可以自由扩展以实现不同 Item 类型的不同应用场景与效果。</p><h2 id="总结与结语"><a class="anchor" href="#总结与结语">#</a> 总结与结语</h2><p>本篇我们首先明确了 &quot;ItemInfo&quot; 所需的数据和函数，其次明确了访问玩家所拥有 &quot;ItemInfo&quot; 的抽象接口 &quot;ItemInterface&quot;，再来实现了支持网络复制的装载玩家所拥有的 &quot;ItemInfo&quot; 的相关数据的容器 &quot;ItemContainer&quot;，最后将对 Item 的所有操作集成到 &quot;ItemComponent&quot; 中，用于与别的模块的交互。最后的最后，我们还介绍了 &quot;ItemInfo&quot; 的 子类 &quot;SubItemInfo&quot; 的实现思路。</p><p>到此，咱的游戏物品模组的雏形就算是基本实现完成了。当然还有很多其他实现方法和优化思路也值得我们进一步探讨，希望本篇对你有所帮助～～～</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-01-13 09:58:44" itemprop="dateModified" datetime="2022-01-13T09:58:44+08:00">2022-01-13</time> </span><span id="2021/12/28/UE4/UE4CPP/CustomItemModule/" class="item leancloud_visitors" data-flag-title="Custom Item Module" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>-YIFEI- <i class="ic i-at"><em>@</em></i>一个年轻人奔向梦想的足迹</li><li class="link"><strong>本文链接：</strong> <a href="https://kotori_suki.github.io/2021/12/28/UE4/UE4CPP/CustomItemModule/" title="Custom Item Module">https://kotori_suki.github.io/2021/12/28/UE4/UE4CPP/CustomItemModule/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/12/17/UE4/UE4CPP/Unreal%20GAS%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeuibk9fj20zk0m8ay2.jpg" title="Unreal GAS 源码解析"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> UE4_C++</span><h3>Unreal GAS 源码解析</h3></a></div><div class="item right"><a href="/2021/12/30/UE4/UE4CPP/Unreal%20%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevo9j1jj20zk0m8e81.jpg" title="Unreal 异步与并行编程"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> UE4_C++</span><h3>Unreal 异步与并行编程</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#custom-item-module"><span class="toc-number">1.</span> <span class="toc-text">Custom Item Module</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E8%A7%88"><span class="toc-number">1.1.</span> <span class="toc-text">总览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#iteminfo"><span class="toc-number">1.2.1.</span> <span class="toc-text">ItemInfo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iteminterface"><span class="toc-number">1.3.</span> <span class="toc-text">ItemInterface</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#itemcomponent-%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.</span> <span class="toc-text">ItemComponent 的定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fowneditem"><span class="toc-number">1.5.</span> <span class="toc-text">FOwnedItem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fitemcontainer"><span class="toc-number">1.6.</span> <span class="toc-text">FItemContainer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#itemcomponent-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.7.</span> <span class="toc-text">ItemComponent 的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#subiteminfo"><span class="toc-number">1.8.</span> <span class="toc-text">SubItemInfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E7%BB%93%E8%AF%AD"><span class="toc-number">1.9.</span> <span class="toc-text">总结与结语</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2021/12/28/UE4/UE4CPP/CustomItemModule/" rel="bookmark" title="Custom Item Module">Custom Item Module</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="-YIFEI-" data-src="/images/avatar.jpg"><p class="name" itemprop="name">-YIFEI-</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">57</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">15</span> <span class="name">分类</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0tvdG9yaS1TdWtp" title="https:&#x2F;&#x2F;github.com&#x2F;Kotori-Suki"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS90dnQtNjA=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;tvt-60"><i class="ic i-zhihu"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li></ul></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/12/17/UE4/UE4CPP/Unreal%20GAS%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/12/30/UE4/UE4CPP/Unreal%20%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="分类于 C++基础">C++基础</a></div><span><a href="/2021/08/25/CPPBase/%E7%AE%80%E5%8D%95%E8%BF%AD%E4%BB%A3%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="简单迭代器的实现">简单迭代器的实现</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="分类于 UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="分类于 UE4_C++">UE4_C++</a></div><span><a href="/2021/12/30/UE4/UE4CPP/Unreal%20%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B/" title="Unreal 异步与并行编程">Unreal 异步与并行编程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="分类于 UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="分类于 UE4_C++">UE4_C++</a></div><span><a href="/2021/10/25/UE4/UE4CPP/API%E4%B8%8D%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C-%E4%B9%8B-GetPlayerController/" title="API不正常工作 之 GetPlayerController">API不正常工作 之 GetPlayerController</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="分类于 UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="分类于 UE4_C++">UE4_C++</a></div><span><a href="/2022/02/12/UE4/UE4CPP/Unreal%20%E5%8A%A8%E7%94%BB%E7%9B%B8%E5%85%B3/" title="Unreal MotionMatching">Unreal MotionMatching</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="分类于 C++基础">C++基础</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="分类于 设计模式">设计模式</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="分类于 创建型模式">创建型模式</a></div><span><a href="/2021/08/17/CPPBase/DesignPattern/Factory/" title="工厂模式">工厂模式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="分类于 C++基础">C++基础</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="分类于 设计模式">设计模式</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="分类于 行为型模式">行为型模式</a></div><span><a href="/2021/08/19/CPPBase/DesignPattern/Observe/" title="观察者模式">观察者模式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="分类于 C++基础">C++基础</a></div><span><a href="/2021/08/20/CPPBase/C++11%E6%96%B0%E7%89%B9%E6%80%A7/" title="C++11新特性 使用篇1">C++11新特性 使用篇1</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="分类于 C++基础">C++基础</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="分类于 设计模式">设计模式</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="分类于 结构型模式">结构型模式</a></div><span><a href="/2021/08/18/CPPBase/DesignPattern/Adapter/" title="适配器模式">适配器模式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="分类于 UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="分类于 UE4_C++">UE4_C++</a></div><span><a href="/2021/11/26/UE4/UE4CPP/Unreal%20Slate/" title="Unreal Slate">Unreal Slate</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="分类于 C++基础">C++基础</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="分类于 设计模式">设计模式</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="分类于 创建型模式">创建型模式</a></div><span><a href="/2021/08/21/CPPBase/DesignPattern/Decorater/" title="装饰器模式">装饰器模式</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">-YIFEI- @ Afei's Blog</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/12/28/UE4/UE4CPP/CustomItemModule/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>