<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="ä¸€ä¸ªå¹´è½»äººå¥”å‘æ¢¦æƒ³çš„è¶³è¿¹" href="https://kotori_suki.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="ä¸€ä¸ªå¹´è½»äººå¥”å‘æ¢¦æƒ³çš„è¶³è¿¹" href="https://kotori_suki.github.io/atom.xml"><link rel="alternate" type="application/json" title="ä¸€ä¸ªå¹´è½»äººå¥”å‘æ¢¦æƒ³çš„è¶³è¿¹" href="https://kotori_suki.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://kotori_suki.github.io/2021/11/06/UE4/UE4CPP/Unreal%20GC%E8%BF%87%E7%A8%8B/"><title>Unreal GCè¿‡ç¨‹ - UE4_C++ - UE4 | Afei's Blog = ä¸€ä¸ªå¹´è½»äººå¥”å‘æ¢¦æƒ³çš„è¶³è¿¹ = Welcome to my blog !</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Unreal GCè¿‡ç¨‹</h1><div class="meta"><span class="item" title="åˆ›å»ºæ—¶é—´ï¼š2021-11-06 19:34:16"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">å‘è¡¨äº</span> <time itemprop="dateCreated datePublished" datetime="2021-11-06T19:34:16+08:00">2021-11-06</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Afei's Blog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipex2cdtbj20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciuv0socj20zk0m8qes.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipevuctzzj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicli9lfebj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giph4baakhj20zk0m8h5q.jpg"></li><li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">é¦–é¡µ</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/UE4/" itemprop="item" rel="index" title="åˆ†ç±»äº UE4"><span itemprop="name">UE4</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/UE4/UE4CPP/" itemprop="item" rel="index" title="åˆ†ç±»äº UE4_C++"><span itemprop="name">UE4_C++</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://kotori_suki.github.io/2021/11/06/UE4/UE4CPP/Unreal%20GC%E8%BF%87%E7%A8%8B/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="-YIFEI-"><meta itemprop="description" content="Welcome to my blog !, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="ä¸€ä¸ªå¹´è½»äººå¥”å‘æ¢¦æƒ³çš„è¶³è¿¹"></span><div class="body md" itemprop="articleBody"><h1 id="unreal-gcè¿‡ç¨‹"><a class="anchor" href="#unreal-gcè¿‡ç¨‹">#</a> Unreal GC è¿‡ç¨‹</h1><p>ç®€ä»‹ï¼š<strong>Unreal çš„ GC æ˜¯åŸºäº UObject çš„</strong>ï¼Œ<strong>é UObject å¯¹è±¡è¦ç»§æ‰¿ FGCObject ç±»ä¸”é‡è½½äº† AddReferencedObjects å‡½æ•°</strong>ï¼Œæ‰ä¼šè¢«åˆ—å…¥ GC å¯¹è±¡æ•°ç»„ä¸­ã€‚</p><p>ä»¥ä¸‹æ˜¯ CollectGarbage API çš„æºç ï¼š</p><p><img data-src="CollectGarbage.png" alt="CollectGarbage"></p><ul><li><p>ä¸éš¾å‘ç°ï¼Œé‡Œé¢å°±æ˜¯ä¸Šäº†ä¸ª GC é”ï¼Œç„¶åè°ƒç”¨å†…éƒ¨çš„ CollectGarbage å‡½æ•°ï¼Œæœ€åè§£é”</p></li><li><p>GC æ—¶ä¸èƒ½å¯¹ UObject è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¯èƒ½ä¼šæ”¹å˜ UObject çš„å¼•ç”¨å…³ç³»ï¼Œå¯¼è‡´ GC å‡ºç°å¼‚å¸¸ï¼ˆå¢é‡å¼ GC</p></li><li><p>CollectGarbageInternal çš„ä»£ç è¿‡é•¿ï¼Œå’±åªè§£æ GC çš„ä¸»è¦æµç¨‹ä»£ç ï¼Œçœç•¥äº†éƒ¨åˆ†æ€§èƒ½åˆ†æåŠ debug ä»£ç ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ ğŸ˜ƒ</p><p></p><figure class="highlight c++"><figcaption><span>CollectGarbageInternal</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CollectGarbageInternal</span><span class="params">(EObjectFlags KeepFlags, <span class="keyword">bool</span> bPerformFullPurge)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (GIsInitialLoad)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogGarbage, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Skipping CollectGarbage() call during initial load. It&#x27;s not safe.&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span>;		<span class="comment">// åˆå§‹åŒ–åŠ è½½ç¨‹åºæ—¶GCæ˜¯å±é™©çš„</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    FGCCSyncObject::<span class="built_in">Get</span>().<span class="built_in">ResetGCIsWaiting</span>();	<span class="comment">// é‡ç½®GCçŠ¶æ€ï¼Œå¼€å§‹GC</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">check</span>(!<span class="built_in">IsLoading</span>());	<span class="comment">// åŠ è½½æ—¶GCæŠ¥å¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line">	GNumAttemptsSinceLastGC = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (GFlushStreamingOnGC)	<span class="comment">// éœ€è¦åˆ·æ–°æµæ—¶æ‰§è¡Œ</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IsAsyncLoading</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGarbage, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;CollectGarbageInternal() is flushing async loading&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		FGCCSyncObject::<span class="built_in">Get</span>().<span class="built_in">GCUnlock</span>();	<span class="comment">// è§£GCé”</span></span><br><span class="line">		<span class="built_in">FlushAsyncLoading</span>();		<span class="comment">// é˜»å¡ï¼Œç­‰å¾…å¼‚æ­¥åŠ è½½</span></span><br><span class="line">		FGCCSyncObject::<span class="built_in">Get</span>().<span class="built_in">GCLock</span>();		<span class="comment">// ä¸ŠGCé”</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FCoreUObjectDelegates::<span class="built_in">GetPreGarbageCollectDelegate</span>().<span class="built_in">Broadcast</span>();</span><br><span class="line">	GLastGCFrame = GFrameCounter;</span><br><span class="line">    </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Set &#x27;I&#x27;m garbage collecting&#x27; flag - might be checked inside various functions.</span></span><br><span class="line">		<span class="comment">// This has to be unlocked before we call post GC callbacks</span></span><br><span class="line">        FGCScopeLock GCLock;	<span class="comment">// ä¸Šé¢æ³¨é‡Šå†™å¾—å¾ˆæ¸…æ¥šï¼Œæ˜¯ç”¨äºå‡½æ•°åšæ£€æµ‹çš„</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">UE_LOG</span>(LogGarbage, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Collecting garbage%s&quot;</span>), <span class="built_in">IsAsyncLoading</span>() ? <span class="built_in">TEXT</span>(<span class="string">&quot; while async loading&quot;</span>) : <span class="built_in">TEXT</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¦‚æœä¸Šæ¬¡çš„å¢é‡æ¸…é™¤å°šæœªå®Œæˆï¼Œåˆ™ç»§ç»­ä¸Šæ¬¡çš„å¢é‡æ¸…é™¤ã€‚</span></span><br><span class="line">		<span class="keyword">if</span> (GObjIncrementalPurgeIsInProgress || GObjPurgeIsRequired)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">IncrementalPurgeGarbage</span>(<span class="literal">false</span>);		<span class="comment">// æ‰§è¡Œå¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡ï¼Œé‡è¦ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">			FMemory::<span class="built_in">Trim</span>();		<span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line">		&#125;</span><br><span class="line">        <span class="built_in">check</span>(!GObjIncrementalPurgeIsInProgress);</span><br><span class="line">		<span class="built_in">check</span>(!GObjPurgeIsRequired);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!GCreateGCClusters &amp;&amp; GUObjectClusters.<span class="built_in">GetNumAllocatedClusters</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            GUObjectClusters.<span class="built_in">DissolveClusters</span>(<span class="literal">true</span>);	<span class="comment">// GUObjectClustersæ˜¯å…¨å±€çš„å­˜å‚¨ç°‡çš„å®¹å™¨ï¼Œå‚æ•°ä¸ºtrueå°†ç›´æ¥æ¸…é™¤æ‰€æœ‰ç°‡</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">			FRealtimeGC TagUsedRealtimeGC;</span><br><span class="line">			TagUsedRealtimeGC.<span class="built_in">PerformReachabilityAnalysis</span>(KeepFlags, bForceSingleThreadedGC, bWithClusters);		<span class="comment">// å¯è¾¾æ€§åˆ†æï¼Œé‡è¦ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (GUObjectClusters.<span class="built_in">ClustersNeedDissolving</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			GUObjectClusters.<span class="built_in">DissolveClusters</span>();	<span class="comment">// GUObjectClustersæ˜¯å…¨å±€çš„å­˜å‚¨ç°‡çš„å®¹å™¨ï¼Œè°ƒç”¨è¯¥å‡½æ•°æ¸…é™¤æ‰€æœ‰è¢«æ ‡è®°ä¸ºdissolvingçš„ç°‡ (å¼•ç”¨äº†PendingKillç°‡çš„ç°‡ä¼šè¢«æ ‡è®°ä¸ºdissolvingç°‡)</span></span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        FCoreUObjectDelegates::PostReachabilityAnalysis.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">		&#123;			</span><br><span class="line">			FGCArrayPool::<span class="built_in">Get</span>().<span class="built_in">ClearWeakReferences</span>(bPerformFullPurge);		<span class="comment">//æ¸…é™¤GCç”¨çš„æ‰€æœ‰å¼±å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">			<span class="built_in">GatherUnreachableObjects</span>(bForceSingleThreadedGC);	<span class="comment">// è·å–æ‰€æœ‰ä¸å¯è¾¾å¯¹è±¡ï¼Œè¯¦è§ä¸‹æ–‡</span></span><br><span class="line">			<span class="built_in">NotifyUnreachableObjects</span>(GUnreachableObjects);		<span class="comment">// å¼‚æ­¥è°ƒç”¨ä¸å¯è¾¾å¯¹è±¡çš„ææ„å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (bPerformFullPurge || !GIncrementalBeginDestroyEnabled)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UnhashUnreachableObjects</span>(<span class="comment">/**bUseTimeLimit = */</span> <span class="literal">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        GObjPurgeIsRequired = <span class="literal">true</span>;		<span class="comment">// è¯¥å€¼æŒ‡ç¤ºæˆ‘ä»¬æ˜¯å¦éœ€è¦è¿›è¡Œå¯¹è±¡æ¸…é™¤</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bPerformFullPurge || GIsEditor)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">IncrementalPurgeGarbage</span>(<span class="literal">false</span>);		<span class="comment">// å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bPerformFullPurge)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ShrinkUObjectHashTables</span>();	<span class="comment">// æ”¶ç¼©ObjectHashTablesï¼Œå› ä¸ºæ¸…é™¤æ‰çš„å¯¹è±¡ä¼šåœ¨ObjectHashTablesä¸­æ³¨é”€æ‰</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">DeleteLoaders</span>();	<span class="comment">// é”€æ¯æ‰€æœ‰æŒ‚èµ·çš„åˆ é™¤è¿æ¥å™¨</span></span><br><span class="line"></span><br><span class="line">		FMemory::<span class="built_in">Trim</span>();	<span class="comment">//é‡Šæ”¾å†…å­˜</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¿€æ´»GCå®Œçš„åå¤„ç†å¤šæ’­</span></span><br><span class="line">	FCoreUObjectDelegates::<span class="built_in">GetPostGarbageCollect</span>().<span class="built_in">Broadcast</span>();</span><br><span class="line">		</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p></li><li><p>å› ä¸º Unreal çš„ GC æ˜¯å¢é‡å¼çš„ï¼Œå¤§è‡´çš„è¿‡ç¨‹å°±æ˜¯ç»™ Object ä¸Šæ ‡è®°ï¼Œç„¶åæ¸…é™¤æ‰å¸¦æœ‰ä¸å¯è¾¾æ ‡è®°çš„å¯¹è±¡ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å¿…è¦æ“ä½œï¼Œæ¯”å¦‚ä¸Š GC é”ï¼Œé˜»æ­¢å…¶ä»–çº¿ç¨‹å¯¹ Object çš„æ“ä½œï¼Œåœ¨ ObjectHashTable ä¸­æ³¨é”€ GarbageObject ç­‰ï¼Œéƒ½æ˜¯ä¿è¯ GC èƒ½æ­£å¸¸è¿è¡Œï¼Œä¼˜åŒ– GC è¿‡ç¨‹çš„æ­¥éª¤ã€‚</p><hr><p>ä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹çœ‹ Unreal æ˜¯æ€ä¹ˆè¿›è¡Œ <strong>&quot;å¯è¾¾æ€§åˆ†æ&quot;</strong> å’Œ <strong>&quot;å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡&quot;</strong> çš„å§ï¼ˆè¿™å°†æ˜¯ä¸€åœºé•¿é€”æ—…è¡Œï¼Œåšå¥½å¿ƒç†å‡†å¤‡</p><h3 id="å¯è¾¾æ€§åˆ†æ"><a class="anchor" href="#å¯è¾¾æ€§åˆ†æ">#</a> å¯è¾¾æ€§åˆ†æ</h3><p></p><figure class="highlight c++"><figcaption><span>PerformReachabilityAnalysis</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PerformReachabilityAnalysis</span><span class="params">(EObjectFlags KeepFlags, <span class="keyword">bool</span> bForceSingleThreaded, <span class="keyword">bool</span> bWithClusters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ä» &quot;GCArrayPool&quot; ä¸­è·å–ä¸€ä¸ªç©ºçš„ &quot;ArrayStruct&quot;ï¼Œè¯¥ç»“æ„ä½“é‡Œé¢å­˜äº†ä¸¤ä¸ªæ•°ç»„ï¼Œå…¶ä¸­ä¸€ä¸ªæ•°ç»„ä¿å­˜äº†æ‰€æœ‰éœ€è¦è¿›è¡Œå¯è¾¾æ€§åˆ†æçš„å¯¹è±¡æŒ‡é’ˆï¼Œè¿˜æœ‰ä¸€ä¸ªåˆ™æ˜¯å…¶å¼±å¼•ç”¨ã€‚</span></span><br><span class="line">	FGCArrayStruct* ArrayStruct = FGCArrayPool::<span class="built_in">Get</span>().<span class="built_in">GetArrayStructFromPool</span>();</span><br><span class="line">    TArray&lt;UObject*&gt;&amp; ObjectsToSerialize = ArrayStruct-&gt;ObjectsToSerialize;</span><br><span class="line"></span><br><span class="line">    GObjectCountDuringLastMarkPhase.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾€ObjectsToSerializeæ•°ç»„ä¸­æ·»åŠ æ‰€æœ‰UObjectå’ŒéUObjectä½†ç»§æ‰¿äº†FGCObjectçš„å¯¹è±¡åˆ°ObjectsToSerializeä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (FPlatformProperties::<span class="built_in">RequiresCookedData</span>() &amp;&amp; FGCObject::GGCObjectReferencer &amp;&amp; GUObjectArray.<span class="built_in">IsDisregardForGC</span>(FGCObject::GGCObjectReferencer))</span><br><span class="line">    &#123;</span><br><span class="line">        ObjectsToSerialize.<span class="built_in">Add</span>(FGCObject::GGCObjectReferencer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	</span><br><span class="line">    &#123;</span><br><span class="line">        (<span class="keyword">this</span>-&gt;*MarkObjectsFunctions[<span class="built_in">GetGCFunctionIndex</span>(!bForceSingleThreaded, bWithClusters)])(ObjectsToSerialize, KeepFlags);		<span class="comment">// MarkObjectsFunctionsæ˜¯ä¸€ä¸ªå­˜ç€ç”¨æ¥æ ‡è®°Objectsä¸å¯è¾¾çš„å‡½æ•°çš„æ•°ç»„ï¼Œç”¨é‡Œé¢çš„å“ªæ¡å‡½æ•°ä¼šæ ¹æ®æ˜¯å¦å•çº¿ç¨‹GCå’Œæ˜¯å¦ä½¿ç”¨ç°‡æ¥å†³å®šï¼Œå‡½æ•°åˆ†æè¯¦è§ä¸‹æ–‡ã€‚æ€»ä¹‹ç°åœ¨åªéœ€è¦çŸ¥é“ï¼Œè¿™æ˜¯ç”¨æ¥ç»™Objectsä¸Šä¸å¯è¾¾æ ‡è®°çš„ï¼Œå¹¶å°†ä¸å¯è¾¾çš„Objectsç§»å‡º &quot;ObjectsToSerialize&quot; æ•°ç»„ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">PerformReachabilityAnalysisOnObjects</span>(ArrayStruct, bForceSingleThreaded, bWithClusters);		<span class="comment">// å¯¹Objectsè¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œå¹¶å°†å¯è¾¾çš„ä½†æœªæ ‡è®°ä¸ºå¯è¾¾çš„å¯¹è±¡åŠ å…¥åˆ° &quot;ArrayStruct&quot; ä¸­ï¼Œå‡½æ•°åˆ†æè¯¦è§ä¸‹æ–‡</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…è®¸å¤–éƒ¨ç³»ç»Ÿæ·»åŠ é¢å¤–çš„å¯¹è±¡æ ¹</span></span><br><span class="line">    FCoreUObjectDelegates::TraceExternalRootsForReachabilityAnalysis.<span class="built_in">Broadcast</span>(*<span class="keyword">this</span>, KeepFlags, bForceSingleThreaded);</span><br><span class="line"></span><br><span class="line">    FGCArrayPool::<span class="built_in">Get</span>().<span class="built_in">ReturnToPool</span>(ArrayStruct);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PerformReachabilityAnalysisOnObjects</span><span class="params">(FGCArrayStruct* ArrayStruct, <span class="keyword">bool</span> bForceSingleThreaded, <span class="keyword">bool</span> bWithClusters)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   	<span class="comment">// è·Ÿ Markä¸å¯è¾¾æ ‡è®° ä¸€æ ·ï¼Œè¿™ä¹Ÿæ˜¯åœ¨å‡½æ•°æ•°ç»„ä¸­å–ä¸€ä¸ªæ¥è°ƒç”¨çš„æ“ä½œï¼Œå‡½æ•°è§£æè¯¦è§ä¸‹æ–‡</span></span><br><span class="line">    (<span class="keyword">this</span>-&gt;*ReachabilityAnalysisFunctions[<span class="built_in">GetGCFunctionIndex</span>(!bForceSingleThreaded, bWithClusters)])(ArrayStruct);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶å®ä¸Šé¢å·²ç»æ˜¯å¯è¾¾æ€§åˆ†æçš„å…¨éƒ¨è¿‡ç¨‹äº†ï¼Œä½†å…¶å†…éƒ¨æ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯äº‘é‡Œé›¾é‡Œï¼Œé‚£å€’ä¸å¦‚æ·±å…¥çœ‹çœ‹ï¼Œå…¶å†…éƒ¨ API éƒ½æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚ä»¥ä¸‹å’±ä¼šå¯¹ &quot;MarkObjectsFunctions&quot; å’Œ &quot;ReachabilityAnalysisFunctions&quot; å‡½æ•°è¿›è¡Œè§£æï¼ˆæ˜¯ä¸ªå¤§å‘... ä¸æƒ³äº†è§£çš„è¯»è€…å¯ä»¥ç›´æ¥è·³åˆ° <a href="#%E5%A2%9E%E9%87%8F%E6%B8%85%E9%99%A4%E4%B8%8D%E5%8F%AF%E8%BE%BE%E5%AF%B9%E8%B1%A1">&quot;å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡&quot;</a></p><h5 id="markobjectsfunctions"><a class="anchor" href="#markobjectsfunctions">#</a> &quot;MarkObjectsFunctions&quot;</h5><p></p><figure class="highlight c++"><figcaption><span>MarkObjectsFunctions</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &quot;MarkObjectsFunctions&quot; æ•°ç»„ä¸­çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åˆ¤æ–­ä¸å¯è¾¾çš„å‡†åˆ™æ˜¯ï¼Œè¯¥å¯¹è±¡Itemä¸­æ˜¯å¦æœ‰ &quot;KeepFlags&quot; æˆ– &quot;GarbageCollectionKeepFlags&quot; æ ‡å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> bParallel, <span class="keyword">bool</span> bWithClusters&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MarkObjectsAsUnreachable</span><span class="params">(TArray&lt;UObject*&gt;&amp; ObjectsToSerialize, <span class="keyword">const</span> EObjectFlags KeepFlags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ ‡å¿—ï¼Œè·å–éœ€è¦å¤„ç†çš„Objectsçš„æ•°é‡ï¼Œè·å–å¯å·¥ä½œçš„çº¿ç¨‹æ•°ï¼Œè®¡ç®—æ¯ä¸ªçº¿ç¨‹å¹³å‡è´Ÿè´£å¤šå°‘ä¸ªObjectçš„å¤„ç†</span></span><br><span class="line">    <span class="comment">// è¿™ä¸€æ­¥æ˜¯ä¸ºäº†åé¢çš„ &quot;ParallelFor&quot; å‡½æ•° å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†Objectsæä¾›å‚æ•°çš„</span></span><br><span class="line">    <span class="keyword">const</span> EInternalObjectFlags FastKeepFlags = EInternalObjectFlags::GarbageCollectionKeepFlags;</span><br><span class="line">    <span class="keyword">const</span> int32 MaxNumberOfObjects = GUObjectArray.<span class="built_in">GetObjectArrayNum</span>() - GUObjectArray.<span class="built_in">GetFirstGCIndex</span>();</span><br><span class="line">    <span class="keyword">const</span> int32 NumThreads = FMath::<span class="built_in">Max</span>(<span class="number">1</span>, FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">GetNumWorkerThreads</span>());</span><br><span class="line">    <span class="keyword">const</span> int32 NumberOfObjectsPerThread = (MaxNumberOfObjects / NumThreads) + <span class="number">1</span>;		</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºåé¢çš„ &quot;ParallelFor&quot; æä¾›è¿”å›å€¼ï¼ŒåŒ…æ‹¬: éœ€è¦æ¸…é™¤çš„ç°‡åˆ—è¡¨ï¼Œä¿ç•™çš„ç°‡åˆ—è¡¨ï¼Œæ¯ä¸ªçº¿ç¨‹å„è‡ªçš„åºåˆ—åŒ–å¯¹è±¡æ•°ç»„(é‡Œé¢å­˜æ²¡æœ‰ä¸å¯è¾¾æ ‡è®°çš„å¯¹è±¡)</span></span><br><span class="line">    TLockFreePointerListFIFO&lt;FUObjectItem, PLATFORM_CACHE_LINE_SIZE&gt; ClustersToDissolveList;</span><br><span class="line">    TLockFreePointerListFIFO&lt;FUObjectItem, PLATFORM_CACHE_LINE_SIZE&gt; KeepClusterRefsList;</span><br><span class="line">    FGCArrayStruct** ObjectsToSerializeArrays = <span class="keyword">new</span> FGCArrayStruct*[NumThreads];</span><br><span class="line">    <span class="keyword">for</span> (int32 ThreadIndex = <span class="number">0</span>; ThreadIndex &lt; NumThreads; ++ThreadIndex)</span><br><span class="line">    &#123;</span><br><span class="line">        ObjectsToSerializeArrays[ThreadIndex] = FGCArrayPool::<span class="built_in">Get</span>().<span class="built_in">GetArrayStructFromPool</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¹¶è¡Œè¿­ä»£å¤„ç†æ‰€æœ‰å¯¹è±¡ï¼Œè¿™æ˜¯çœŸæ­£å¤„ç†æ ‡è®°çš„ä¸€æ­¥ï¼Œé‡è¦ï¼</span></span><br><span class="line">    <span class="comment">// åˆ†æä¹‹å‰éœ€è¦å…ˆäº†è§£ä¸€äº›æ¦‚å¿µï¼Œ &quot;GUObjectArray&quot; æ˜¯ä¸€ä¸ªå…¨å±€çš„UObejctæ•°ç»„å®ä¾‹ï¼Œå­˜çš„æ˜¯ &quot;ObjectItem&quot;</span></span><br><span class="line">    <span class="comment">// &quot;ObjectItem&quot; æ˜¯ç”¨äºUObjectæ•°ç»„çš„ä¸€ç§ç»“æ„ä½“ï¼Œé‡Œé¢å­˜ç€ä¸€ä¸ªUObjectå’Œä¸€äº›Flagsï¼ŒClusterRootIndexç­‰ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// &quot;ParallelFor&quot; æ˜¯å¼•æ“çš„å¹¶è¡Œå¤„ç†APIï¼Œç”¨äºæé«˜å¤„ç†æ•ˆç‡</span></span><br><span class="line">    <span class="built_in">ParallelFor</span>(NumThreads, [ObjectsToSerializeArrays, &amp;ClustersToDissolveList, &amp;KeepClusterRefsList, FastKeepFlags, KeepFlags, NumberOfObjectsPerThread, NumThreads, MaxNumberOfObjects](int32 ThreadIndex)</span><br><span class="line">  	&#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—æœ¬çº¿ç¨‹éœ€è¦å¤„ç†çš„ç¬¬ä¸€ä¸ªObjectçš„Index</span></span><br><span class="line">   		int32 FirstObjectIndex = ThreadIndex * NumberOfObjectsPerThread + GUObjectArray.<span class="built_in">GetFirstGCIndex</span>();</span><br><span class="line">        <span class="comment">// è®¡ç®—æœ¬çº¿ç¨‹éœ€è¦å¤„ç†çš„Objectçš„æ•°é‡</span></span><br><span class="line">        int32 NumObjects = (ThreadIndex &lt; (NumThreads - <span class="number">1</span>)) ? NumberOfObjectsPerThread : (MaxNumberOfObjects - (NumThreads - <span class="number">1</span>) * NumberOfObjectsPerThread);</span><br><span class="line">        <span class="comment">// éœ€è¦å¤„ç†çš„æœ€åä¸€ä¸ªObjectçš„Index</span></span><br><span class="line">        int32 LastObjectIndex = FMath::<span class="built_in">Min</span>(GUObjectArray.<span class="built_in">GetObjectArrayNum</span>() - <span class="number">1</span>, FirstObjectIndex + NumObjects - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// è®°å½•æœ‰æ•ˆå¯¹è±¡</span></span><br><span class="line">        int32 ObjectCountDuringMarkPhase = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// ç”¨æ¥å­˜ä¸éœ€è¦GCçš„Objectçš„æ•°ç»„</span></span><br><span class="line">        TArray&lt;UObject*&gt;&amp; LocalObjectsToSerialize = ObjectsToSerializeArrays[ThreadIndex]-&gt;ObjectsToSerialize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (int32 ObjectIndex = FirstObjectIndex; ObjectIndex &lt;= LastObjectIndex; ++ObjectIndex)</span><br><span class="line">        &#123;</span><br><span class="line">            FUObjectItem* ObjectItem = &amp;GUObjectArray.<span class="built_in">GetObjectItemArrayUnsafe</span>()[ObjectIndex];</span><br><span class="line">            <span class="keyword">if</span> (ObjectItem-&gt;Object)</span><br><span class="line">            &#123;</span><br><span class="line">                UObject* Object = (UObject*)ObjectItem-&gt;Object;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">checkf</span>(!ObjectItem-&gt;<span class="built_in">IsUnreachable</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *Object-&gt;<span class="built_in">GetFullName</span>());</span><br><span class="line"></span><br><span class="line">                ObjectCountDuringMarkPhase++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bWithClusters)</span><br><span class="line">                &#123;</span><br><span class="line">                    ObjectItem-&gt;<span class="built_in">ClearFlags</span>(EInternalObjectFlags::ReachableInCluster);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ ¹é›†ä¸­çš„å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">IsRootSet</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">checkSlow</span>(Object-&gt;<span class="built_in">IsValidLowLevel</span>());</span><br><span class="line">                    <span class="keyword">if</span> (bWithClusters)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot) || ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>() &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// å¦‚æœè¿™ä¸ªObjectItemæ˜¯ç°‡çš„æ ¹ï¼Œåˆ™ç›´æ¥æ”¾å…¥ &quot;KeepClusterRefsList&quot; ä¸­ï¼Œå› ä¸ºæ ¹ç°‡æ˜¯ä¸éœ€è¦è¢«å¼•ç”¨çš„</span></span><br><span class="line">                            KeepClusterRefsList.<span class="built_in">Push</span>(ObjectItem);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">					<span class="comment">// æ ¹é›†å¯¹è±¡ä¸éœ€è¦è¢«å¼•ç”¨ï¼Œç›´æ¥æ”¾å…¥ &quot;ObjectsToSerialize&quot; æ•°ç»„ä¸­</span></span><br><span class="line">                    LocalObjectsToSerialize.<span class="built_in">Add</span>(Object);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ™®é€šå¯¹è±¡æˆ–è€…ç°‡æ ¹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!bWithClusters || ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>() &lt;= <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">bool</span> bMarkAsUnreachable = <span class="literal">true</span>;</span><br><span class="line">                    <span class="comment">// GarbageCollectionKeepFlagsæ‹¥æœ‰æœ€å¿«çš„checké€Ÿåº¦ï¼Œä¸”è¢«ç”¨äºå¼‚æ­¥è¯»å–ï¼Œå…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œæœ‰æ­¤æ ‡å¿—åº”å½“ç›´æ¥ä¿ç•™ï¼Œå³ä½¿å…¶å¤„äº &quot;PendingKill&quot; çŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(FastKeepFlags))</span><br><span class="line">                    &#123;</span><br><span class="line">                        bMarkAsUnreachable = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¯¥å¯¹è±¡ä¸å¤„äº &quot;PendingKill&quot; çŠ¶æ€ï¼Œä¸”å…·æœ‰KeepFlagsæ ‡å¿—ï¼Œåˆ™ä¿ç•™</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (!ObjectItem-&gt;<span class="built_in">IsPendingKill</span>() &amp;&amp; KeepFlags != RF_NoFlags &amp;&amp; Object-&gt;<span class="built_in">HasAnyFlags</span>(KeepFlags))</span><br><span class="line">                    &#123;</span><br><span class="line">                        bMarkAsUnreachable = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¯¥å¯¹è±¡å¤„äº &quot;PendingKill&quot; çŠ¶æ€ï¼Œä¸”ä¸ºç°‡æ ¹ï¼Œä¸”ä½¿ç”¨ç°‡æ¦‚å¿µï¼Œåˆ™å°†å…¶å½’åˆ°éœ€è¦æ¸…é™¤çš„ç°‡åˆ—è¡¨ä¸­</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">IsPendingKill</span>() &amp;&amp; bWithClusters &amp;&amp; ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot))</span><br><span class="line">                    &#123;</span><br><span class="line">                        ClustersToDissolveList.<span class="built_in">Push</span>(ObjectItem);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// å¦‚æœè¯¥å¯¹è±¡å¯è¾¾ï¼Œåˆ™å°†å…¶åŠ å…¥ &quot;ObjectToSerialize&quot; æ•°ç»„ä¸­ï¼Œå¦‚æœä½¿ç”¨ç°‡æ¦‚å¿µï¼Œä¸”ä¸ºç°‡æ ¹ï¼Œåˆ™è¿˜éœ€è¦å°†å…¶æ·»åŠ åˆ° &quot;KeepClusterRefsList&quot; åˆ—è¡¨ä¸­</span></span><br><span class="line">                    <span class="keyword">if</span> (!bMarkAsUnreachable)</span><br><span class="line">                    &#123;</span><br><span class="line">                        LocalObjectsToSerialize.<span class="built_in">Add</span>(Object);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (bWithClusters)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot))</span><br><span class="line">                            &#123;</span><br><span class="line">                                KeepClusterRefsList.<span class="built_in">Push</span>(ObjectItem);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœè¯¥å¯¹è±¡Itemä¸å¯è¾¾ï¼Œåˆ™å°†å…¶æ ‡ä¸Š &quot;Unreachable&quot;</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        ObjectItem-&gt;<span class="built_in">SetFlags</span>(EInternalObjectFlags::Unreachable);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GObjectCountDuringLastMarkPhase.<span class="built_in">Add</span>(ObjectCountDuringMarkPhase);</span><br><span class="line">    &#125;, !bParallel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†æ‰€æœ‰çº¿ç¨‹ä¸­çš„æ²¡æœ‰ä¸å¯è¾¾æ ‡è®°çš„å¯¹è±¡ é›†ä¸­åˆ°è¦è¿”å›çš„ &quot;ObjectsToSerialize&quot; æ•°ç»„ä¸­</span></span><br><span class="line">    &#123;</span><br><span class="line">        int32 NumObjectsToSerialize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (int32 ThreadIndex = <span class="number">0</span>; ThreadIndex &lt; NumThreads; ++ThreadIndex)</span><br><span class="line">        &#123;</span><br><span class="line">            NumObjectsToSerialize += ObjectsToSerializeArrays[ThreadIndex]-&gt;ObjectsToSerialize.<span class="built_in">Num</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        ObjectsToSerialize.<span class="built_in">Reserve</span>(NumObjectsToSerialize);</span><br><span class="line">        <span class="keyword">for</span> (int32 ThreadIndex = <span class="number">0</span>; ThreadIndex &lt; NumThreads; ++ThreadIndex)</span><br><span class="line">        &#123;</span><br><span class="line">            ObjectsToSerialize.<span class="built_in">Append</span>(ObjectsToSerializeArrays[ThreadIndex]-&gt;ObjectsToSerialize);</span><br><span class="line">            FGCArrayPool::<span class="built_in">Get</span>().<span class="built_in">ReturnToPool</span>(ObjectsToSerializeArrays[ThreadIndex]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">delete</span>[] ObjectsToSerializeArrays;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç† &quot;ClustersToDissolveList&quot; ä¸­çš„ç°‡ï¼Œå¹¶å°†ç°‡ä¸­çš„å¯¹è±¡å…¨éƒ¨æ ‡ä¸ºä¸å¯è¾¾</span></span><br><span class="line">    <span class="keyword">if</span> (bWithClusters)</span><br><span class="line">    &#123;</span><br><span class="line">        TArray&lt;FUObjectItem*&gt; ClustersToDissolve;</span><br><span class="line">        ClustersToDissolveList.<span class="built_in">PopAll</span>(ClustersToDissolve);</span><br><span class="line">        <span class="keyword">for</span> (FUObjectItem* ObjectItem : ClustersToDissolve)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// GUObjectClusters æ˜¯å…¨å±€Clusterå®¹å™¨ï¼Œé‡Œé¢è£…ç€æ‰€æœ‰çš„ç°‡</span></span><br><span class="line">                GUObjectClusters.<span class="built_in">DissolveClusterAndMarkObjectsAsUnreachable</span>(ObjectItem);</span><br><span class="line">                GUObjectClusters.<span class="built_in">SetClustersNeedDissolving</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ‰€æœ‰å¯è¾¾çš„ç°‡ï¼Œå°†ç°‡ä¸­æœ‰ä¸å¯è¾¾æ ‡è®°çš„å¯¹è±¡æ ‡è®°ä¸ºå¯è¾¾</span></span><br><span class="line">    <span class="keyword">if</span> (bWithClusters)</span><br><span class="line">    &#123;</span><br><span class="line">        TArray&lt;FUObjectItem*&gt; KeepClusterRefs;</span><br><span class="line">        KeepClusterRefsList.<span class="built_in">PopAll</span>(KeepClusterRefs);</span><br><span class="line">        <span class="keyword">for</span> (FUObjectItem* ObjectItem : KeepClusterRefs)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>() &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">checkSlow</span>(!ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot));</span><br><span class="line">                <span class="comment">// å½“è¯¥å¯¹è±¡Itemä¸å¯è¾¾ä¸”åœ¨ &quot;KeepClusterRefs&quot; ä¸­æ—¶ï¼Œéœ€è¦å°† &quot;bNeedsDoing&quot; è®¾ä¸º true</span></span><br><span class="line">                <span class="keyword">bool</span> bNeedsDoing = !ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ReachableInCluster);</span><br><span class="line">                <span class="keyword">if</span> (bNeedsDoing)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// å°†è¯¥å¯¹è±¡Itemè®¾ä¸ºå¯è¾¾ç°‡</span></span><br><span class="line">                    ObjectItem-&gt;<span class="built_in">SetFlags</span>(EInternalObjectFlags::ReachableInCluster);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// ç¡®ä¿è¯¥ç°‡çš„æ ¹å¯¹è±¡ä¹Ÿè®¾ä¸ºå¯è¾¾</span></span><br><span class="line">                    <span class="keyword">const</span> int32 OwnerIndex = ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>();</span><br><span class="line">                    FUObjectItem* RootObjectItem = GUObjectArray.<span class="built_in">IndexToObjectUnsafeForGC</span>(OwnerIndex);</span><br><span class="line">                    <span class="built_in">checkSlow</span>(RootObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot));</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// æ¸…é™¤æ ¹å¯¹è±¡Itemçš„ &quot;Unreachable&quot; æ ‡å¿—ï¼Œ</span></span><br><span class="line">                    <span class="keyword">if</span> (RootObjectItem-&gt;<span class="built_in">IsUnreachable</span>()) </span><br><span class="line">                    &#123;</span><br><span class="line">                        RootObjectItem-&gt;<span class="built_in">ClearFlags</span>(EInternalObjectFlags::Unreachable);</span><br><span class="line">                        <span class="comment">// ç¡®ä¿æ‰€æœ‰è¢«å¼•ç”¨çš„ç°‡éƒ½è®¾ä¸ºå¯è¾¾</span></span><br><span class="line">                        FGCReferenceProcessor &lt;EFastReferenceCollectorOptions::WithClusters&gt; :: <span class="built_in">MarkReferencedClustersAsReachable</span> (RootObjectItem-&gt;<span class="built_in">GetClusterIndex</span>(), ObjectsToSerialize);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">checkSlow</span>(ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot));</span><br><span class="line">               <span class="comment">// ç¡®ä¿æ‰€æœ‰è¢«å¼•ç”¨çš„ç°‡éƒ½è®¾ä¸ºå¯è¾¾</span></span><br><span class="line">                FGCReferenceProcessor &lt;EFastReferenceCollectorOptions::WithClusters&gt; :: <span class="built_in">MarkReferencedClustersAsReachable</span> (ObjectItem-&gt;<span class="built_in">GetClusterIndex</span>(), ObjectsToSerialize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&quot;MarkObjectsFunction&quot; å°±æ˜¯ä¸€ä¸ªå¹¶è¡Œè¿­ä»£å¤„ç†æ‰€æœ‰å¯¹è±¡çš„è¿‡ç¨‹ï¼Œæ ¹æ® &quot;GarbageCollectionKeepFlags&quot; å’Œ &quot;KeepFlags&quot; ä»¥åŠ &quot;PendingKill&quot; æ¥ç»™å¯¹è±¡ï¼ˆæˆ–ç°‡ï¼‰åˆ†ç±»ï¼Œæœ€ç»ˆå®ç°æ ‡è®°å¯¹è±¡çš„ç›®çš„ã€‚è¯¦ç»†è§£æè¯·çœ‹ä¸Šé¢çš„æºä»£ç æ³¨é‡Šï¼ˆæ€»ç»“å¾—å¾ˆè¾›è‹¦çš„å•Š æ‹œæ‰˜</p><h5 id="reachabilityanalysisfunctions"><a class="anchor" href="#reachabilityanalysisfunctions">#</a> ReachabilityAnalysisFunctions</h5><p></p><figure class="highlight c++"><figcaption><span>ReachabilityAnalysisFunctions</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PerformReachabilityAnalysisOnObjectsInternal</span><span class="params">(FGCArrayStruct* ArrayStruct)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		FGCReferenceProcessor&lt;CollectorOptions&gt; ReferenceProcessor;</span><br><span class="line">		TFastReferenceCollector&lt;</span><br><span class="line">			FGCReferenceProcessor&lt;CollectorOptions&gt;,</span><br><span class="line">			FGCCollector&lt;CollectorOptions&gt;,</span><br><span class="line">			FGCArrayPool,</span><br><span class="line">			CollectorOptions</span><br><span class="line">			&gt;  <span class="built_in">ReferenceCollector</span>(ReferenceProcessor, FGCArrayPool::<span class="built_in">Get</span>());</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">// &quot;ReferenceCollector&quot; æ˜¯ æä¾›ç»Ÿä¸€çš„æŸ¥æ‰¾UObjectå¼•ç”¨çš„APIçš„è¾…åŠ©ç±»</span></span><br><span class="line">    	<span class="comment">// &quot;CollectReferences&quot; æ˜¯ è¿›è¡Œå¯è¾¾æ€§åˆ†æçš„å‡½æ•°ï¼Œå‡½æ•°è§£æè¯¦è§ä¸‹æ–‡</span></span><br><span class="line">		ReferenceCollector.<span class="built_in">CollectReferences</span>(*ArrayStruct);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><p>è¿™é‡Œéœ€è¦å…ˆå¯¹å››ä¸ªç±»è¿›è¡Œè¯´æ˜ï¼š&quot;FGCReferenceProcessor&quot; &quot;FGCCollector&quot; &quot;FGCArrayPool&quot; &quot;TFastReferenceCollector&quot;ï¼Œå¯ä»¥ç›´æ¥è·³åˆ° <a href="#CollectReferences">&quot;CollectReferences&quot;</a> çš„è§£æï¼Œä½†ä¸å»ºè®® ğŸ˜ƒ</p><ol><li><p>&quot;FGCReferenceProcessor&quot; -&gt; GC å¼•ç”¨å¤„ç†å™¨ï¼Œå› ä¸ºç¯‡å¹…åŸå› ï¼Œä»¥ä¸‹åªå¯¹æ–¹æ³•è¿›è¡Œç½—åˆ—å’Œä½œç”¨è¯´æ˜ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸€ä¸‹ï¼Œæºä»£ç æ˜¯æ€ä¹ˆå®ç°çš„</p><p></p><figure class="highlight c++"><figcaption><span>FGCReferenceProcessor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;EFastReferenceCollectorOptions Options&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FGCReferenceProcessor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¹¶è¡Œå¤„ç†ç¨‹åºï¼Œæ˜¯å¦ä½¿ç”¨ç°‡</span></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="keyword">static</span> FORCEINLINE <span class="keyword">bool</span> <span class="title">IsParallel</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="keyword">static</span> FORCEINLINE <span class="keyword">bool</span> <span class="title">IsWithClusters</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æ¯ä¸ªå­ä»»åŠ¡æ‰€éœ€å¤„ç†çš„æœ€å°‘å¯¹è±¡æ•°(ä¸€ä¸ªæå‰è®¾å®šå¥½çš„GCå…¨å±€å˜é‡)</span></span><br><span class="line">    <span class="function">FORCEINLINE int32 <span class="title">GetMinDesiredObjectsPerSubTask</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Debugç›¸å…³</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UpdateDetailedStats</span><span class="params">(UObject* CurrentObject, uint32 DeltaCycles)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LogDetailedStatsSummary</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Markè¢«ç°‡å¼•ç”¨ä½†ä¸å¯åŠ å…¥ç°‡ä¸­çš„å¯¹è±¡ä¸ºReachable</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> FORCENOINLINE <span class="keyword">bool</span> <span class="title">MarkClusterMutableObjectsAsReachable</span><span class="params">(FUObjectCluster&amp; Cluster, TArray&lt;UObject*&gt;&amp; ObjectsToSerialize)</span></span>;</span><br><span class="line">    <span class="comment">// Markæ‰€æœ‰è¢«å…¶ä»–ç°‡å¼•ç”¨çš„ç°‡ä¸ºReachable</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> FORCENOINLINE <span class="keyword">void</span> <span class="title">MarkReferencedClustersAsReachable</span><span class="params">(int32 ClusterIndex, TArray&lt;UObject*&gt;&amp; ObjectsToSerialize)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†å¯¹è±¡å¼•ç”¨ï¼Œå¯èƒ½ä¸ºç©ºã€‚é‡è¦ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">    <span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">HandleObjectReference</span><span class="params">(TArray&lt;UObject*&gt;&amp; ObjectsToSerialize, <span class="keyword">const</span> UObject * <span class="keyword">const</span> ReferencingObject, UObject*&amp; Object, <span class="keyword">const</span> <span class="keyword">bool</span> bAllowReferenceElimination)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨UClassçš„token streamå¤„ç†å¯¹è±¡å¼•ç”¨ã€‚é‡è¦ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">    <span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">HandleTokenStreamObjectReference</span><span class="params">(TArray&lt;UObject*&gt;&amp; ObjectsToSerialize, UObject* ReferencingObject, UObject*&amp; Object, <span class="keyword">const</span> int32 TokenIndex, <span class="keyword">bool</span> bAllowReferenceElimination)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&quot;FGCReferenceProcessor&quot; æ˜¯ä¸€ä¸ªå¤„ç†å™¨ç±»ï¼Œåªå¤„ç†å’Œ GC å¼•ç”¨ç›¸å…³çš„é€»è¾‘ã€‚</p></li><li><p>&quot;FGCCollector&quot; -&gt; ä½¿ç”¨ &quot;FGCReferenceProcessor&quot; å°†å¯¹è±¡æ ‡è®°ä¸ºå¯è¾¾çš„å¯¹è±¡</p></li></ol><p></p><figure class="highlight c++"><figcaption><span>FGCCollector</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;EFastReferenceCollectorOptions Options&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FGCCollector</span> :</span> <span class="keyword">public</span> FReferenceCollector</span><br><span class="line">&#123;</span><br><span class="line">	FGCReferenceProcessor&lt;Options&gt;&amp; ReferenceProcessor;</span><br><span class="line">	FGCArrayStruct&amp; ObjectArrayStruct;</span><br><span class="line">	<span class="keyword">bool</span> bAllowEliminatingReferences;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">constexpr</span> FORCEINLINE <span class="keyword">bool</span> <span class="title">IsParallel</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> FORCEINLINE <span class="keyword">bool</span> <span class="title">IsWithClusters</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">FGCCollector</span>(FGCReferenceProcessor&lt;Options&gt;&amp; InProcessor, FGCArrayStruct&amp; InObjectArrayStruct);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åªæ˜¯è°ƒç”¨äº†ReferenceProcessorçš„HandleObjectReference</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">HandleObjectReference</span><span class="params">(UObject*&amp; InObject, <span class="keyword">const</span> UObject* InReferencingObject, <span class="keyword">const</span> FProperty* InReferencingProperty)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">HandleObjectReferences</span><span class="params">(UObject** InObjects, <span class="keyword">const</span> int32 ObjectNum, <span class="keyword">const</span> UObject* InReferencingObject, <span class="keyword">const</span> FProperty* InReferencingProperty)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsIgnoringArchetypeRef</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsIgnoringTransient</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AllowEliminatingReferences</span><span class="params">(<span class="keyword">bool</span> bAllow)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		bAllowEliminatingReferences = bAllow;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">MarkWeakObjectReferenceForClearing</span><span class="params">(UObject** WeakReference)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// ä¿ç•™è¯¥å¼±å¼•ç”¨ï¼Œä»¥ä¾¿æ—¥åé”€æ¯</span></span><br><span class="line">		ObjectArrayStruct.WeakReferences.<span class="built_in">Add</span>(WeakReference);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ol start="3"><li><p>&quot;FGCArrayPool&quot; -&gt; ç”¨äºå‡å°‘ GC åˆ†é…çš„æ± </p><p></p><figure class="highlight c++"><figcaption><span>FGCArrayPool</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FastReferenceCollector.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FGCArrayPool</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// å•ä¾‹</span></span><br><span class="line">    <span class="function">FORCEINLINE <span class="keyword">static</span> FGCArrayPool&amp; <span class="title">Get</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">FORCEINLINE FGCArrayStruct* <span class="title">GetArrayStructFromPool</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">ReturnToPool</span><span class="params">(FGCArrayStruct* ArrayStruct)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Cleanup</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†™å‡ºæ± çš„ç»„æˆä¿¡æ¯ï¼Œç”¨äºdebug</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DumpStats</span><span class="params">(FOutputDevice&amp; OutputDevice)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…é™¤æ± ä¸­çš„æ‰€æœ‰å¼±å¼•ç”¨ï¼Œtrueåˆ™æ¸…ç©ºæ•´ä¸ªæ± å­</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ClearWeakReferences</span><span class="params">(<span class="keyword">bool</span> bClearPools)</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ç»§æ‰¿è‡ªFNoncopyableçš„å•ä¾‹å¯¹è±¡æ± ï¼ŒFGCArrayStructé‡Œé¢æœ‰ä¸¤ä¸ªTArrayï¼Œåˆ†åˆ«æ˜¯ObjectsToSerializeåŠå…¶å¼±å¼•ç”¨åˆ—è¡¨ã€‚</span></span><br><span class="line">    TLockFreePointerListLIFO&lt;FGCArrayStruct&gt; Pool;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p></li><li><p>&quot;TFastReferenceCollector&quot; è¿™ä¸ªç±»ä¾èµ–äºå‰é¢ä¸‰ä¸ªç±»ï¼Œæä¾›äº† unrealGC å¤„ç†å¼•ç”¨çš„é€šç”¨æ–¹æ³•ï¼ˆé€šè¿‡éå† UClass çš„ TokenStream å’Œè°ƒç”¨ AddReferencedObjects æ–¹æ³•ï¼‰</p><p></p><figure class="highlight c++"><figcaption><span>TFastReferenceCollector</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// FastReferenceCollector.h</span></span><br><span class="line">   </span><br><span class="line">   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ReferenceProcessorType, <span class="keyword">typename</span> CollectorType, <span class="keyword">typename</span> ArrayPoolType, EFastReferenceCollectorOptions Options = EFastReferenceCollectorOptions::None&gt;</span><br><span class="line">   class TFastReferenceCollector</span><br><span class="line">   &#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">       </span><br><span class="line">       <span class="built_in">TFastReferenceCollector</span>(ReferenceProcessorType&amp; InReferenceProcessor, ArrayPoolType&amp; InArrayPool)</span><br><span class="line">           : <span class="built_in">ReferenceProcessor</span>(InReferenceProcessor)</span><br><span class="line">           , <span class="built_in">ArrayPool</span>(InArrayPool)</span><br><span class="line">           , <span class="built_in">TaskQueue</span>(<span class="keyword">this</span>, InArrayPool)</span><br><span class="line">   	&#123;&#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œé‡è¦å‡½æ•°ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">       <span class="keyword">void</span> <span class="built_in">CollectReferences</span>(FGCArrayStruct&amp; ArrayStruct);</span><br><span class="line">       </span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">       <span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">MoveToNextContainerElementAndCheckIfValid</span><span class="params">(FStackEntry* StackEntry)</span> <span class="keyword">const</span></span>;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// è°ƒç”¨ &quot;ReferenceProcessor.HandleTokenStreamObjectReference&quot; å¤„ç†å¼±å¯¹è±¡æŒ‡é’ˆçš„å¼•ç”¨</span></span><br><span class="line">       <span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">HandleWeakObjectPtr</span><span class="params">(FWeakObjectPtr&amp; WeakPtr, TArray&lt;UObject*&gt;&amp; NewObjectsToSerialize, UObject* CurrentObject, int32 ReferenceTokenStreamIndex)</span></span>;</span><br><span class="line">   	</span><br><span class="line">       <span class="comment">// éå† &quot;UObject token stream&quot;ï¼Œå¯»æ‰¾ä»ç„¶å­˜åœ¨çš„å¼•ç”¨ã€‚é‡è¦å‡½æ•°ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">ProcessObjectArray</span><span class="params">(FGCArrayStruct&amp; InObjectsToSerializeStruct, <span class="keyword">const</span> FGraphEventRef&amp; MyCompletionGraphEvent)</span></span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">æ€»çš„æ¥è¯´ï¼Œå‰é¢ä¸‰ä¸ªç±»æ˜¯ <span class="string">&quot;TFastReferenceCollector&quot;</span> çš„ç»„ä»¶ï¼Œä»¥å®ç°è™šå¹»GCæ—¶å¤„ç†å¼•ç”¨çš„é€šç”¨æ–¹æ³•ã€‚ä¸‹é¢å¼€å§‹è§£æ <span class="string">&quot;TFastReferenceCollector&quot;</span> çš„ <span class="string">&quot;CollectReferences&quot;</span> æ–¹æ³•ï¼Œå‡½å¦‚å…¶åï¼Œå°±æ˜¯ç”¨æ¥å¤„ç†ä¼ è¿›æ¥çš„å¯¹è±¡æ•°ç»„çš„å¼•ç”¨ä¿¡æ¯çš„</span><br><span class="line"></span><br><span class="line">##### CollectReferences &lt;a id=<span class="string">&quot;CollectReferences&quot;</span>&gt;&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">~~~ C++ CollectReferences</span><br><span class="line"><span class="comment">// FastReferenceCollector.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="built_in">CollectReferences</span>(FGCArrayStruct&amp; ArrayStruct)</span><br><span class="line">&#123;</span><br><span class="line">    TArray&lt;UObject*&gt;&amp; ObjectsToCollectReferencesFor = ArrayStruct.ObjectsToSerialize;</span><br><span class="line">    <span class="keyword">if</span> (ObjectsToCollectReferencesFor.<span class="built_in">Num</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// éå¹¶è¡Œå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">IsParallel</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// &quot;FGraphEventRef&quot; ä»»åŠ¡åˆ—è¡¨çš„å¼•ç”¨è®¡æ•°æŒ‡é’ˆ (é‡Œé¢å­˜ç€ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡)</span></span><br><span class="line">            FGraphEventRef InvalidRef;</span><br><span class="line">           	<span class="comment">// é‡è¦ï¼Œç”¨æ¥å¤„ç† &quot;ArrayStruct&quot; ä¸­çš„UObjectçš„å¼•ç”¨ä¿¡æ¯ï¼Œè¯¦è§ä¸‹æ–‡</span></span><br><span class="line">            <span class="built_in">ProcessObjectArray</span>(ArrayStruct, InvalidRef);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// &quot;FGraphEventRef&quot; æ•°ç»„ï¼Œå„ä¸ªçº¿ç¨‹çš„ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">            FGraphEventArray ChunkTasks;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šä¹‰å¿…è¦æ•°æ®: çº¿ç¨‹æ•°ï¼Œåå°çº¿ç¨‹æ•°ï¼Œæ™®é€šçº¿ç¨‹ç±»å‹ï¼Œåå°çº¿ç¨‹ç±»å‹</span></span><br><span class="line">            int32 NumThreads = FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">GetNumWorkerThreads</span>();</span><br><span class="line">            int32 NumBackgroundThreads = ENamedThreads::bHasBackgroundThreads ? NumThreads : <span class="number">0</span>;</span><br><span class="line">            ENamedThreads::Type NormalThreadName = ENamedThreads::AnyNormalThreadNormalTask;</span><br><span class="line">            ENamedThreads::Type BackgroundThreadName = ENamedThreads::AnyBackgroundThreadNormalTask;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯ ä¸ºå¯¹è±¡å¼•ç”¨æ”¶é›†å™¨ä¿®æ”¹çº¿ç¨‹è¯·æ±‚ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥å¤„ç†å’±ä¸Šé¢å£°æ˜çš„æ•°æ®çš„ï¼Œä¸åŒå¹³å°ä¼šæœ‰ä¸åŒå®ç°</span></span><br><span class="line">            FPlatformProcess::<span class="built_in">ModifyThreadAssignmentForUObjectReferenceCollector</span>(NumThreads, NumBackgroundThreads, NormalThreadName, BackgroundThreadName);</span><br><span class="line">            int32 NumTasks = NumThreads + NumBackgroundThreads;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">check</span>(NumTasks &gt; <span class="number">0</span>);</span><br><span class="line">            ChunkTasks.<span class="built_in">Empty</span>(NumTasks);</span><br><span class="line">            <span class="comment">// æ¯ä¸ªçº¿ç¨‹éœ€è¦å¤„ç†çš„Objectä¸ªæ•°</span></span><br><span class="line">            int32 NumPerChunk = ObjectsToCollectReferencesFor.<span class="built_in">Num</span>() / NumTasks;</span><br><span class="line">            int32 StartIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (int32 Chunk = <span class="number">0</span>; Chunk &lt; NumTasks; Chunk++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Chunk + <span class="number">1</span> == NumTasks)</span><br><span class="line">                &#123;</span><br><span class="line">                    NumPerChunk = ObjectsToCollectReferencesFor.<span class="built_in">Num</span>() - StartIndex; <span class="comment">// last chunk takes all remaining items</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ·»åŠ ä»»åŠ¡åˆ° &quot;TaskQueue&quot; ä»»åŠ¡é˜Ÿåˆ—ï¼Œ&quot;TaskQueue&quot; æ˜¯ç”¨æ¥æ”¶é›†æ‰€æœ‰ä»»åŠ¡çš„ï¼Œåœ¨åé¢ä¼šåˆ†é…ç»™ &quot;ChunkTasks&quot;</span></span><br><span class="line">                TaskQueue.<span class="built_in">AddTask</span>(&amp;ObjectsToCollectReferencesFor, StartIndex, NumPerChunk);</span><br><span class="line">                StartIndex += NumPerChunk;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (int32 Chunk = <span class="number">0</span>; Chunk &lt; NumTasks; Chunk++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// ä¸ºä¸åŒçº¿ç¨‹çš„ &quot;ChunkTasks&quot; æ·»åŠ ä»»åŠ¡ï¼Œä»»åŠ¡çš„å…·ä½“å†…å®¹ä¼šåœ¨ä¸‹æ–‡åˆ†æ</span></span><br><span class="line">                ChunkTasks.<span class="built_in">Add</span>(TGraphTask&lt; FCollectorTaskProcessorTask &gt;::<span class="built_in">CreateTask</span>().<span class="built_in">ConstructAndDispatchWhenReady</span>(TaskQueue, Chunk &gt;= NumThreads ? BackgroundThreadName : NormalThreadName));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç­‰å¾… &quot;TaskQueue&quot; ä¸­çš„ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">            FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">WaitUntilTasksComplete</span>(ChunkTasks, ENamedThreads::GameThread_Local);</span><br><span class="line">            TaskQueue.<span class="built_in">CheckDone</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p></li></ol><p>Unreal æä¾›äº†ä¸¤ç§æ–¹å¼æ¥è¿›è¡Œå¯¹è±¡å¼•ç”¨åˆ†æçš„ï¼ˆéå¹¶è¡Œå’Œå¹¶è¡Œï¼‰ã€‚å’±æ¥åˆ†åˆ«çœ‹çœ‹éƒ½æ˜¯æ€ä¹ˆå®ç°çš„å§</p><h4 id="processobjectarray-éå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨"><a class="anchor" href="#processobjectarray-éå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨">#</a> ProcessObjectArray | éå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨</h4><h5 id="processobjectarray-éå†uobjectçš„tokenstreamæ¥å¯»æ‰¾å½“å‰å­˜åœ¨çš„å¼•ç”¨è§£æå¦‚ä¸‹"><a class="anchor" href="#processobjectarray-éå†uobjectçš„tokenstreamæ¥å¯»æ‰¾å½“å‰å­˜åœ¨çš„å¼•ç”¨è§£æå¦‚ä¸‹">#</a> &quot;ProcessObjectArray&quot; éå† UObject çš„ TokenStream æ¥å¯»æ‰¾å½“å‰å­˜åœ¨çš„å¼•ç”¨ï¼Œè§£æå¦‚ä¸‹ï¼š</h5><p></p><figure class="highlight c++"><figcaption><span>ProcessObjectArray</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FastReferenceCollector.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessObjectArray</span><span class="params">(FGCArrayStruct&amp; InObjectsToSerializeStruct, <span class="keyword">const</span> FGraphEventRef&amp; MyCompletionGraphEvent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UObject* CurrentObject = <span class="literal">nullptr</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾å®šæ¯ä¸ªå­ä»»åŠ¡å¤„ç†çš„æœ€å°‘å¯¹è±¡ï¼Œç”¨äºå¹¶è¡Œå¤„ç†</span></span><br><span class="line">   	<span class="keyword">const</span> int32 MinDesiredObjectsPerSubTask = ReferenceProcessor.<span class="built_in">GetMinDesiredObjectsPerSubTask</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** ä»GCå¯¹è±¡æ•°ç»„æ± ä¸­è·å–éœ€è¦ä¸€ä¸ªæ–°çš„GCç”¨å¯¹è±¡æ•°ç»„ */</span></span><br><span class="line">    FGCArrayStruct&amp;	NewObjectsToSerializeStruct = *ArrayPool.<span class="built_in">GetArrayStructFromPool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¦å¤„ç†çš„å¯¹è±¡æ•°ç»„</span></span><br><span class="line">    TArray&lt;UObject*&gt;&amp; ObjectsToSerialize = InObjectsToSerializeStruct.ObjectsToSerialize;</span><br><span class="line">    <span class="comment">// ç©ºæ•°ç»„</span></span><br><span class="line">    TArray&lt;UObject*&gt;&amp; NewObjectsToSerialize = NewObjectsToSerializeStruct.ObjectsToSerialize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºå¤„ç†æ•°ç»„åµŒå¥—çš„é¢„å®šä¹‰é€’å½’è°ƒç”¨æ ˆæ•°ç»„ï¼Œ&quot;FStackEntry&quot; æ˜¯ä¸€ä¸ªè°ƒç”¨æ ˆå…¥å£ï¼Œé‡Œé¢åŒ…å«å½“å‰æ ˆæ‰€å¤„ç†åˆ°çš„æ•°æ®æŒ‡é’ˆï¼Œè¿˜æœ‰æ•°æ®é•¿åº¦ï¼Œå’Œæ€»æ•°æ®é‡ç­‰ã€‚</span></span><br><span class="line">    TArray&lt;FStackEntry&gt; Stack;</span><br><span class="line">    Stack.<span class="built_in">AddUninitialized</span>(<span class="number">128</span>); 	<span class="comment">// å¦‚æœé€’å½’è¶…è¿‡128å±‚ï¼Œåˆ™éœ€è¦é¢å¤–å¤„ç†ï¼Œæˆ–è§¦å‘æ–­è¨€</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éœ€è¦ä¸€ä¸ªé¢å¤–é¡¹ç”¨äºä¸ç¡®å®šçš„é¢„å–ä»£ç (é¿å…è¶Šç•Œ)</span></span><br><span class="line">    ObjectsToSerialize.<span class="built_in">Reserve</span>(ObjectsToSerialize.<span class="built_in">Num</span>() + <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•å½“å‰å¤„ç†åˆ°çš„ éœ€è¦è¿›è¡Œå¯è¾¾æ€§åˆ†æçš„å¯¹è±¡æ•°ç»„çš„ç´¢å¼•</span></span><br><span class="line">   	int32 CurrentIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">CollectorType <span class="title">ReferenceCollector</span><span class="params">(ReferenceProcessor, NewObjectsToSerializeStruct)</span></span>;</span><br><span class="line">        <span class="keyword">while</span>(CurrentIndex &lt; ObjectsToSerialize.<span class="built_in">Num</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            CurrentObject = ObjectsToSerialize[CurrentIndex++];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// GetData() -&gt; é¿å¼€è¶Šç•Œæ£€æµ‹</span></span><br><span class="line">            <span class="comment">// FMath::Min -&gt; é¿å…è¶Šç•Œ</span></span><br><span class="line">            <span class="comment">// Num()-1 -&gt; é¿å…è¯»å–åˆ°ä¸å®‰å…¨æˆ–æ˜¯æœªåˆ†é…çš„åœ°å€</span></span><br><span class="line">            <span class="keyword">const</span> UObject* <span class="keyword">const</span> NextObject = ObjectsToSerialize.<span class="built_in">GetData</span>()[FMath::Min&lt;int32&gt;(CurrentIndex, ObjectsToSerialize.<span class="built_in">Num</span>() - <span class="number">1</span>)];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å‡è®¾ä¸‹ä¸€ä¸ªå¯¹è±¡çš„å±æ€§å¤§å°å’Œå½“å‰å¯¹è±¡ç›¸åŒï¼Œåˆ™é¢„å–ä¸‹ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">            <span class="comment">// è¿™æ ·æˆ‘ä»¬å¯ä»¥é¿å…å¯¹ &quot;NextObject&quot; çš„ä¸€æ¬¡åˆ†æ”¯å¤„ç†</span></span><br><span class="line">            FPlatformMisc::<span class="built_in">PrefetchBlock</span>(NextObject, CurrentObject-&gt;<span class="built_in">GetClass</span>()-&gt;<span class="built_in">GetPropertiesSize</span>());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç¡®ä¿å½“å‰å¤„ç†çš„Objectå·²ç»è£…é…ä¸Š &quot;TokenStream&quot;ï¼Œ&quot;TokenStream&quot; æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæ˜¯UClassä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œç”¨äºåˆ›å»ºå’Œè§£æå¯¹è±¡çš„å¼•ç”¨æµ</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">IsParallel</span>() &amp; <span class="built_in">CanAutogenerateTokenStream</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                UClass* ObjectClass = CurrentObject-&gt;<span class="built_in">GetClass</span>();</span><br><span class="line">                <span class="comment">// å¦‚æœUClassä¸­çš„ &quot;TokenStram&quot; æ²¡æœ‰è£…é…ä¸Š &quot;TokenStream&quot;ï¼Œåˆ™ä¸ºå…¶è£…ä¸Š</span></span><br><span class="line">                <span class="keyword">if</span>(!ObjectClass-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_TokenStreamAssembled))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// &quot;AssembleReferenceTokenStream&quot; ç»™ &quot;ObjectClass&quot; è£…ä¸Š &quot;TokenStream&quot;ï¼Œä¸åšå±•å¼€</span></span><br><span class="line">                    ObjectClass-&gt;<span class="built_in">AssembleReferenceTokenStream</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!CurrentObject-&gt;<span class="built_in">GetClass</span>()-&gt;<span class="built_in">HasAnyClassFlags</span>(CLASS_TokenStreamAssembled))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">UE_LOG</span>(LogGarbage, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;%s does not yet have a token stream assembled.&quot;</span>), *<span class="built_in">GetFullNameSafe</span>(CurrentObject-&gt;<span class="built_in">GetClass</span>()));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(!<span class="built_in">IsParallel</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                ReferenceProcessor.<span class="built_in">SetCurrentObject</span>(CurrentObject);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–æŒ‡å‘ &quot;TokenStream&quot; çš„æŒ‡é’ˆï¼Œå¹¶è·³è½¬è‡³å¼€å§‹å¤„ã€‚ä»¥ä¸‹å¼€å§‹è§£æè¯¥Objectçš„ &quot;TokenStream&quot;(å¯¹è±¡å¼•ç”¨æµ)</span></span><br><span class="line">            FGCReferenceTokenStream* RESTRICT TokenStream = &amp;CurrentObject-&gt;<span class="built_in">GetClass</span>()-&gt;ReferenceTokenStream;</span><br><span class="line">            uint32 TokenStreamIndex = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä¿ç•™å¼•ç”¨ä¿¡æ¯çš„ç´¢å¼•ï¼Œç”¨äºé¿å…LHSs</span></span><br><span class="line">            uint32 ReferenceTokenStreamIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºæ ˆå…¥å£å¹¶åˆå§‹åŒ–å…¶å€¼ï¼Œç”¨äºæ•°ç»„å’Œç»“æ„ä½“ç­‰çš„å¤æ‚åµŒå¥—ç»“æ„ä¸­çš„ &quot;Tokens&quot; è§£æ</span></span><br><span class="line">            FStackEntry* RESTRICT StackEntry = Stack.<span class="built_in">GetData</span>();</span><br><span class="line">            uint8* StackEntryData = (uint8*)CurrentObject;</span><br><span class="line">            StackEntry-&gt;Data = StackEntryData;</span><br><span class="line">            StackEntry-&gt;ContainerType = GCRT_None;</span><br><span class="line">            StackEntry-&gt;Stride = <span class="number">0</span>;</span><br><span class="line">            StackEntry-&gt;Count = <span class="number">-1</span>;</span><br><span class="line">            StackEntry-&gt;LoopStartIndex = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// ä¿ç•™ &quot;Token&quot; è¿”å›çš„æ•°é‡ä¸ºä¸€ä¸ªå•ç‹¬çš„æ•´æ•°ï¼Œç”¨äºä¿®æ”¹æ•°ç»„</span></span><br><span class="line">            int32 TokenReturnCount = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// &quot;TokenStream&quot; çš„è¯­æ³•åˆ†æ (ä»¥ä¸‹ä»£ç å¯èƒ½æœ‰ç¼–è¯‘åŸç†åŸºç¡€çš„åŒå­¦ä¼šå¥½ç†è§£ä¸€ç‚¹)</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// ä¿å­˜å½“å‰çš„ &quot;Token Index&quot; ï¼Œå› ä¸ºå®ƒæ˜¯æŒ‡å‘å¼•ç”¨ä¿¡æ¯çš„ç´¢å¼•</span></span><br><span class="line">               	ReferenceTokenStreamIndex = TokenStreamIndex;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¤„ç†æ•°ç»„å’Œç»“æ„ä½“ç­‰åµŒå¥—æ•°æ®(å¦‚æœæœ‰åµŒå¥—)</span></span><br><span class="line">                <span class="keyword">for</span>(int32 ReturnCount = <span class="number">0</span>; ReturnCount &lt; TokenReturnCount; ReturnCount++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// ç¡®ä¿æ²¡æœ‰æ ˆä¸‹æº¢</span></span><br><span class="line">                    <span class="built_in">check</span>(StackEntry-&gt;Count != <span class="number">1</span>);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span>(--StackEntry-&gt;Count &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span>(StackEntry-&gt;ContainerType == GCRT_None)</span><br><span class="line">                        &#123;</span><br><span class="line">                           	<span class="comment">// è®©å½“å‰StackEntryçš„DataæŒ‡é’ˆæŒ‡å‘å®¹å™¨ç§çš„ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">                            StackEntryData = StackEntry-&gt;Data + StackEntry-&gt;Stride;</span><br><span class="line">                            StackEntry-&gt;Data = StackEntryData;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// è·Ÿä¸Šé¢çš„ä¸€æ ·ï¼Œä½† &quot;éGCRT_None&quot; çš„ &quot;ContainerType&quot; éœ€è¦checkå®¹å™¨ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">                            <span class="keyword">do</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                StackEntryData = StackEntry-&gt;Data + StackEntry-&gt;Stride;</span><br><span class="line">                                StackEntry-&gt;Data = StackEntryData;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">while</span>(!<span class="built_in">MoveToNextContainerElementAndCheckIfValid</span>(StackEntry))</span><br><span class="line">                        &#125;  </span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// è¿”å›å¾ªç¯çš„å¼€å§‹å¤„ï¼Œè¿™ä¸€æ­¥ç¡®ä¿äº†èƒ½å–åˆ°æ­£ç¡®çš„ObjectPtrï¼Œå¹¶å¤„ç†å…¶å¯¹è±¡å¼•ç”¨</span></span><br><span class="line">                        TokenStreamIndex = StackEntry-&gt;LoopStartIndex;</span><br><span class="line">                        ReferenceTokenStreamIndex = StackEntry-&gt;LoopStartIndex;</span><br><span class="line">                        <span class="comment">// æå‰ä¸­æ–­ä½†æ²¡æœ‰é€€å‡ºå½“å‰çš„StackEntryï¼Œä»¥å¤„ç†å½“å‰StackEntryå®¹å™¨ä¸­çš„Data</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// å½“å‰StackEntryå·²ç»æ²¡æœ‰å…ƒç´ å¯åˆ†æï¼Œè¿”å›ä¸Šä¸€ä¸ªStackEntry</span></span><br><span class="line">                        StackEntry-&gt;ContainerType = GCRT_None;</span><br><span class="line">                        StackEntry--;</span><br><span class="line">                        StackEntryData = StackEntry-&gt;Data;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è®¿é—®å½“å‰TokenStreamç´¢å¼•çš„å¼•ç”¨ä¿¡æ¯ï¼ŒFGCReferenceInfoæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº†ä¸€ä¸ªå¼•ç”¨æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼•ç”¨æ·±åº¦ï¼Œå¼•ç”¨ç±»å‹å’Œåœ°å€åç§»</span></span><br><span class="line">                TokenStreamIndex++;</span><br><span class="line">                FGCReferenceInfo ReferenceInfo = TokenStream-&gt;<span class="built_in">AccessReferenceInfo</span>(ReferenceTokenStreamIndex);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è¿™é‡Œcaseå¤ªå¤šäº†ï¼Œå’±åªä¸¾ä¾‹ä¸¤ç§</span></span><br><span class="line">                <span class="built_in"><span class="keyword">switch</span></span>(ReferenceInfo.Type)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> GCRT_Class:</span><br><span class="line">                        &#123;</span><br><span class="line">                            UObject** ObjectPtr = (UObject**)(StackEntryData + ReferenceInfo.Offset);</span><br><span class="line">                            UObject*&amp; Object = *ObjectPtr;</span><br><span class="line">                            TokenReturnCount = ReferenceInfo.ReturnCount;</span><br><span class="line">                            <span class="comment">// çœŸæ­£å¤„ç†å¯¹è±¡å¼•ç”¨çš„å‡½æ•°</span></span><br><span class="line">                            ReferenceProcessor.<span class="built_in">HandleTokenStreamObjectReference</span>(NewObjectsToSerialize, CurrentObject, Object, ReferenceTokenStreamIndex, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> GCRT_ArrayStack:</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// æ•°ç»„ç»“æ„ä½“åµŒå¥—ç±»å‹</span></span><br><span class="line">                            <span class="keyword">const</span> FScriptArray&amp; Array = *((FScriptArray*)(StackEntryData + ReferenceInfo.Offset));</span><br><span class="line">                            <span class="comment">// è¿›å…¥ä¸€ä¸ªæ–°çš„è°ƒç”¨æ ˆï¼Œå¹¶å°†å…¶åˆå§‹åŒ–</span></span><br><span class="line">                            StackEntry++;</span><br><span class="line">                            StackEntryData = (uint8*)Array.<span class="built_in">GetData</span>();</span><br><span class="line">                            StackEntry-&gt;Data = StackEntryData;</span><br><span class="line">                            StackEntry-&gt;Stride = TokenStream-&gt;<span class="built_in">ReadStride</span>(TokenStreamIndex);</span><br><span class="line">                            StackEntry-&gt;Count = Array.<span class="built_in">Num</span>();</span><br><span class="line">                            StackEntry-&gt;ContainerType = GCRT_None;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">const</span> FGCSkipInfo SkipInfo = TokenStream-&gt;<span class="built_in">ReadSkipInfo</span>(TokenStreamIndex);</span><br><span class="line">                            StackEntry-&gt;LoopStartIndex = TokenStreamIndex;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (StackEntry-&gt;Count == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="comment">// è·³è¿‡ç©ºæ•°ç»„</span></span><br><span class="line">                                TokenStreamIndex = SkipInfo.SkipIndex;</span><br><span class="line">                                TokenReturnCount = TokenStream-&gt;<span class="built_in">GetSkipReturnCount</span>(SkipInfo);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="comment">// å†æ¬¡å¾ªç¯</span></span><br><span class="line">                                <span class="built_in">check</span>(StackEntry-&gt;Data);</span><br><span class="line">                                TokenReturnCount = <span class="number">0</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> GCRT_EndOfStream:</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// Break out of loop.</span></span><br><span class="line">                            <span class="keyword">goto</span> EndLoop;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                EndLoop:</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ç¡®ä¿è¯­æ³•åˆ†æå®Œä¹‹åStackEntryå›åˆ°åŸæ¥çš„Stackæ•°ç»„çš„ç¬¬ä¸€ä¸ªä½ç½®</span></span><br><span class="line">                <span class="built_in">check</span>(StackEntry == Stack.<span class="built_in">GetData</span>());</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è¿™é‡Œå…ˆçœç•¥ä¸€ä¸ªå¹¶è¡Œå¤„ç†ï¼Œä¼šåœ¨ä¸‹æ–‡ä¸­åˆ†æ</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¿™é‡Œä¹Ÿçœç•¥ä¸€ä¸ªå¹¶è¡Œå¤„ç†ï¼Œä¼šåœ¨ä¸‹æ–‡ä¸­åˆ†æ</span></span><br><span class="line">            <span class="keyword">if</span> (NewObjectsToSerialize.<span class="built_in">Num</span>())</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ &quot;NewObjectsToSerialize&quot; æ•°ç»„ä¸­æœ‰æ–°åŠ å…¥çš„å…ƒç´ ï¼Œåˆ™å¯¹è°ƒä¸¤ä¸ªæ•°ç»„ï¼Œå°†CurrentIndexç½®ä¸º0ã€‚é‡æ–°å¤„ç† &quot;NewObjectsToSerialize&quot; æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¦‚æ­¤å¾ªç¯ç›´è‡³ &quot;NewObjectsToSerialize&quot; ä¸­æ— æ–°å…ƒç´ (ä¸€èˆ¬æ¥è¯´ æœ€å¤šåªéœ€è¦ä¸¤æ¬¡)</span></span><br><span class="line">				<span class="built_in">Exchange</span>(ObjectsToSerialize, NewObjectsToSerialize);</span><br><span class="line">				NewObjectsToSerialize.<span class="built_in">SetNumUnsafeInternal</span>(<span class="number">0</span>);</span><br><span class="line">				CurrentIndex = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (CurrentIndex &lt; ObjectsToSerialize.<span class="built_in">Num</span>());</span><br><span class="line">        </span><br><span class="line">        ArrayPool.<span class="built_in">ReturnToPool</span>(&amp;NewObjectsToSerializeStruct);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>&quot;ProcessObjectArray&quot; å…¶å®å°±æ˜¯æš´åŠ›éå†ä¼ è¿›æ¥çš„ &quot;ObjectsToSerialize&quot; æ•°ç»„ï¼Œå¹¶é€ä¸ªå¯¹è±¡å¤„ç†å…¶ &quot;UClass&quot; çš„ &quot;ReferenceTokenStream&quot; é‡Œé¢çš„ &quot;Tokens&quot; æ•°ç»„ä¿¡æ¯çš„è¿‡ç¨‹ã€‚&quot;Tokens&quot; æ•°ç»„é‡Œé¢å­˜çš„æ˜¯ &quot;FGCReferenceInfo&quot;ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ä¿¡æ¯ã€‚æˆ‘ä»¬ä¼šæ ¹æ® &quot;ReferenceInfo&quot; çš„ä¸åŒ &quot;Type&quot; ï¼Œæ¥è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚å…¶ä¸­å¯¹äºåµŒå¥—å‹çš„æ•°ç»„ä¼šä½¿ç”¨é€’å½’çš„æ–¹å¼æ¥å¤„ç†å…¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå¯¹äºå…¶ä»–ç±»å‹åˆ™è°ƒç”¨ &quot;HandleTokenStreamObjectReference&quot; æ¥å¯¹å¯¹è±¡å¼•ç”¨åšæœ€åçš„å¤„ç†ã€‚è€Œé‚£ä¹Ÿå°†æ˜¯æˆ‘ä»¬éå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨çš„æœ€åä¸€æ­¥äº†ï¼ˆå½“ç„¶è¿˜æœ‰å¹¶è¡Œå¤„ç† ğŸ˜ƒ</p><h5 id="handletokenstreamobjectreference"><a class="anchor" href="#handletokenstreamobjectreference">#</a> HandleTokenStreamObjectReference</h5><p>è¿™æ˜¯ &quot;ReferenceProcessor&quot; é‡Œé¢ ä½¿ç”¨ &quot;TokenStream&quot; å¤„ç†å¯¹è±¡å¼•ç”¨çš„å‡½æ•°ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨äº† &quot;ReferenceProcessor&quot; å†…éƒ¨çš„ &quot;HandleObjectReference&quot; æ¥å¤„ç†å¯¹è±¡å¼•ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è§£æ &quot;HandleObjectReference&quot;</p><p></p><figure class="highlight c++"><figcaption><span>HandleTokenStreamObjectReference</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">HandleObjectReference</span><span class="params">(TArray&lt;UObject*&gt;&amp; ObjectsToSerialize, <span class="keyword">const</span> UObject * <span class="keyword">const</span> ReferencingObject, UObject*&amp; Object, <span class="keyword">const</span> <span class="keyword">bool</span> bAllowReferenceElimination)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥å¯¹è±¡ä¸ºç©ºæˆ–è€…å¤„äºæ°¸ä¹…å¯¹è±¡æ± ä¸­ï¼Œåˆ™ä¸å¯¹å…¶è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="comment">// æ£€æµ‹æ˜¯å¦å¤„äºå¯¹è±¡æ± çš„æ–¹æ³•æ˜¯ç›´æ¥æ¯”è¾ƒå…¶åœ°å€ï¼Œæ‰€ä»¥æ˜¯éå¸¸å¿«çš„</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> IsInPermanentPool = GUObjectAllocator.<span class="built_in">ResidesInPermanentPool</span>(Object);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(Object == <span class="literal">nullptr</span> || IsInPermanentPool)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> int32 ObjectIndex = GUObjectArray.<span class="built_in">ObjectToIndex</span>(Object);</span><br><span class="line">	FUObjectItem* ObjectItem = GUObjectArray.<span class="built_in">IndexToObjectUnsafeForGC</span>(ObjectIndex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç§»é™¤ &quot;PendingKill&quot; å¯¹è±¡çš„å¼•ç”¨ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥</span></span><br><span class="line">    <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">IsPendingKill</span>() &amp;&amp; bAllowReferenceElimination)</span><br><span class="line">    &#123;</span><br><span class="line">        Object = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†é‡åˆ°çš„å¯¹è±¡å¼•ç”¨æ·»åŠ åˆ° &quot;ObjectToSerialize&quot; åˆ—è¡¨ï¼Œå¦‚æœå…¶è¿˜æœªåœ¨ &quot;ObjectToSerialize&quot; åˆ—è¡¨ä¸­</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(ObjectItem-&gt;<span class="built_in">IsUnreachable</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¹¶è¡Œå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">IsParallel</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å°†å…¶ç½®ä¸ºå¯è¾¾ï¼Œæ­¤æ–¹æ³•ç”¨äºå¤šçº¿ç¨‹ï¼Œé¿å…äºŒæ¬¡æ¸…é™¤å¯¹è±¡æ ‡è®°</span></span><br><span class="line">            <span class="keyword">if</span> (ObjectItem-&gt;<span class="built_in">ThisThreadAtomicallyClearedRFUnreachable</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœè¯¥å¯¹è±¡æ˜¯GCç°‡çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™æ°¸è¿œä¸åº”è¯¥è¢«æ ‡è®°ä¸ºä¸å¯è¾¾ </span></span><br><span class="line">                <span class="built_in">checkSlow</span>(ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>() &lt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">IsWithClusters</span>() || !ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot))</span><br><span class="line">                &#123;</span><br><span class="line">                    ObjectsToSerialize.<span class="built_in">Add</span>(Object);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// å¯¹è±¡ä¸ºç°‡æ ¹æ—¶ï¼Œå°†å…¶å¼•ç”¨çš„æ‰€æœ‰ç°‡æ ‡è®°æœªå¯è¾¾</span></span><br><span class="line">                    <span class="built_in">MarkReferencedClustersAsReachable</span>(ObjectItem-&gt;<span class="built_in">GetClusterIndex</span>(), ObjectsToSerialize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ObjectItem-&gt;<span class="built_in">ClearUnreachable</span>();</span><br><span class="line"></span><br><span class="line">            <span class="built_in">checkSlow</span>(ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>() &lt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">IsWithClusters</span>() || !ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot))</span><br><span class="line">            &#123;</span><br><span class="line">                ObjectsToSerialize.<span class="built_in">Add</span>(Object);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">MarkReferencedClustersAsReachable</span>(ObjectItem-&gt;<span class="built_in">GetClusterIndex</span>(), ObjectsToSerialize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœä½¿ç”¨ç°‡ï¼Œä¸”è¯¥å¯¹è±¡Itemæ²¡æœ‰è¢«æ ‡è®°ä¸ºå¯è¾¾ï¼Œåˆ™éœ€è¦è¿›è¡Œæ ‡è®°</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">IsWithClusters</span>() &amp;&amp; (ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>() &gt; <span class="number">0</span> &amp;&amp; !ObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ReachableInCluster)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">bool</span> bNeedsDoing = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IsParallel</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            bNeedsDoing = ObjectItem-&gt;<span class="built_in">ThisThreadAtomicallySetFlag</span>(EInternalObjectFlags::ReachableInCluster);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ObjectItem-&gt;<span class="built_in">SetFlags</span>(EInternalObjectFlags::ReachableInCluster);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bNeedsDoing)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ç¡®ä¿ç°‡æ ¹å¯¹è±¡ä¹Ÿè¢«æ ‡è®°ä¸ºå¯è¾¾</span></span><br><span class="line">            <span class="keyword">const</span> int32 OwnerIndex = ObjectItem-&gt;<span class="built_in">GetOwnerIndex</span>();</span><br><span class="line">            FUObjectItem* RootObjectItem = GUObjectArray.<span class="built_in">IndexToObjectUnsafeForGC</span>(OwnerIndex);</span><br><span class="line">            <span class="built_in">checkSlow</span>(RootObjectItem-&gt;<span class="built_in">HasAnyFlags</span>(EInternalObjectFlags::ClusterRoot));</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IsParallel</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (RootObjectItem-&gt;<span class="built_in">ThisThreadAtomicallyClearedRFUnreachable</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// ç¡®ä¿æ‰€æœ‰è¢«å¼•ç”¨çš„ç°‡éƒ½è¢«æ ‡è®°ä¸ºå¯è¾¾</span></span><br><span class="line">                    <span class="built_in">MarkReferencedClustersAsReachable</span>(RootObjectItem-&gt;<span class="built_in">GetClusterIndex</span>(), ObjectsToSerialize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (RootObjectItem-&gt;<span class="built_in">IsUnreachable</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                RootObjectItem-&gt;<span class="built_in">ClearFlags</span>(EInternalObjectFlags::Unreachable);</span><br><span class="line">                <span class="built_in">MarkReferencedClustersAsReachable</span>(RootObjectItem-&gt;<span class="built_in">GetClusterIndex</span>(), ObjectsToSerialize);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ€»çš„æ¥è¯´ï¼Œ&quot;HandleObjectReference&quot; å°±æ˜¯åœ¨ç»™ Objects ä¸Šæ ‡è®°ï¼ˆæœ€åä¸€æ­¥å°±è¿™ï¼Ÿæ˜¯çš„ï¼Œå°±è¿™......</p><p>å’± &quot;éå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨&quot; åˆ°è¿™é‡Œç®—æ˜¯å®Œç»“äº†ï¼Œæ¥ä¸‹æ¥<a href="#CollectReferences">å›å»</a>çœ‹çœ‹å¹¶è¡Œå¤„ç†æ˜¯æ€ä¹ˆåšçš„å§ ğŸ˜ƒ</p><h4 id="fcollectortaskprocessortask-å¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨"><a class="anchor" href="#fcollectortaskprocessortask-å¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨">#</a> FCollectorTaskProcessorTask | å¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨</h4><p>åœ¨ &quot;CollectReferences&quot; å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼šå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨æ˜¯é€šè¿‡å¾€ &quot;TaskQueue&quot; ä¸­æ·»åŠ ä»»åŠ¡åï¼Œå†æŠŠ &quot;TaskQueue&quot; ä¸­çš„ä»»åŠ¡åˆ†é…ç»™ ChunkTasks çš„ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦è§£å†³çš„é—®é¢˜æœ‰ä¸¤ä¸ªï¼š</p><ul><li>&quot;TaskQueue&quot; æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå…¶ &quot;AddTask&quot; é‡Œé¢å¹²äº†ä»€ä¹ˆã€‚</li><li>ChunkTasks.Add é‡Œé¢åˆå§‹åŒ–çš„ &quot;TGraphTask&quot; æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œæ€ä¹ˆåˆå§‹åŒ–çš„ï¼Œåˆå§‹åŒ–ä¹‹ååˆæ˜¯æ€ä¹ˆå¼€å§‹è¿è¡Œçš„ï¼Œè¿è¡Œçš„åˆæ˜¯ä»€ä¹ˆä»£ç </li></ul><h5 id="taskqueue"><a class="anchor" href="#taskqueue">#</a> TaskQueue</h5><p></p><figure class="highlight c++"><figcaption><span>TaskQueue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FastReferenceColletor.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FCollectorTaskQueue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TFastReferenceCollector* Owner;</span><br><span class="line">    ArrayPoolType&amp; ArrayPool;</span><br><span class="line">    TLockFreePointerListUnordered&lt;FGCArrayStruct, PLATFORM_CACHE_LINE_SIZE&gt; Tasks;</span><br><span class="line"></span><br><span class="line">    FCriticalSection WaitingThreadsLock;</span><br><span class="line">    TArray&lt;FEvent*&gt; WaitingThreads;</span><br><span class="line">    <span class="keyword">bool</span> bDone;</span><br><span class="line">    int32 NumThreadsStarted; </span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">FCollectorTaskQueue</span>(TFastReferenceCollector* InOwner, ArrayPoolType&amp; InArrayPool)</span><br><span class="line">        : <span class="built_in">Owner</span>(InOwner)</span><br><span class="line">        , <span class="built_in">ArrayPool</span>(InArrayPool)</span><br><span class="line">        , <span class="built_in">bDone</span>(<span class="literal">false</span>)</span><br><span class="line">        , <span class="built_in">NumThreadsStarted</span>(<span class="number">0</span>)</span><br><span class="line">    &#123; &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CheakDone</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">   	<span class="function">FORCENOINLINE <span class="keyword">void</span> <span class="title">AddTask</span><span class="params">(<span class="keyword">const</span> TArray&lt;UObject*&gt;* InObjectsToSerialize, int32 StartIndex, int32 NumObjects)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        FGCArrayStruct* ArrayStruct = ArrayPool.<span class="built_in">GetArrayStructFromPool</span>();</span><br><span class="line">        ArrayStruct-&gt;ObjectsToSerialize.<span class="built_in">AddUninitialized</span>(NumObjects);</span><br><span class="line">        FMemory::<span class="built_in">Memcpy</span>(ArrayStruct-&gt;ObjectsToSerialize.<span class="built_in">GetData</span>(), InObjectsToSerialize-&gt;<span class="built_in">GetData</span>() + StartIndex, NumObjects * <span class="built_in"><span class="keyword">sizeof</span></span>(UObject*));</span><br><span class="line">        <span class="comment">// &quot;Tasks&quot; æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå­˜çš„æ˜¯ &quot;FGCArrayStruct&quot; ç±»å‹çš„å…ƒç´ </span></span><br><span class="line">        Tasks.<span class="built_in">Push</span>(ArrayStruct);</span><br><span class="line"></span><br><span class="line">        FEvent* WaitingThread = <span class="literal">nullptr</span>;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// åˆ†é…çº¿ç¨‹è¦å…ˆä¸Šé”</span></span><br><span class="line">            <span class="function">FScopeLock <span class="title">Lock</span><span class="params">(&amp;WaitingThreadsLock)</span></span>;</span><br><span class="line">            <span class="built_in">check</span>(!bDone);</span><br><span class="line">            <span class="keyword">if</span> (WaitingThreads.<span class="built_in">Num</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                WaitingThread = WaitingThreads.<span class="built_in">Pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (WaitingThread)</span><br><span class="line">        &#123;</span><br><span class="line">            WaitingThread-&gt;<span class="built_in">Trigger</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç•™åˆ°ä¸‹é¢åˆ†æ</span></span><br><span class="line">    <span class="function">FORCENOINLINE <span class="keyword">void</span> <span class="title">DoTask</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»£ç ä¸éš¾ï¼Œå°±æ˜¯å¾€ &quot;Tasks&quot; åˆ—è¡¨é‡Œé¢æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå› ä¸ºæˆ‘ä»¬å½“å‰çš„ &quot;WaitingThreads&quot; æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ²¡æœ‰æ¿€æ´»ç­‰å¾…çº¿ç¨‹ã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ &quot;TGraphTask&quot; å’Œ &quot;FCollectorTaskProcessorTask&quot; ä¸¤ä¸ªç±»çš„è§£æã€‚</p><h5 id="tgraphtask"><a class="anchor" href="#tgraphtask">#</a> TGraphTask</h5><p></p><figure class="highlight c++"><figcaption><span>TGraphTask</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TaskGraphInterfaces.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> TTask&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TGraphTask</span> <span class="keyword">final</span> :</span> <span class="keyword">public</span> FBaseGraphTask</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">FConstructor</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="comment">/** æ„é€ ä»»åŠ¡å¹¶åˆ†é…å‚æ•°çš„æ¨¡æ¿å‡½æ•°ã€‚æ³¨æ„ï¼šå‚æ•°ä¸å¯ä»¥ä¸ºå¼•ç”¨ï¼Œåº”ä½¿ç”¨æŒ‡é’ˆ */</span></span><br><span class="line">		<span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>...T&gt;</span></span><br><span class="line"><span class="function">		FGraphEventRef <span class="title">ConstructAndDispatchWhenReady</span><span class="params">(T&amp;&amp;... Args)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">new</span> ((<span class="keyword">void</span> *)&amp;Owner-&gt;TaskStorage) <span class="built_in">TTask</span>(Forward&lt;T&gt;(Args)...);</span><br><span class="line">			<span class="keyword">return</span> Owner-&gt;<span class="built_in">Setup</span>(Prerequisites, CurrentThreadIfKnown);</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">FConstructor</span>(TGraphTask* InOwner, <span class="keyword">const</span> FGraphEventArray* InPrerequisites, ENamedThreads::Type InCurrentThreadIfKnown)</span><br><span class="line">			: <span class="built_in">Owner</span>(InOwner)</span><br><span class="line">			, <span class="built_in">Prerequisites</span>(InPrerequisites)</span><br><span class="line">			, <span class="built_in">CurrentThreadIfKnown</span>(InCurrentThreadIfKnown)</span><br><span class="line">		&#123; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä»»åŠ¡çš„å·¥å‚ï¼Œè¿”å›è¾…åŠ©å¯¹è±¡ä»¥æ„é€ åµŒå…¥å¼ä»»åŠ¡å¹¶å°†å…¶è®¾ç½®ä¸ºæ‰§è¡Œã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> FConstructor <span class="title">CreateTask</span><span class="params">(<span class="keyword">const</span> FGraphEventArray* Prerequisites = <span class="literal">NULL</span>, ENamedThreads::Type CurrentThreadIfKnown = ENamedThreads::AnyThread)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        int32 NumPrereq = Prerequisites ? Prerequisites-&gt;<span class="built_in">Num</span>() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in"><span class="keyword">sizeof</span></span>(TGraphTask) &lt;= FBaseGraphTask::SMALL_TASK_SIZE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">void</span> *Mem = FBaseGraphTask::<span class="built_in">GetSmallTaskAllocator</span>().<span class="built_in">Allocate</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">FConstructor</span>(<span class="built_in"><span class="keyword">new</span></span> (Mem) <span class="built_in">TGraphTask</span>(TTask::<span class="built_in">GetSubsequentsMode</span>() == ESubsequentsMode::FireAndForget ? <span class="literal">NULL</span> : FGraphEvent::<span class="built_in">CreateGraphEvent</span>(), NumPrereq), Prerequisites, CurrentThreadIfKnown);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">FConstructor</span>(<span class="keyword">new</span> <span class="built_in">TGraphTask</span>(TTask::<span class="built_in">GetSubsequentsMode</span>() == ESubsequentsMode::FireAndForget ? <span class="literal">NULL</span> : FGraphEvent::<span class="built_in">CreateGraphEvent</span>(), NumPrereq), Prerequisites, CurrentThreadIfKnown);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// TGraphTaskçš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="built_in">TGraphTask</span>(FGraphEventRef InSubsequents, int32 NumberOfPrerequistitesOutstanding)</span><br><span class="line">        : <span class="built_in">FBaseGraphTask</span>(NumberOfPrerequistitesOutstanding)</span><br><span class="line">        , <span class="built_in">TaskConstructed</span>(<span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Subsequents.<span class="built_in">Swap</span>(InSubsequents);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FCollectorTaskProcessorTask</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ESubsequentsMode::Type <span class="title">GetSubsequentsMode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ESubsequentsMode::TrackSubsequents;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ä¸‹ä»£ç åªæ˜¯åœ¨åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ &quot;FGraphEvent&quot;ï¼Œä¸å±•å¼€è¯´æ˜</span></span><br><span class="line"><span class="keyword">static</span> TLockFreeClassAllocator_TLSCache&lt;FGraphEvent, PLATFORM_CACHE_LINE_SIZE&gt; TheGraphEventAllocator;</span><br><span class="line"></span><br><span class="line"><span class="function">FGraphEventRef <span class="title">FGraphEvent::CreateGraphEvent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> TheGraphEventAllocator.<span class="built_in">New</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">int</span> <span class="title">TPaddingForCacheContention</span>, <span class="title">bool</span> <span class="title">AllowDisablingOfTrim</span> =</span> <span class="literal">false</span>&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TLockFreeClassAllocator_TLSCache</span> :</span> <span class="keyword">private</span> TLockFreeFixedSizeAllocator_TLSCache&lt;<span class="built_in"><span class="keyword">sizeof</span></span>(T), TPaddingForCacheContention, FNoopCounter , AllowDisablingOfTrim&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// è¿”å›ä¸€å—sizeof(T)çš„å†…å­˜</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span>* <span class="title">Allocate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> TLockFreeFixedSizeAllocator_TLSCache&lt;<span class="built_in"><span class="keyword">sizeof</span></span>(T), TPaddingForCacheContention&gt;::<span class="built_in">Allocate</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨é»˜è®¤æ„é€ å‡½æ•°newä¸€ä¸ªTï¼Œå¹¶è¿”å›</span></span><br><span class="line">	<span class="function">T* <span class="title">New</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in"><span class="keyword">new</span></span> (<span class="built_in">Allocate</span>()) <span class="built_in">T</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™æ®µä»£ç ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯åœ¨åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª &quot;FGraphEventRef&quot;ã€‚å…·ä½“æµç¨‹æ˜¯ï¼šå…ˆè°ƒç”¨ &quot;TGraphTask&quot; çš„é™æ€æ–¹æ³• &quot;CreateTask&quot; åˆå§‹åŒ–ä¸€ä¸ª &quot;FContructor&quot; (è¾…åŠ©æ„é€ å™¨)ï¼Œç„¶åè°ƒç”¨è¿™ä¸ª &quot;FConstructor&quot; çš„ &quot;ConstructAndDispatchWhenReady&quot; è¿”å›ä¸€ä¸ªåˆå§‹åŒ–å¥½çš„ &quot;FGraphEventRef&quot; (ä»»åŠ¡åˆ—è¡¨çš„å¼•ç”¨è®¡æ•°æŒ‡é’ˆ)ï¼Œå¹¶å°†å…¶ &quot;Setup&quot; (ä¸ºè¯¥ä»»åŠ¡è®¾ç½®æ‰§è¡Œçº¿ç¨‹ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºå°±ç»ªçŠ¶æ€ï¼Œå³åªè¦å…ˆå†³ä»»åŠ¡å°±ç»ªï¼Œåˆ™ç«‹åˆ»è¿è¡Œè¯¥çº¿ç¨‹ã€‚è¿™é‡Œçš„å…ˆå†³ä»»åŠ¡ä¸º NULLï¼Œæ‰€ä»¥ç›´æ¥è¿è¡Œ)</p><p>å¥½äº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å’±çš„ &quot;FCollectorTaskProcessorTask&quot; é‡Œé¢éƒ½åšäº†ä»€ä¹ˆå§ï½ï½ï½</p><h5 id="fcollectortaskprocessortask"><a class="anchor" href="#fcollectortaskprocessortask">#</a> FCollectorTaskProcessorTask</h5><p>å¼€å§‹è§£æä¹‹å‰ï¼Œè¦å…ˆè§£é‡Š &quot;FGenericTask&quot; çš„æ¦‚å¿µã€‚&quot;FGenericTask&quot; æ˜¯ &quot;TGraphTask&quot; çš„æ¨¡æ¿ç±» &quot;TTask&quot; å¿…é¡»æ¨¡æ‹Ÿå®ç°çš„ç»“æ„ã€‚æºç ä¾‹å­å¦‚ä¸‹ï¼š</p><p><img data-src="FGenericTask.png" alt="FGenericTask"></p><p>è€Œæˆ‘ä»¬çš„ &quot;FCollectorTaskProcessorTask&quot; å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª TTaskï¼Œæ‰€ä»¥ä¹Ÿå¿…é¡»æ»¡è¶³è¿™ä¸ªç±»ç»“æ„ã€‚ä»¥ä¸‹åªå¯¹å…¶ &quot;DoTask&quot; å‡½æ•°è¿›è¡Œè§£æï¼ˆ&quot;DoTask&quot; å‡½æ•°ä¼šåœ¨å…¶çº¿ç¨‹è¿è¡Œæ—¶è¢« &quot;TGraphTask&quot; çš„ &quot;ExecuteTask&quot; è°ƒç”¨ï¼Œè¿™é‡Œä¸åšå±•å¼€ï¼‰</p><p></p><figure class="highlight c++"><figcaption><span>FCollectorTaskProcessorTask</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FastReferenceCollector.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FCollectorTaskProcessorTask</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DoTask</span><span class="params">(ENamedThreads::Type CurrentThread, FGraphEventRef&amp; MyCompletionGraphEvent)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        TaskQueue.<span class="built_in">DoTask</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FCollectorTaskQueue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function">FORCENOINLINE <span class="keyword">void</span> <span class="title">DoTask</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">FScopeLock <span class="title">Lock</span><span class="params">(&amp;WaitingThreadsLock)</span></span>;</span><br><span class="line">            <span class="keyword">if</span> (bDone)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            NumThreadsStarted++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ç›´è‡³æ‰€æœ‰çš„ &quot;Tasks&quot; éƒ½è¢« &quot;Pop&quot; ä¸” æ‰§è¡Œå®Œåï¼Œæ‰ä¼šæ·»åŠ å¹¶æ¿€æ´»æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            FGCArrayStruct* ArrayStruct = Tasks.<span class="built_in">Pop</span>();</span><br><span class="line">            <span class="keyword">while</span> (!ArrayStruct)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (bDone)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                FEvent* WaitEvent = <span class="literal">nullptr</span>;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="function">FScopeLock <span class="title">Lock</span><span class="params">(&amp;WaitingThreadsLock)</span></span>;</span><br><span class="line">                    <span class="keyword">if</span> (bDone)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ArrayStruct = Tasks.<span class="built_in">Pop</span>();</span><br><span class="line">                    <span class="keyword">if</span> (!ArrayStruct)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (WaitingThreads.<span class="built_in">Num</span>() + <span class="number">1</span> == NumThreadsStarted)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// å”¯ä¸€èƒ½é€€å‡ºå¾ªç¯çš„å‡ºå£</span></span><br><span class="line">                            bDone = <span class="literal">true</span>;</span><br><span class="line">                            FPlatformMisc::<span class="built_in">MemoryBarrier</span>();</span><br><span class="line">                            <span class="keyword">for</span> (FEvent* WaitingThread : WaitingThreads)</span><br><span class="line">                            &#123;</span><br><span class="line">                                WaitingThread-&gt;<span class="built_in">Trigger</span>();</span><br><span class="line">                            &#125;</span><br><span class="line">                            WaitingThreads.<span class="built_in">Empty</span>();</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            WaitEvent = FPlatformProcess::<span class="built_in">GetSynchEventFromPool</span>(<span class="literal">false</span>);</span><br><span class="line">                            WaitingThreads.<span class="built_in">Push</span>(WaitEvent);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ArrayStruct)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">check</span>(!WaitEvent);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">check</span>(WaitEvent);</span><br><span class="line">                    WaitEvent-&gt;<span class="built_in">Wait</span>();</span><br><span class="line">                    FPlatformProcess::<span class="built_in">ReturnSynchEventToPool</span>(WaitEvent);</span><br><span class="line">                    ArrayStruct = Tasks.<span class="built_in">Pop</span>();</span><br><span class="line">                    <span class="built_in">check</span>(!ArrayStruct || !bDone);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Owner-&gt;<span class="built_in">ProcessObjectArray</span>(*ArrayStruct, <span class="built_in">FGraphEventRef</span>());</span><br><span class="line">            </span><br><span class="line">            ArrayPool.<span class="built_in">ReturnToPool</span>(ArrayStruct);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä»¥ä¸‹åˆ†æéœ€è¦è¯»è€…æœ‰ä¸€å®šçš„å¤šçº¿ç¨‹åŸºç¡€ã€‚</p><p>è¿™é‡Œçš„ &quot;NumThreadsStarted&quot; æŒ‡å½“å‰è¿è¡Œè¯¥å‡½æ•°çš„çº¿ç¨‹æ•°ã€‚&quot;while (true)&quot; ç¨‹åºå—é‡Œé¢æ¯æ¬¡ &quot;Pop&quot; ä¸€ä¸ª &quot;ArrayStruct&quot; ç”¨äºæ‰§è¡Œä¸‹é¢çš„ &quot;ProcessObjectArray&quot;ï¼Œæ‰§è¡Œå®Œåå°†å…¶è¿”å›æ•°ç»„æ± ä¸­ã€‚ä¸‹æ–‡ä¼šå¯¹ &quot;ProcessObjectArray&quot; çš„å¹¶è¡Œå¤„ç†åšè¿›ä¸€æ­¥çš„åˆ†æã€‚å½“ &quot;Tasks&quot; é‡Œé¢çš„ &quot;ArrayStruct&quot; éƒ½ç”¨å®Œçš„æ—¶å€™ï¼Œå°±ä¼šè¿›åˆ° &quot;while (!ArrayStruct)&quot; ç¨‹åºå—ï¼Œè¯¥ç¨‹åºå—ä¼šå¾€ &quot;WaitingThreads&quot; æ•°ç»„é‡Œé¢åˆ›å»ºç­‰å¾…çº¿ç¨‹ï¼Œå¹¶åœ¨ç­‰å¾…çº¿ç¨‹çš„æ•°é‡åˆ°è¾¾ &quot;NumThreadStarted - 1&quot; æ—¶ï¼Œå°† &quot;dDone&quot; è®¾ä¸º true (æ„å‘³ç€ä¸å†æ¥å—çº¿ç¨‹è¿è¡Œæ­¤å‡½æ•°ï¼Œä¹Ÿä¸å†åˆ›å»ºç­‰å¾…çº¿ç¨‹)ï¼Œå¹¶æ¿€æ´»æ‰€æœ‰ &quot;WaitingThreads&quot; æ•°ç»„ä¸­çš„ç­‰å¾…çº¿ç¨‹ï¼Œæ¸…ç©º &quot;WaitingThreads&quot; æ•°ç»„ ä»¥å¾…ä¸‹æ¬¡ä½¿ç”¨ã€‚</p><p></p><figure class="highlight c++"><figcaption><span>ProcessObjectArray</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FastReferenceCollector.h</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProcessObjectArray</span><span class="params">(FGCArrayStruct&amp; InObjectsToSerializeStruct, <span class="keyword">const</span> FGraphEventRef&amp; MyCompletionGraphEvent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...... å‰é¢çš„ä»£ç ä¸Šæ–‡åˆ†æè¿‡äº†ï¼Œä¸åšèµ˜è¿°ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">CollectorType <span class="title">ReferenceCollector</span><span class="params">(ReferenceProcessor, NewObjectsToSerializeStruct)</span></span>;</span><br><span class="line">        <span class="keyword">while</span> (CurrentIndex &lt; ObjectsToSerialize.<span class="built_in">Num</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ...... å·²åˆ†æï¼Œä¸åšèµ˜è¿°</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">check</span>(StackEntry == Stack.<span class="built_in">GetData</span>());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰å¤„äºå¹¶è¡Œå¤„ç†ï¼Œä¸” &quot;NewObjectsToSerialize&quot; æ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°è¶³ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¹¶è¡Œä»»åŠ¡ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ° &quot;TaskQueue&quot; é‡Œé¢ï¼Œ&quot;TaskQueue&quot; é‡Œé¢çš„ä»»åŠ¡ä¼šè‡ªåŠ¨è¢«å·¥ä½œçº¿ç¨‹å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IsParallel</span>() &amp;&amp; NewObjectsToSerialize.<span class="built_in">Num</span>() &gt;= MinDesiredObjectsPerSubTask)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">const</span> int32 ObjectsPerSubTask = FMath::Max&lt;int32&gt;(MinDesiredObjectsPerSubTask, NewObjectsToSerialize.<span class="built_in">Num</span>() / FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">GetNumWorkerThreads</span>());</span><br><span class="line">                <span class="keyword">while</span> (NewObjectsToSerialize.<span class="built_in">Num</span>() &gt;= MinDesiredObjectsPerSubTask)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">const</span> int32 StartIndex = FMath::<span class="built_in">Max</span>(<span class="number">0</span>, NewObjectsToSerialize.<span class="built_in">Num</span>() - ObjectsPerSubTask);</span><br><span class="line">                    <span class="keyword">const</span> int32 NumThisTask = NewObjectsToSerialize.<span class="built_in">Num</span>() - StartIndex;</span><br><span class="line">                    <span class="keyword">if</span> (MyCompletionGraphEvent.<span class="built_in">GetReference</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        MyCompletionGraphEvent-&gt;<span class="built_in">DontCompleteUntil</span>(TGraphTask&lt; FCollectorTask &gt;::<span class="built_in">CreateTask</span>().<span class="built_in">ConstructAndDispatchWhenReady</span>(<span class="keyword">this</span>, &amp;NewObjectsToSerialize, StartIndex, NumThisTask, ArrayPool));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        TaskQueue.<span class="built_in">AddTask</span>(&amp;NewObjectsToSerialize, StartIndex, NumThisTask);</span><br><span class="line">                    &#125;</span><br><span class="line">                    NewObjectsToSerialize.<span class="built_in">SetNumUnsafeInternal</span>(StartIndex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å’Œä¸Šé¢çš„å¤„ç†ç±»ä¼¼</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">IsParallel</span>() &amp;&amp; NewObjectsToSerialize.<span class="built_in">Num</span>() &gt;= MinDesiredObjectsPerSubTask)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> int32 ObjectsPerSubTask = FMath::Max&lt;int32&gt;(MinDesiredObjectsPerSubTask, NewObjectsToSerialize.<span class="built_in">Num</span>() / FTaskGraphInterface::<span class="built_in">Get</span>().<span class="built_in">GetNumWorkerThreads</span>());</span><br><span class="line">            int32 StartIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (StartIndex &lt; NewObjectsToSerialize.<span class="built_in">Num</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">const</span> int32 NumThisTask = FMath::Min&lt;int32&gt;(ObjectsPerSubTask, NewObjectsToSerialize.<span class="built_in">Num</span>() - StartIndex);</span><br><span class="line">                <span class="keyword">if</span> (MyCompletionGraphEvent.<span class="built_in">GetReference</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    MyCompletionGraphEvent-&gt;<span class="built_in">DontCompleteUntil</span>(TGraphTask&lt; FCollectorTask &gt;::<span class="built_in">CreateTask</span>().<span class="built_in">ConstructAndDispatchWhenReady</span>(<span class="keyword">this</span>, &amp;NewObjectsToSerialize, StartIndex, NumThisTask, ArrayPool));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    TaskQueue.<span class="built_in">AddTask</span>(&amp;NewObjectsToSerialize, StartIndex, NumThisTask);</span><br><span class="line">                &#125;</span><br><span class="line">                StartIndex += NumThisTask;</span><br><span class="line">            &#125;</span><br><span class="line">            NewObjectsToSerialize.<span class="built_in">SetNumUnsafeInternal</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// ä¸å¤Ÿåˆ›å»ºæ–°ä»»åŠ¡åˆ™å’Œéå¹¶è¡Œå¤„ç†ä¸€æ ·ï¼Œäº¤äº’è¿ä¸ªæ•°ç»„åï¼Œæ¸…ç©º &quot;NewObjectsToSerialize&quot;ï¼Œå†è¿›è¡Œå¤–å±‚ &quot;while&quot; å¾ªç¯</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (NewObjectsToSerialize.<span class="built_in">Num</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">Exchange</span>(ObjectsToSerialize, NewObjectsToSerialize);</span><br><span class="line">            NewObjectsToSerialize.<span class="built_in">SetNumUnsafeInternal</span>(<span class="number">0</span>);</span><br><span class="line">			CurrentIndex = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (CurrentIndex &lt; ObjectsToSerialize.<span class="built_in">Num</span>());</span><br><span class="line">    </span><br><span class="line">    ArrayPool.<span class="built_in">ReturnToPool</span>(&amp;NewObjectsToSerializeStruct);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ°è¿™é‡Œï¼Œå¯¹è±¡å¼•ç”¨çš„å¹¶è¡Œå¤„ç†ä¹Ÿå°±åˆ†æå®Œäº†ã€‚æ€»çš„æ¥è¯´å°±æ˜¯å…ˆå†™å¥½ä¸€ä¸ªæ¨¡æ¿ä»»åŠ¡ &quot;TTask&quot; (ä¸»è¦æ˜¯ &quot;AddTask&quot; å’Œ &quot;DoTask&quot; å‡½æ•°çš„ç¼–å†™)ï¼Œç„¶åå£°æ˜ä¸€ä¸ªè¯¥æ¨¡æ¿ä»»åŠ¡çš„ &quot;TaskQueue&quot;ï¼Œæœ€åç›´æ¥è°ƒç”¨å¼•æ“ä¸­ &quot;TGraphTask&quot; æä¾›çš„ APIï¼Œå°±å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆé€šè¿‡ &quot;AddTask&quot; åŠ å…¥åˆ° &quot;TaskQueue&quot; çš„ä»»åŠ¡äº†ï¼ˆè¿™ä¹Ÿæ˜¯å¹¶è¡Œå¤„ç†çš„å…¶ä¸­ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼‰</p><p>okï¼Œ&quot;å¯è¾¾æ€§åˆ†æ&quot; åˆ°è¿™é‡Œå¯ä»¥å®Œç¾è½å¹•äº†ï¼Œè®ºåˆ°å’±çš„ &quot;å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡&quot; ä¸Šåœºäº† ğŸ˜ƒ</p><hr><h3 id="å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡a-idå¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡a"><a class="anchor" href="#å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡a-idå¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡a">#</a> å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡ &lt;a id=&quot;å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡&quot;&gt;&lt;/a&gt;</h3><h5 id="incrementalpurgegarbage"><a class="anchor" href="#incrementalpurgegarbage">#</a> IncrementalPurgeGarbage</h5><p></p><figure class="highlight c++"><figcaption><span>IncrementalPurgeGarbage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">IncrementalPurgeGarbage</span><span class="params">(<span class="keyword">bool</span> bUseTimeLimit, <span class="keyword">float</span> TimeLimit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å­˜åœ¨éœ€è¦æ¸…é™¤çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (GExitPurge)</span><br><span class="line">	&#123;</span><br><span class="line">		GObjPurgeIsRequired = <span class="literal">true</span>;		<span class="comment">// éœ€è¦è¿›è¡Œå¯¹è±¡æ¸…é™¤</span></span><br><span class="line">		GUObjectArray.<span class="built_in">DisableDisregardForGC</span>();		<span class="comment">// ç¦æ­¢å¿½ç•¥GC</span></span><br><span class="line">		GObjCurrentPurgeObjectIndexNeedsReset = <span class="literal">true</span>;		<span class="comment">// é‡ç½®å½“å‰æ¸…é™¤å¯¹è±¡ç´¢å¼•</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ä¸éœ€è¦å¯¹è±¡æ¸…é™¤åˆ™è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> (!GObjPurgeIsRequired)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bCompleted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…åµŒç»“æ„ä½“å¹¶è¿›è¡Œæ„é€  (å‡½æ•°æ‰§è¡Œç»“æŸæ—¶ä¼šè‡ªåŠ¨ææ„)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">FResetPurgeProgress</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="keyword">bool</span>&amp; bCompletedRef;</span><br><span class="line">		<span class="built_in">FResetPurgeProgress</span>(<span class="keyword">bool</span>&amp; bInCompletedRef)</span><br><span class="line">			: <span class="built_in">bCompletedRef</span>(bInCompletedRef)</span><br><span class="line">		&#123;</span><br><span class="line">			GObjIncrementalPurgeIsInProgress = <span class="literal">true</span>;	<span class="comment">// æ ‡è®° ç¨‹åºå½“å‰æ­£åœ¨è¿›è¡Œå¢é‡æ¸…é™¤</span></span><br><span class="line">			FPlatformMisc::<span class="built_in">MemoryBarrier</span>();		<span class="comment">// å†…å­˜å±éšœ</span></span><br><span class="line">		&#125;</span><br><span class="line">		~<span class="built_in">FResetPurgeProgress</span>()</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (bCompletedRef)</span><br><span class="line">			&#123;</span><br><span class="line">				GObjIncrementalPurgeIsInProgress = <span class="literal">false</span>;	<span class="comment">// æ ‡è®° ç¨‹åºå½“å‰å·²é€€å‡ºå¢é‡æ¸…é™¤</span></span><br><span class="line">				FPlatformMisc::<span class="built_in">MemoryBarrier</span>();		<span class="comment">// å†…å­˜å±éšœ</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="built_in">ResetPurgeProgress</span>(bCompleted);</span><br><span class="line">	</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// åœ¨è®¾ç½® &quot;GCStartTime&quot; ä¹‹å‰ä¸Šé”ï¼Œå› ä¸ºå¦‚æœæ­£åœ¨è¿›è¡Œå¼‚æ­¥åŠ è½½ï¼Œåˆ™ä¸Šé”å¯èƒ½ä¼šå˜å¾—å¾ˆæ…¢</span></span><br><span class="line">        <span class="comment">// ä½†æˆ‘ä»¬ä»ç„¶å¸Œæœ›æ‰§è¡Œä¸€äº›GCå·¥ä½œï¼Œå¦åˆ™æˆ‘ä»¬å°†åœ¨å†…å­˜ä¸­ä¿ç•™å¯¹è±¡å¾ˆé•¿ä¸€æ®µæ—¶é—´</span></span><br><span class="line">		FConditionalGCLock ScopedGCLock;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·Ÿè¸ªå¼€å§‹æ—¶é—´ä»¥å¯¹å¢é‡æ¸…é™¤è¿›è¡Œæ—¶é—´é™åˆ¶ (å¦‚æœbForceFullPurgeä¸ºçœŸï¼Œåˆ™æ²¡æœ‰æ—¶é—´é™åˆ¶)</span></span><br><span class="line">		GCStartTime = FPlatformTime::<span class="built_in">Seconds</span>();</span><br><span class="line">		<span class="keyword">bool</span> bTimeLimitReached = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GUnrechableObjectIndex &lt; GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// åœ¨ObjectHashTablesä¸­æ³¨é”€ä¸å¯è¾¾å¯¹è±¡ï¼Œå‡½æ•°åˆ†æè¯¦è§ä¸‹æ–‡</span></span><br><span class="line">			bTimeLimitReached = <span class="built_in">UnhashUnreachableObjects</span>(bUseTimeLimit, TimeLimit);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (GUnrechableObjectIndex &gt;= GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">// ä¸€ä¸ªç©ºå‡½æ•°</span></span><br><span class="line">				FScopedCBDProfile::<span class="built_in">DumpProfile</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!bTimeLimitReached)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// å¢é‡é”€æ¯ä¸å¯è¾¾å¯¹è±¡ï¼Œé‡è¦ï¼è¯¦è§ä¸‹æ–‡</span></span><br><span class="line">			bCompleted = <span class="built_in">IncrementalDestroyGarbage</span>(bUseTimeLimit, TimeLimit);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="unhashunreachableobjects"><a class="anchor" href="#unhashunreachableobjects">#</a> UnhashUnreachableObjects</h5><p></p><figure class="highlight c++"><figcaption><span>UnhashUnreachableObjects</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UnhashUnreachableObjects</span><span class="params">(<span class="keyword">bool</span> bUseTimeLimit, <span class="keyword">float</span> TimeLimit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// &quot;TGuardValue&quot; æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç”¨äºæ•°æ®å›æ¡£ã€‚è¯¥ç±»å¯¹è±¡åœ¨æ„é€ æ—¶ä¼šè¿›è¡Œä¸€æ¬¡èµ‹å€¼æ“ä½œ(å°†ç¬¬äºŒä¸ªå‚æ•°çš„å€¼èµ‹å€¼ç»™ç¬¬ä¸€ä¸ªå‚æ•°)ã€‚è€Œææ„æ—¶ï¼Œä¼šå°†åŸæ¥çš„å€¼é‡æ–°èµ‹å€¼ç»™ç¬¬ä¸€ä¸ªå‚æ•°(ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¼•ç”¨ç±»å‹ï¼Œç¬¬äºŒä¸ªæ˜¯constå€¼ç±»å‹)</span></span><br><span class="line">	<span class="function">TGuardValue&lt;<span class="keyword">bool</span>&gt; <span class="title">GuardObjUnhashUnreachableIsInProgress</span><span class="params">(GObjUnhashUnreachableIsInProgress, <span class="literal">true</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	FCoreUObjectDelegates::PreGarbageCollectConditionalBeginDestroy.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åå“ˆå¸Œæ‰€æœ‰ä¸å¯è¾¾å¯¹è±¡</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">double</span> StartTime = FPlatformTime::<span class="built_in">Seconds</span>();</span><br><span class="line">	<span class="keyword">const</span> int32 TimeLimitEnforcementGranularityForBeginDestroy = <span class="number">10</span>;</span><br><span class="line">	int32 TimePollCounter = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> bFirstIteration = (GUnrechableObjectIndex == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &quot;GUnreachableObjects&quot; åœ¨å¯è¾¾æ€§åˆ†æåï¼Œå¢é‡æ¸…é™¤å‰çš„ &quot;GatherUnreachableObjects&quot; å‡½æ•°ä¸­è¢«èµ‹å€¼</span></span><br><span class="line">	<span class="keyword">while</span> (GUnrechableObjectIndex &lt; GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		FUObjectItem* ObjectItem = GUnreachableObjects[GUnrechableObjectIndex++];</span><br><span class="line">		&#123;</span><br><span class="line">			UObject* Object = <span class="keyword">static_cast</span>&lt;UObject*&gt;(ObjectItem-&gt;Object);</span><br><span class="line">			<span class="function">FScopedCBDProfile <span class="title">Profile</span><span class="params">(Object)</span></span>;</span><br><span class="line">            <span class="comment">// å¼‚æ­¥è°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°</span></span><br><span class="line">			Object-&gt;<span class="built_in">ConditionalBeginDestroy</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¶…æ—¶é€€å‡ºå¾ªç¯(å¢é‡GC)</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bPollTimeLimit = ((TimePollCounter++) % TimeLimitEnforcementGranularityForBeginDestroy == <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (bUseTimeLimit &amp;&amp; bPollTimeLimit &amp;&amp; ((FPlatformTime::<span class="built_in">Seconds</span>() - StartTime) &gt; TimeLimit))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// whileå¾ªç¯å¤„ç†æ˜¯å¦è¶…æ—¶</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> bTimeLimitReached = (GUnrechableObjectIndex &lt; GUnreachableObjects.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">	FCoreUObjectDelegates::PostGarbageCollectConditionalBeginDestroy.<span class="built_in">Broadcast</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bTimeLimitReached;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸éš¾çœ‹å‡ºï¼Œ&quot;UnhashUnreachableObjects&quot;ï¼Œåªæ˜¯åœ¨å°† &quot;GObjUnhashUnreachableIsInProgress&quot; è®¾ç½®ä¸º &quot;true&quot; åï¼Œå¼‚æ­¥è°ƒç”¨æ‰€æœ‰ä¸å¯è¾¾å¯¹è±¡çš„ææ„å‡½æ•°ï¼Œå¹¶åœ¨å‡½æ•°è¿è¡Œç»“æŸæ—¶ï¼Œå°† &quot;GObjUnhashUnreachableIsInProgress&quot; é‡æ–°è®¾ç½®å›åŸæ¥çš„å€¼ã€‚</p><h5 id="incrementaldestroygarbage"><a class="anchor" href="#incrementaldestroygarbage">#</a> IncrementalDestroyGarbage</h5><p></p><figure class="highlight c++"><figcaption><span>IncrementalDestroyGarbage</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GarbageCollection.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IncrementalDestroyGarbage</span><span class="params">(<span class="keyword">bool</span> bUseTimeLimit, <span class="keyword">float</span> TimeLimit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¤šçº¿ç¨‹æ¸…ç†</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> bMultithreadedPurge = !<span class="built_in">ShouldForceSingleThreadedGC</span>() &amp;&amp; GMultithreadedDestructionEnabled;</span><br><span class="line">    <span class="comment">// ç”¨ &quot;bMultithreadedPurge&quot; åˆ›å»ºå¼‚æ­¥æ¸…ç†å¯¹è±¡ï¼Œtrueä¸ºå¼‚æ­¥æ¸…ç†ï¼Œfalseä¸ºåŒæ­¥æ¸…ç†</span></span><br><span class="line">	<span class="keyword">if</span> (!GAsyncPurge)</span><br><span class="line">	&#123;</span><br><span class="line">		GAsyncPurge = <span class="keyword">new</span> <span class="built_in">FAsyncPurge</span>(bMultithreadedPurge);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (GAsyncPurge-&gt;<span class="built_in">IsMultithreaded</span>() != bMultithreadedPurge)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">check</span>(GAsyncPurge-&gt;<span class="built_in">IsFinished</span>());</span><br><span class="line">		<span class="keyword">delete</span> GAsyncPurge;</span><br><span class="line">		GAsyncPurge = <span class="keyword">new</span> <span class="built_in">FAsyncPurge</span>(bMultithreadedPurge);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> bCompleted = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">bool</span> bTimeLimitReached = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¢é‡é”€æ¯ä¸å¯è¾¾å¯¹è±¡çš„å¼€å§‹æ—¶é—´</span></span><br><span class="line">	<span class="keyword">double</span> IncrementalDestroyGarbageStartTime = FPlatformTime::<span class="built_in">Seconds</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é¿å…è¿‡å¤šåœ°å¼ºåˆ¶æ‰§è¡Œæ—¶é—´é™åˆ¶</span></span><br><span class="line">    <span class="keyword">const</span> int32	TimeLimitEnforcementGranularityForDestroy = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">const</span> int32	TimeLimitEnforcementGranularityForDeletion = <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">    FGCScopeLock GCLock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰å¯¹è±¡ä»æœªè¢«é”€æ¯ ä¸” å½“å‰æ²¡æœ‰è¶…è¿‡æ—¶é—´é™åˆ¶</span></span><br><span class="line">	<span class="keyword">if</span>( !GObjFinishDestroyHasBeenRoutedToAllObjects &amp;&amp; !bTimeLimitReached )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">check</span>(GUnrechableObjectIndex &gt;= GUnreachableObjects.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å°è¯•å‘é€ &quot;FinishDestroy&quot; æ¶ˆæ¯ç»™æ‰€æœ‰çš„ä¸å¯è¾¾å¯¹è±¡ï¼Œ</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬å°†éå†æ‰€æœ‰å¯¹è±¡å¹¶é”€æ¯å¯ä»¥é”€æ¯çš„å¯¹è±¡ï¼Œ</span></span><br><span class="line">        <span class="comment">// æš‚æ—¶ä¸èƒ½é”€æ¯çš„å¯¹è±¡ä¼šåˆ—å…¥ä¸€ä¸ªåˆ—è¡¨ä¸­ä»¥ä¾¿åç»­å¤„ç†</span></span><br><span class="line">		int32 TimeLimitTimePollCounter = <span class="number">0</span>;</span><br><span class="line">		int32 FinishDestroyTimePollCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (GObjCurrentPurgeObjectIndexNeedsReset)</span><br><span class="line">		&#123;</span><br><span class="line">			GObjCurrentPurgeObjectIndex = <span class="number">0</span>;</span><br><span class="line">			GObjCurrentPurgeObjectIndexNeedsReset = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å§‹æ¸…ç†</span></span><br><span class="line">		<span class="keyword">while</span> (GObjCurrentPurgeObjectIndex &lt; GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// è·å–éœ€è¦æ¸…ç†çš„å¯¹è±¡</span></span><br><span class="line">			FUObjectItem* ObjectItem = GUnreachableObjects[GObjCurrentPurgeObjectIndex];</span><br><span class="line">			<span class="built_in">checkSlow</span>(ObjectItem);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">check</span>(ObjectItem-&gt;<span class="built_in">IsUnreachable</span>());</span><br><span class="line">			&#123;</span><br><span class="line">				UObject* Object = <span class="keyword">static_cast</span>&lt;UObject*&gt;(ObjectItem-&gt;Object);</span><br><span class="line">				</span><br><span class="line">                <span class="comment">// å¯¹è±¡å·²ç»è¢«è°ƒç”¨äº† &quot;BeginDestroy&quot; ä½†åˆæ²¡æœ‰å®Œå…¨è¢«é”€æ¯ã€‚</span></span><br><span class="line">				<span class="built_in">check</span>( Object-&gt;<span class="built_in">HasAnyFlags</span>( RF_BeginDestroyed ) &amp;&amp; !Object-&gt;<span class="built_in">HasAnyFlags</span>( RF_FinishDestroyed ) );</span><br><span class="line"></span><br><span class="line">				<span class="comment">// åªæœ‰åœ¨BeginDestroyå¯åŠ¨çš„å¼‚æ­¥æ¸…ç†å®Œæˆåï¼Œæ‰èƒ½ç»§ç»­é”€æ¯å¯¹è±¡ã€‚</span></span><br><span class="line">				<span class="keyword">if</span>(Object-&gt;<span class="built_in">IsReadyForFinishDestroy</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// å‘é€ &quot;FinishDestroy&quot; æ¶ˆæ¯(è¯¥å‡½æ•°å°†ä¸ºObjectè®¾ç½® &quot;RF_FinishDestroyed&quot; æ ‡å¿—ï¼Œè°ƒç”¨ &quot;FinishDestroy&quot; å‡½æ•°ï¼Œå¹¶å°†å…¶åœ¨ &quot;GUObjectArray&quot; çš„åˆ é™¤ç›‘å¬å™¨ä¸­ç§»é™¤)</span></span><br><span class="line">					Object-&gt;<span class="built_in">ConditionalFinishDestroy</span>();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// å› ä¸ºä¸æƒ³ç­‰æœªå‡†å¤‡å¥½çš„Objectå‡†å¤‡å¥½ï¼Œæ‰€ä»¥ç›´æ¥å°†æœªå‡†å¤‡å¥½çš„ObjectåŠ å…¥ &quot;GGCObjectsPendingDestruction&quot; æ•°ç»„ï¼Œä»¥ä¾¿å¤„ç†å®Œå…¶ä»–å†…å®¹åé‡æ–°è®¿é—®</span></span><br><span class="line">                    <span class="comment">// å› ä¸ºæœªå‡†å¤‡å¥½çš„Objecté€šå¸¸æ˜¯ä¸€äº›å¯ä»¥å¼‚æ­¥å¤„ç†çš„ï¼Œå¦‚å›¾å½¢èµ„æºåœ¨æ¸²æŸ“çº¿ç¨‹ä¸­çš„&quot;release fence&quot;ç­‰</span></span><br><span class="line">					GGCObjectsPendingDestruction.<span class="built_in">Add</span>(Object);</span><br><span class="line">					GGCObjectsPendingDestructionCount++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// è¿™ä¸€æ­¥ä¸€å®šè¦åœ¨æµ‹è¯•æ˜¯å¦è¶…æ—¶ä¹‹å‰ï¼Œå¦åˆ™å°†å¯¼è‡´é‡å¤å¤„ç†åŒä¸€ä¸ªObject</span></span><br><span class="line">			++GObjCurrentPurgeObjectIndex;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// é™åˆ¶è¶…æ—¶æµ‹è¯•æ¬¡æ•°</span></span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">bool</span> bPollTimeLimit = ((TimeLimitTimePollCounter++) % TimeLimitEnforcementGranularityForDestroy == <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span>( bUseTimeLimit &amp;&amp; bPollTimeLimit &amp;&amp; ((FPlatformTime::<span class="built_in">Seconds</span>() - GCStartTime) &gt; TimeLimit) )</span><br><span class="line">			&#123;</span><br><span class="line">				bTimeLimitReached = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ˜¯å¦å·²å°è¯•å¯¹æ‰€æœ‰ä¸å¯è¾¾å¯¹è±¡è°ƒç”¨ &quot;FinishDestroy&quot; (å¯èƒ½è¶…æ—¶é€€å‡ºäº†ï¼Œå¢é‡GCå˜›)</span></span><br><span class="line">        <span class="keyword">if</span> (GObjCurrentPurgeObjectIndex &gt;= GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">double</span> MaxTimeForFinishDestroy = <span class="number">10.00</span>;</span><br><span class="line">			<span class="keyword">bool</span> bFinishDestroyTimeExtended = <span class="literal">false</span>;</span><br><span class="line">			FString FirstObjectNotReadyWhenTimeExtended;</span><br><span class="line">			int32 StartObjectsPendingDestructionCount = GGCObjectsPendingDestructionCount;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¤„ç†ä¹‹å‰æœªå‡†å¤‡å¥½çš„å¯¹è±¡ (GGCObjectsPendingDestructionæ•°ç»„ä¸­çš„å¯¹è±¡)</span></span><br><span class="line">			int32 LastLoopObjectsPendingDestructionCount = GGCObjectsPendingDestructionCount;</span><br><span class="line">			<span class="keyword">while</span>( GGCObjectsPendingDestructionCount &gt; <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				int32 CurPendingObjIndex = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">while</span>( CurPendingObjIndex &lt; GGCObjectsPendingDestructionCount )</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// è·å–ä¹‹å‰æŒ‚èµ·ææ„çš„å¯¹è±¡ï¼Œåé¢çš„å¤„ç†è·Ÿå‰é¢ç±»ä¼¼</span></span><br><span class="line">					UObject* Object = GGCObjectsPendingDestruction[ CurPendingObjIndex ];</span><br><span class="line"></span><br><span class="line">					<span class="built_in">check</span>( Object != <span class="literal">NULL</span> &amp;&amp; Object-&gt;<span class="built_in">IsUnreachable</span>() );</span><br><span class="line"></span><br><span class="line">					<span class="built_in">check</span>( Object-&gt;<span class="built_in">HasAnyFlags</span>( RF_BeginDestroyed ) &amp;&amp; !Object-&gt;<span class="built_in">HasAnyFlags</span>( RF_FinishDestroyed ) );</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span>( Object-&gt;<span class="built_in">IsReadyForFinishDestroy</span>() )</span><br><span class="line">					&#123;</span><br><span class="line">                        Object-&gt;<span class="built_in">ConditionalFinishDestroy</span>();</span><br><span class="line"></span><br><span class="line">						&#123;</span><br><span class="line">                            <span class="comment">// æé«˜æ•°ç»„åˆ é™¤å…ƒç´ æ•ˆç‡</span></span><br><span class="line">							GGCObjectsPendingDestruction[ CurPendingObjIndex ] = GGCObjectsPendingDestruction[ GGCObjectsPendingDestructionCount - <span class="number">1</span> ];</span><br><span class="line"></span><br><span class="line">							GGCObjectsPendingDestructionCount--;</span><br><span class="line">						&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                    	CurPendingObjIndex++;    </span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// é™åˆ¶è¶…æ—¶æµ‹è¯•æ¬¡æ•°</span></span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">bool</span> bPollTimeLimit = ((TimeLimitTimePollCounter++) % TimeLimitEnforcementGranularityForDestroy == <span class="number">0</span>);</span><br><span class="line">					<span class="keyword">if</span>( bUseTimeLimit &amp;&amp; bPollTimeLimit &amp;&amp; ((FPlatformTime::<span class="built_in">Seconds</span>() - GCStartTime) &gt; TimeLimit) )</span><br><span class="line">					&#123;</span><br><span class="line">						bTimeLimitReached = <span class="literal">true</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¦‚æœæœ‰GCæ—¶é—´é™åˆ¶</span></span><br><span class="line">                <span class="keyword">if</span>(bUseTimeLimit)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// æˆ‘ä»¬å¯¹æ‰€æœ‰æŒ‚èµ·ææ„çš„Objectè¿›è¡Œäº†ä¸€æ¬¡è¿­ä»£ï¼Œåˆ°è¿™é‡Œå°½ç®¡è¿˜æœ‰å‰©ä½™æ—¶é—´æˆ–è€…è¿˜æœ‰æŒ‚èµ·ææ„çš„Objectsï¼Œæˆ‘ä»¬éƒ½åº”è¯¥breakæ‰ï¼Œå› ä¸ºè¿™æ—¶æˆ‘ä»¬å¾ˆæœ‰å¯èƒ½æ˜¯æ­£åœ¨ç­‰å¾…æ¸²æŸ“çº¿ç¨‹çš„Objectsææ„</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>( GGCObjectsPendingDestructionCount &gt; <span class="number">0</span> )</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (FPlatformProperties::<span class="built_in">RequiresCookedData</span>())</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">const</span> <span class="keyword">bool</span> bPollTimeLimit = ((FinishDestroyTimePollCounter++) % TimeLimitEnforcementGranularityForDestroy == <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// åœ¨ä¸‹ä¸€æ­¥ä¹‹å‰ç¡çœ ï¼Œä»¥ç»™æ¸²æŸ“çº¿ç¨‹æ›´å¤šæ—¶é—´é‡Šæ”¾fences</span></span><br><span class="line">                    FPlatformProcess::<span class="built_in">sleep</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                LastLoopObjectsPendingDestructionCount = GGCObjectsPendingDestructionCount;</span><br><span class="line">			&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¦‚æœæ‰€æœ‰çš„ä¸å¯è¾¾å¯¹è±¡éƒ½å·²å‡†å¤‡å¥½è¢«é”€æ¯ï¼Œåˆ™é‡ç½®ä¸€äº›å˜é‡</span></span><br><span class="line">			<span class="keyword">if</span>( GGCObjectsPendingDestructionCount == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				GGCObjectsPendingDestruction.<span class="built_in">Empty</span>( <span class="number">256</span> );</span><br><span class="line"></span><br><span class="line">				<span class="comment">// è¯¥å˜é‡è¡¨ç¤ºæ‰€æœ‰çš„ä¸å¯è¾¾å¯¹è±¡éƒ½å·²å‡†å¤‡å¥½è¢«é”€æ¯ï¼Œå¯ä»¥è¿›è¡Œå¯¹è±¡ææ„ é‡Šæ”¾å†…å­˜äº†</span></span><br><span class="line">				GObjFinishDestroyHasBeenRoutedToAllObjects = <span class="literal">true</span>;</span><br><span class="line">				GObjCurrentPurgeObjectIndexNeedsReset = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">                       </span><br><span class="line">    <span class="comment">// å¦‚æœæ‰€æœ‰å¯¹è±¡éƒ½å·²å‡†å¤‡å¥½è¢«é”€æ¯ï¼Œä¸”æœ¬æ¬¡å¢é‡æ¸…é™¤è¿˜æœ‰æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (GObjFinishDestroyHasBeenRoutedToAllObjects &amp;&amp; !bTimeLimitReached)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¼€å§‹é”€æ¯å¯¹è±¡ï¼Œå®é™…ä¸Šé”€æ¯å¯¹è±¡æ˜¯ç”± &quot;GAsyncPurge&quot; è¿›è¡Œçš„</span></span><br><span class="line">        int32 ProcessCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (GObjCurrentPurgeObjectIndexNeedsReset)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// &quot;BeginPurge&quot; é‡Œé¢é‡ç½®äº†ä¸€äº› &quot;BeginPurgeEvent&quot; éœ€è¦çš„å‚æ•°ï¼Œå¹¶æ¿€æ´»äº† &quot;BeginPurgeEvent&quot;</span></span><br><span class="line">            GAsyncPurge-&gt;<span class="built_in">BeginPurge</span>();</span><br><span class="line">            GObjCurrentPurgeObjectIndexNeedsReset = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨æ¸¸æˆçº¿ç¨‹ä¸­Tickï¼Œè°ƒç”¨ &quot;TickDestroyObjects&quot;(å‡½æ•°åˆ†æè¯¦è§ä¸‹æ–‡) å’Œ &quot;TickDestroyGameThreadObjects&quot;(å‡½æ•°åˆ†æè¯¦è§ä¸‹æ–‡) æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡å’Œå·¥ä½œçº¿ç¨‹æ— æ³•æ¸…é™¤çš„å¯¹è±¡</span></span><br><span class="line">        GAsyncPurge-&gt;<span class="built_in">TickPurge</span>(bUseTimeLimit, TimeLimit, GCStartTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (GAsyncPurge-&gt;<span class="built_in">IsFinished</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            bCompleted = <span class="literal">true</span>;</span><br><span class="line">			<span class="comment">// å¢é‡æ¸…é™¤å·²å®Œæˆï¼Œé‡ç½®å˜é‡</span></span><br><span class="line">			GObjFinishDestroyHasBeenRoutedToAllObjects		= <span class="literal">false</span>;</span><br><span class="line">			GObjPurgeIsRequired								= <span class="literal">false</span>;</span><br><span class="line">			GObjCurrentPurgeObjectIndexNeedsReset			= <span class="literal">true</span>;</span><br><span class="line">            </span><br><span class="line">            GAsyncPurge-&gt;<span class="built_in">ResetObjectsDestroyedSinceLastMarkPhase</span>();</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bCompleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¯´ç™½äº†ï¼Œ&quot;IncrementalDestroyGarbage&quot; å°±æ˜¯åœ¨è°ƒç”¨æ‰€æœ‰ä¸å¯è¾¾å¯¹è±¡çš„ &quot;ConditionalFinishDestroy ()&quot; å‡½æ•°ï¼Œæ—¨åœ¨åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦å·²ç»å‡†å¤‡å¥½è¢«é”€æ¯äº†ï¼Œå‡†å¤‡å¥½äº†å°±æ ‡ä¸Š &quot;RF_FinishDestroyed&quot;ï¼Œå½“å…¨éƒ¨å¯¹è±¡éƒ½å‡†å¤‡å¥½äº†å°±å¼€å§‹é”€æ¯å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ï¼Œå½“ç„¶è¿™äº›æ­¥éª¤éƒ½æ˜¯ä¼šéšæ—¶ä¸­æ–­çš„ï¼Œå› ä¸º unreal é‡‡ç”¨çš„æ˜¯å¢é‡å¼ GCã€‚ä½†å› ä¸ºæ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†çš„åˆ¤æ–­ï¼Œæ‰€ä»¥å³ä½¿ä¸­æ–­ GC ä¹Ÿå¹¶ä¸ä¼šå‡ºç° bugã€‚</p><p>ä»¥ä¸‹æ˜¯ &quot;GAsyncPurge-&gt;TickPurge&quot; ä¸­é”€æ¯å¯¹è±¡ é‡Šæ”¾å†…å­˜çš„å‡½æ•°ï¼ˆå·²ç»æ˜¯æœ€åä¸€æ­¥äº†ï¼Œå¼€å¿ƒ ğŸ˜ƒ</p><h5 id="tickdestroyobjects"><a class="anchor" href="#tickdestroyobjects">#</a> TickDestroyObjects</h5><p></p><figure class="highlight c++"><figcaption><span>TickDestroyObjects</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">TickDestroyObjects</span><span class="params">(<span class="keyword">bool</span> bUseTimeLimit, <span class="keyword">float</span> TimeLimit, <span class="keyword">double</span> StartTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é™åˆ¶è¶…æ—¶æ£€æµ‹ç»†ç²’åº¦</span></span><br><span class="line">    <span class="keyword">const</span> int32 TimeLimitEnforcementGranularityForDeletion = <span class="number">100</span>;</span><br><span class="line">    int32 ProcessedObjectsCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> bFinishedDestroyingObjects = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// éå†å¤„ç†æ‰€æœ‰éœ€è¦æ¸…é™¤çš„Object</span></span><br><span class="line">    <span class="keyword">while</span> (ObjCurrentPurgeObjectIndex &lt; GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FUObjectItem* ObjectItem = GUnreachableObjects[ObjCurrentPurgeObjectIndex];</span><br><span class="line">        <span class="built_in">check</span>(ObjectItem-&gt;<span class="built_in">IsUnreachable</span>());</span><br><span class="line"></span><br><span class="line">        UObject* Object = (UObject*)ObjectItem-&gt;Object;</span><br><span class="line">        <span class="built_in">check</span>(Object-&gt;<span class="built_in">HasAllFlags</span>(RF_FinishDestroyed | RF_BeginDestroyed));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éå¤šçº¿ç¨‹ æˆ– å½“å‰Objectçš„ææ„æ˜¯çº¿ç¨‹å®‰å…¨çš„</span></span><br><span class="line">        <span class="keyword">if</span> (!bMultithreaded || Object-&gt;<span class="built_in">IsDestructionThreadSafe</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨Objectçš„ææ„å‡½æ•°ï¼Œé‡Šæ”¾Objectçš„å†…å­˜ï¼Œç½®ç©º &quot;GUnreachableObjects&quot; æ•°ç»„ä¸­çš„æŒ‡é’ˆ</span></span><br><span class="line">            Object-&gt;~<span class="built_in">UObject</span>();</span><br><span class="line">            GUObjectAllocator.<span class="built_in">FreeUObject</span>(Object);</span><br><span class="line">            GUnreachableObjects[ObjCurrentPurgeObjectIndex] = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// æ¿€æ´»å†…å­˜å±éšœï¼Œå°†å…¶å½’å…¥æ¸¸æˆçº¿ç¨‹ä¸­ææ„</span></span><br><span class="line">            FPlatformMisc::<span class="built_in">MemoryBarrier</span>();</span><br><span class="line">            ++NumObjectsToDestroyOnGameThread;</span><br><span class="line">        &#125;</span><br><span class="line">        ++ProcessedObjectsCount;</span><br><span class="line">        ++ObjectsDestroyedSinceLastMarkPhase;</span><br><span class="line">        ++ObjCurrentPurgeObjectIndex;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¶…æ—¶è¿”å›(å¢é‡GC)</span></span><br><span class="line">        <span class="keyword">if</span> (!bMultithreaded &amp;&amp; bUseTimeLimit &amp;&amp; (ProcessedObjectsCount == TimeLimitEnforcementGranularityForDeletion) &amp;&amp; (ObjCurrentPurgeObjectIndex &lt; GUnreachableObjects.<span class="built_in">Num</span>()))</span><br><span class="line">        &#123;</span><br><span class="line">            ProcessedObjectsCount = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ((FPlatformTime::<span class="built_in">Seconds</span>() - StartTime) &gt; TimeLimit)</span><br><span class="line">            &#123;</span><br><span class="line">                bFinishedDestroyingObjects = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;				</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bFinishedDestroyingObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="tickdestroygamethreadobjects"><a class="anchor" href="#tickdestroygamethreadobjects">#</a> TickDestroyGameThreadObjects</h5><p></p><figure class="highlight c++"><figcaption><span>TickDestroyGameThreadObjects</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">TickDestroyGameThreadObjects</span><span class="params">(<span class="keyword">bool</span> bUseTimeLimit, <span class="keyword">float</span> TimeLimit, <span class="keyword">double</span> StartTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> int32 TimeLimitEnforcementGranularityForDeletion = <span class="number">100</span>;</span><br><span class="line">    int32 ProcessedObjectsCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> bFinishedDestroyingObjects = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜æœ¬åœ°åˆ é™¤çš„Objectsæ•°é‡ï¼Œå¯èƒ½ä¼šä¸æ–­å¢é•¿ï¼Œä½†æˆ‘ä»¬ä¼šåœ¨æ¯ä¸€å¸§éƒ½è¿›è¡Œå¤„ç†ä»¥è¾¾åˆ°è¿™ä¸ªæ•°é‡</span></span><br><span class="line">    <span class="keyword">const</span> int32 LocalNumObjectsToDestroyOnGameThread = NumObjectsToDestroyOnGameThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (NumObjectsDestroyedOnGameThread &lt; LocalNumObjectsToDestroyOnGameThread &amp;&amp; ObjCurrentPurgeObjectIndexOnGameThread &lt; GUnreachableObjects.<span class="built_in">Num</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        FUObjectItem* ObjectItem = GUnreachableObjects[ObjCurrentPurgeObjectIndexOnGameThread];	</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœObjectItemä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºå·²ç»åœ¨ &quot;TickDestroyObjects&quot; å‡½æ•°ä¸­ææ„æ‰äº†</span></span><br><span class="line">        <span class="keyword">if</span> (ObjectItem)</span><br><span class="line">        &#123;</span><br><span class="line">            GUnreachableObjects[ObjCurrentPurgeObjectIndexOnGameThread] = <span class="literal">nullptr</span>;</span><br><span class="line">            UObject* Object = (UObject*)ObjectItem-&gt;Object;</span><br><span class="line">            Object-&gt;~<span class="built_in">UObject</span>();</span><br><span class="line">            GUObjectAllocator.<span class="built_in">FreeUObject</span>(Object);</span><br><span class="line">            ++ProcessedObjectsCount;</span><br><span class="line">            ++NumObjectsDestroyedOnGameThread;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¶…æ—¶è¿”å›(å¢é‡GC)</span></span><br><span class="line">            <span class="keyword">if</span> (bUseTimeLimit &amp;&amp; (ProcessedObjectsCount == TimeLimitEnforcementGranularityForDeletion) &amp;&amp; NumObjectsDestroyedOnGameThread &lt; LocalNumObjectsToDestroyOnGameThread)</span><br><span class="line">            &#123;</span><br><span class="line">                ProcessedObjectsCount = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ((FPlatformTime::<span class="built_in">Seconds</span>() - StartTime) &gt; TimeLimit)</span><br><span class="line">                &#123;</span><br><span class="line">                    bFinishedDestroyingObjects = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ++ObjCurrentPurgeObjectIndexOnGameThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">check</span>(!bFinishedDestroyingObjects || NumObjectsDestroyedOnGameThread == LocalNumObjectsToDestroyOnGameThread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥å‡½æ•°è¿”å›å€¼ä¸é‡è¦ï¼Œå› ä¸º &quot;NumObjectsToDestroyOnGameThread&quot; æ˜¯ä¼šä¸æ–­å¢åŠ çš„ï¼Œæˆ‘ä»¬åªè¦å…¶é”€æ¯å¯¹è±¡ é‡Šæ”¾å†…å­˜çš„è¿™ä¸ªè¿‡ç¨‹ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> bFinishedDestroyingObjects;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å°±æŠŠä¸å¯è¾¾å¯¹è±¡ç»™ææ„å®Œå•¦ï¼Œå†…å­˜ä¹Ÿé‡Šæ”¾å‡ºæ¥äº†ï¼Œé‚£æœ€åå†æ€»ç»“ä¸€ä¸‹ï¼Œå’±è¿™æ¬¡ GC æ—…ç¨‹éƒ½åˆ†æäº†ä»€ä¹ˆã€‚</p></li></ul><h4 id="æ€»ç»“"><a class="anchor" href="#æ€»ç»“">#</a> æ€»ç»“ï¼š</h4><ul><li>é¦–å…ˆæˆ‘ä»¬åˆ†æäº† &quot;CollectGarbage&quot; API çš„æºç ï¼ŒçŸ¥é“ä»–æ˜¯ç”±ä¸€ä¸ªå†…éƒ¨å‡½æ•°æ”¯æ’‘èµ·æ¥çš„ã€‚</li><li>è¿™ä¸ªå†…éƒ¨å‡½æ•°é‡Œé¢ä¼šå…ˆåˆ¤æ–­ä¸Šæ¬¡çš„å¢é‡æ¸…é™¤ &quot;IncrementalPurgeGarbage&quot; æ˜¯å¦å·²ç»å®Œæˆï¼Œå¦‚æœæœªå®Œæˆåˆ™ç»§ç»­è¿›è¡Œå¢é‡æ¸…é™¤ã€‚å®Œæˆåˆ™è¿›è¡Œå¯è¾¾æ€§åˆ†æ &quot;PerformReachabilityAnalysis&quot;ã€‚</li><li>Unreal çš„å¯è¾¾æ€§åˆ†ææä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼Œå¹¶è¡Œå¤„ç†å’Œéå¹¶è¡Œå¤„ç†ã€‚æˆ‘ä»¬ä¹Ÿåˆ†åˆ«åšäº†åˆ†æã€‚</li><li>å¯è¾¾æ€§åˆ†æåä¼šè¿›è¡Œä¸‹ä¸€è½®çš„å¢é‡æ¸…é™¤ï¼Œæ¸…é™¤å®Œåˆåˆ†æï¼Œåˆ†æå®Œåˆæ¸…é™¤......</li><li>è¿˜æœ‰ä¸€äº›ç°‡çš„å¤„ç†ï¼Œå†…å­˜é‡Šæ”¾ï¼Œå†…å­˜å±éšœï¼ŒObjectHashTables çš„å¤„ç†ç­‰ç­‰å°ç»†èŠ‚ã€‚</li></ul><p>å·®ä¸å¤šä¹Ÿè¯¥ç»“æŸè¿™æ¬¡çš„ GC æ—…ç¨‹å•¦ï¼Œä¸‹å›è§ï½ï½ï½</p><hr><h4 id="å°ç»éªŒ"><a class="anchor" href="#å°ç»éªŒ">#</a> å°ç»éªŒï¼š</h4><h5 id="ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°æ™ºèƒ½æŒ‡é’ˆæ˜¯æ€ä¹ˆgcçš„"><a class="anchor" href="#ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°æ™ºèƒ½æŒ‡é’ˆæ˜¯æ€ä¹ˆgcçš„">#</a> ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ï¼šæ™ºèƒ½æŒ‡é’ˆæ˜¯æ€ä¹ˆ GC çš„ï¼Ÿ</h5><ul><li>å…¶å® Unreal çš„æ™ºèƒ½æŒ‡é’ˆå¼ä¸€ä¸ªçº¯ C++ ç±»ï¼Œä¹Ÿæ²¡æœ‰ç»§æ‰¿ FGCObjectï¼Œå½“ç„¶æ˜¯ä¸ä¼šè¢«åˆ—å…¥ GC æ•°ç»„ä¸­çš„ã€‚</li></ul><h5 id="è¡ç”Ÿé—®é¢˜é‚£æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘çš„uobjectå¯¹è±¡å‘¢è¿™ä¸ªæ€ä¹ˆgc"><a class="anchor" href="#è¡ç”Ÿé—®é¢˜é‚£æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘çš„uobjectå¯¹è±¡å‘¢è¿™ä¸ªæ€ä¹ˆgc">#</a> è¡ç”Ÿé—®é¢˜ï¼šé‚£æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘çš„ UObject å¯¹è±¡å‘¢ï¼Ÿè¿™ä¸ªæ€ä¹ˆ GCï¼Ÿ</h5><ul><li>é¦–å…ˆ unreal çš„æ™ºèƒ½æŒ‡é’ˆä¸æ˜¯æ‰€æœ‰çš„éƒ½èƒ½æŒ‡å‘ UObject çš„ï¼ŒTSharedPtr å’Œ TSharedRef æ˜¯ä¸èƒ½æŒ‡å‘ UObject çš„ï¼Œä¸èƒ½æŒ‡å‘çš„åŸå› å°±æ˜¯è¿™ä¸¤ä¸ªæŒ‡é’ˆæ˜¯ä¼šé‡Šæ”¾å†…å­˜çš„ï¼Œå¦‚æœæŒ‡å‘ UObjectï¼Œé‚£å°±ä¼šå¯¼è‡´äºŒæ¬¡é‡Šæ”¾ï¼Œå¼•èµ·ç¨‹åºå´©æºƒ</li><li>TWeakPtr æ˜¯å¯ä»¥æŒ‡å‘ UObject çš„ï¼Œä¹Ÿä¸å‚ä¸å¼•ç”¨è®¡æ•°ï¼Œæ›´ä¸ä¼šé‡Šæ”¾è¿™ä¸ª UObject çš„å†…å­˜ã€‚</li><li>æ€»å¾—æ¥è¯´å°±æ˜¯ï¼Œå½’ GC ç®¡çš„å¯¹è±¡æ™ºèƒ½æŒ‡é’ˆä¸ä¼šç®¡ï¼Œä¹Ÿä¸èƒ½ç®¡ã€‚ä¸å½’ GC ç®¡çš„å¯¹è±¡å°±å¯ä»¥ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚</li></ul></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-11-15 19:40:55" itemprop="dateModified" datetime="2021-11-15T19:40:55+08:00">2021-11-15</time> </span><span id="2021/11/06/UE4/UE4CPP/Unreal GCè¿‡ç¨‹/" class="item leancloud_visitors" data-flag-title="Unreal GCè¿‡ç¨‹" title="é˜…è¯»æ¬¡æ•°"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">é˜…è¯»æ¬¡æ•°</span> <span class="leancloud-visitors-count"></span> <span class="text">æ¬¡</span></span></div><div id="copyright"><ul><li class="author"><strong>æœ¬æ–‡ä½œè€…ï¼š </strong>-YIFEI- <i class="ic i-at"><em>@</em></i>ä¸€ä¸ªå¹´è½»äººå¥”å‘æ¢¦æƒ³çš„è¶³è¿¹</li><li class="link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong> <a href="https://kotori_suki.github.io/2021/11/06/UE4/UE4CPP/Unreal%20GC%E8%BF%87%E7%A8%8B/" title="Unreal GCè¿‡ç¨‹">https://kotori_suki.github.io/2021/11/06/UE4/UE4CPP/Unreal GCè¿‡ç¨‹/</a></li><li class="license"><strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/11/02/UE4/UE4CPP/Unreal%20%E5%BA%8F%E5%88%97%E5%8C%96/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicitht3xtj20zk0m8k5v.jpg" title="Unreal åºåˆ—åŒ–~~~"><span class="type">ä¸Šä¸€ç¯‡</span> <span class="category"><i class="ic i-flag"></i> UE4_C++</span><h3>Unreal åºåˆ—åŒ–~~~</h3></a></div><div class="item right"><a href="/2021/11/08/UE4/UE4CPP/UClass%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E6%88%90%E9%95%BF/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclj61ylzj20zk0m8b29.jpg" title="UClassçš„è¯ç”Ÿä¸æˆé•¿"><span class="type">ä¸‹ä¸€ç¯‡</span> <span class="category"><i class="ic i-flag"></i> UE4_C++</span><h3>UClassçš„è¯ç”Ÿä¸æˆé•¿</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="æ–‡ç« ç›®å½•"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#unreal-gc%E8%BF%87%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">Unreal GC è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%BE%BE%E6%80%A7%E5%88%86%E6%9E%90"><span class="toc-number">1.0.1.</span> <span class="toc-text">å¯è¾¾æ€§åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#markobjectsfunctions"><span class="toc-number">1.0.1.0.1.</span> <span class="toc-text">&quot;MarkObjectsFunctions&quot;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#reachabilityanalysisfunctions"><span class="toc-number">1.0.1.0.2.</span> <span class="toc-text">ReachabilityAnalysisFunctions</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#processobjectarray-%E9%9D%9E%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">ProcessObjectArray | éå¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#processobjectarray-%E9%81%8D%E5%8E%86uobject%E7%9A%84tokenstream%E6%9D%A5%E5%AF%BB%E6%89%BE%E5%BD%93%E5%89%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%BC%95%E7%94%A8%E8%A7%A3%E6%9E%90%E5%A6%82%E4%B8%8B"><span class="toc-number">1.0.1.1.1.</span> <span class="toc-text">&quot;ProcessObjectArray&quot; éå† UObject çš„ TokenStream æ¥å¯»æ‰¾å½“å‰å­˜åœ¨çš„å¼•ç”¨ï¼Œè§£æå¦‚ä¸‹ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#handletokenstreamobjectreference"><span class="toc-number">1.0.1.1.2.</span> <span class="toc-text">HandleTokenStreamObjectReference</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fcollectortaskprocessortask-%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">FCollectorTaskProcessorTask | å¹¶è¡Œå¤„ç†å¯¹è±¡å¼•ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#taskqueue"><span class="toc-number">1.0.1.2.1.</span> <span class="toc-text">TaskQueue</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tgraphtask"><span class="toc-number">1.0.1.2.2.</span> <span class="toc-text">TGraphTask</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fcollectortaskprocessortask"><span class="toc-number">1.0.1.2.3.</span> <span class="toc-text">FCollectorTaskProcessorTask</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E6%B8%85%E9%99%A4%E4%B8%8D%E5%8F%AF%E8%BE%BE%E5%AF%B9%E8%B1%A1a-id%E5%A2%9E%E9%87%8F%E6%B8%85%E9%99%A4%E4%B8%8D%E5%8F%AF%E8%BE%BE%E5%AF%B9%E8%B1%A1a"><span class="toc-number">1.0.2.</span> <span class="toc-text">å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡ &lt;a id&#x3D;&quot;å¢é‡æ¸…é™¤ä¸å¯è¾¾å¯¹è±¡&quot;&gt;&lt;&#x2F;a&gt;</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#incrementalpurgegarbage"><span class="toc-number">1.0.2.0.1.</span> <span class="toc-text">IncrementalPurgeGarbage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#unhashunreachableobjects"><span class="toc-number">1.0.2.0.2.</span> <span class="toc-text">UnhashUnreachableObjects</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#incrementaldestroygarbage"><span class="toc-number">1.0.2.0.3.</span> <span class="toc-text">IncrementalDestroyGarbage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tickdestroyobjects"><span class="toc-number">1.0.2.0.4.</span> <span class="toc-text">TickDestroyObjects</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tickdestroygamethreadobjects"><span class="toc-number">1.0.2.0.5.</span> <span class="toc-text">TickDestroyGameThreadObjects</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">æ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%8F%E9%AA%8C"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">å°ç»éªŒï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B9%8B%E5%89%8D%E9%9D%A2%E8%AF%95%E7%9A%84%E6%97%B6%E5%80%99%E8%A2%AB%E9%97%AE%E5%88%B0%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E6%98%AF%E6%80%8E%E4%B9%88gc%E7%9A%84"><span class="toc-number">1.0.2.2.1.</span> <span class="toc-text">ä¹‹å‰é¢è¯•çš„æ—¶å€™è¢«é—®åˆ°ï¼šæ™ºèƒ½æŒ‡é’ˆæ˜¯æ€ä¹ˆ GC çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%8D%E7%94%9F%E9%97%AE%E9%A2%98%E9%82%A3%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E6%8C%87%E5%90%91%E7%9A%84uobject%E5%AF%B9%E8%B1%A1%E5%91%A2%E8%BF%99%E4%B8%AA%E6%80%8E%E4%B9%88gc"><span class="toc-number">1.0.2.2.2.</span> <span class="toc-text">è¡ç”Ÿé—®é¢˜ï¼šé‚£æ™ºèƒ½æŒ‡é’ˆæŒ‡å‘çš„ UObject å¯¹è±¡å‘¢ï¼Ÿè¿™ä¸ªæ€ä¹ˆ GCï¼Ÿ</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="ç³»åˆ—æ–‡ç« "><ul><li><a href="/2021/08/05/UE4/UE4CPP/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="bookmark" title="UE4å¤šçº¿ç¨‹">UE4å¤šçº¿ç¨‹</a></li><li><a href="/2021/10/25/UE4/UE4CPP/API%E4%B8%8D%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C-%E4%B9%8B-GetGameMode/" rel="bookmark" title="APIä¸æ­£å¸¸å·¥ä½œ ä¹‹ GetGameMode">APIä¸æ­£å¸¸å·¥ä½œ ä¹‹ GetGameMode</a></li><li><a href="/2021/10/25/UE4/UE4CPP/API%E4%B8%8D%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C-%E4%B9%8B-GetPlayerController/" rel="bookmark" title="APIä¸æ­£å¸¸å·¥ä½œ ä¹‹ GetPlayerController">APIä¸æ­£å¸¸å·¥ä½œ ä¹‹ GetPlayerController</a></li><li><a href="/2021/10/25/UE4/UE4CPP/unreal%E5%BC%95%E6%93%8E%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" rel="bookmark" title="unrealå¼•æ“å¯åŠ¨æµç¨‹">unrealå¼•æ“å¯åŠ¨æµç¨‹</a></li><li><a href="/2021/10/26/UE4/UE4CPP/%E4%BB%8ESVG%E6%96%87%E4%BB%B6%E5%BC%80%E5%A7%8B%E7%9A%84%E6%97%85%E7%A8%8B/" rel="bookmark" title="ä»SVGæ–‡ä»¶å¼€å§‹çš„æ—…ç¨‹~~~">ä»SVGæ–‡ä»¶å¼€å§‹çš„æ—…ç¨‹~~~</a></li><li><a href="/2021/10/29/UE4/UE4CPP/%E5%8F%8D%E5%B0%84%E7%B3%BB%E7%BB%9F%20API/" rel="bookmark" title="åå°„ç³»ç»ŸAPI  è§£æå’Œä½¿ç”¨">åå°„ç³»ç»ŸAPI è§£æå’Œä½¿ç”¨</a></li><li><a href="/2021/10/31/UE4/UE4CPP/Session%E7%9A%84%E4%BD%BF%E7%94%A8%20C++%E7%AF%87/" rel="bookmark" title="Sessionçš„ä½¿ç”¨ C++ç¯‡">Sessionçš„ä½¿ç”¨ C++ç¯‡</a></li><li><a href="/2021/11/02/UE4/UE4CPP/Unreal%20%E5%BA%8F%E5%88%97%E5%8C%96/" rel="bookmark" title="Unreal åºåˆ—åŒ–~~~">Unreal åºåˆ—åŒ–~~~</a></li><li class="active"><a href="/2021/11/06/UE4/UE4CPP/Unreal%20GC%E8%BF%87%E7%A8%8B/" rel="bookmark" title="Unreal GCè¿‡ç¨‹">Unreal GCè¿‡ç¨‹</a></li><li><a href="/2021/11/08/UE4/UE4CPP/UClass%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E6%88%90%E9%95%BF/" rel="bookmark" title="UClassçš„è¯ç”Ÿä¸æˆé•¿">UClassçš„è¯ç”Ÿä¸æˆé•¿</a></li><li><a href="/2021/11/11/UE4/UE4CPP/UE4%E4%BB%A3%E7%90%86%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%8E%E7%94%A8%E6%B3%95/" rel="bookmark" title="UE4ä»£ç†çš„å®ç°ä¸ç”¨æ³•">UE4ä»£ç†çš„å®ç°ä¸ç”¨æ³•</a></li><li><a href="/2021/11/15/UE4/UE4CPP/FProperty%E7%9A%84%E5%88%86%E6%9E%90%E4%B8%8E%E6%80%BB%E7%BB%93/" rel="bookmark" title="FPropertyçš„åˆ†æä¸æ€»ç»“">FPropertyçš„åˆ†æä¸æ€»ç»“</a></li><li><a href="/2021/11/22/UE4/UE4CPP/Unreal%20%E5%A4%9A%E7%A7%8D%E6%8C%87%E9%92%88%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="bookmark" title="Unreal å¤šç§æŒ‡é’ˆå®ç°åŸç†">Unreal å¤šç§æŒ‡é’ˆå®ç°åŸç†</a></li><li><a href="/2021/11/26/UE4/UE4CPP/Unreal%20Slate/" rel="bookmark" title="Unreal Slate">Unreal Slate</a></li></ul></div><div class="overview panel" data-title="ç«™ç‚¹æ¦‚è§ˆ"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="-YIFEI-" data-src="/images/avatar.jpg"><p class="name" itemprop="name">-YIFEI-</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">45</span> <span class="name">æ–‡ç« </span></a></div><div class="item categories"><a href="/categories/"><span class="count">13</span> <span class="name">åˆ†ç±»</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0tvdG9yaS1TdWtp" title="https:&#x2F;&#x2F;github.com&#x2F;Kotori-Suki"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS90dnQtNjA=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;tvt-60"><i class="ic i-zhihu"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>é¦–é¡µ</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>æ–‡ç« </a><ul class="submenu"><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>åˆ†ç±»</a></li></ul></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>æ ‡ç­¾</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/11/02/UE4/UE4CPP/Unreal%20%E5%BA%8F%E5%88%97%E5%8C%96/" rel="prev" title="ä¸Šä¸€ç¯‡"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/11/08/UE4/UE4CPP/UClass%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E6%88%90%E9%95%BF/" rel="next" title="ä¸‹ä¸€ç¯‡"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>éšæœºæ–‡ç« </h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="åˆ†ç±»äº UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="åˆ†ç±»äº UE4_C++">UE4_C++</a></div><span><a href="/2021/11/22/UE4/UE4CPP/Unreal%20%E5%A4%9A%E7%A7%8D%E6%8C%87%E9%92%88%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="Unreal å¤šç§æŒ‡é’ˆå®ç°åŸç†">Unreal å¤šç§æŒ‡é’ˆå®ç°åŸç†</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="åˆ†ç±»äº C++åŸºç¡€">C++åŸºç¡€</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="åˆ†ç±»äº è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="åˆ†ç±»äº åˆ›å»ºå‹æ¨¡å¼">åˆ›å»ºå‹æ¨¡å¼</a></div><span><a href="/2021/08/17/CPPBase/DesignPattern/Builder/" title="å»ºé€ è€…æ¨¡å¼">å»ºé€ è€…æ¨¡å¼</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ComputerBase/" title="åˆ†ç±»äº è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€</a> <i class="ic i-angle-right"></i> <a href="/categories/ComputerBase/%E7%AE%97%E6%B3%95/" title="åˆ†ç±»äº ç®—æ³•">ç®—æ³•</a></div><span><a href="/2021/08/16/ComputerBase/Algorithm/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="åŠ¨æ€è§„åˆ’">åŠ¨æ€è§„åˆ’</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ComputerBase/" title="åˆ†ç±»äº è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€</a> <i class="ic i-angle-right"></i> <a href="/categories/ComputerBase/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" title="åˆ†ç±»äº æ“ä½œç³»ç»Ÿ">æ“ä½œç³»ç»Ÿ</a></div><span><a href="/2021/08/16/ComputerBase/OperatingSystem/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="è¿›ç¨‹ çº¿ç¨‹ å¤šçº¿ç¨‹">è¿›ç¨‹ çº¿ç¨‹ å¤šçº¿ç¨‹</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="åˆ†ç±»äº UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="åˆ†ç±»äº UE4_C++">UE4_C++</a></div><span><a href="/2021/10/31/UE4/UE4CPP/Session%E7%9A%84%E4%BD%BF%E7%94%A8%20C++%E7%AF%87/" title="Sessionçš„ä½¿ç”¨ C++ç¯‡">Sessionçš„ä½¿ç”¨ C++ç¯‡</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/UE4/" title="åˆ†ç±»äº UE4">UE4</a> <i class="ic i-angle-right"></i> <a href="/categories/UE4/UE4CPP/" title="åˆ†ç±»äº UE4_C++">UE4_C++</a></div><span><a href="/2021/11/08/UE4/UE4CPP/UClass%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E6%88%90%E9%95%BF/" title="UClassçš„è¯ç”Ÿä¸æˆé•¿">UClassçš„è¯ç”Ÿä¸æˆé•¿</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="åˆ†ç±»äº C++åŸºç¡€">C++åŸºç¡€</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="åˆ†ç±»äº è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="åˆ†ç±»äº è¡Œä¸ºå‹æ¨¡å¼">è¡Œä¸ºå‹æ¨¡å¼</a></div><span><a href="/2021/08/19/CPPBase/DesignPattern/ChainOfResponsibility/" title="è´£ä»»é“¾æ¨¡å¼">è´£ä»»é“¾æ¨¡å¼</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="åˆ†ç±»äº C++åŸºç¡€">C++åŸºç¡€</a></div><span><a href="/2021/11/20/CPPBase/C++%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%20%E5%A4%8D%E5%88%BB/" title="C++æ™ºèƒ½æŒ‡é’ˆ å¤åˆ»">C++æ™ºèƒ½æŒ‡é’ˆ å¤åˆ»</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ComputerBase/" title="åˆ†ç±»äº è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€</a> <i class="ic i-angle-right"></i> <a href="/categories/ComputerBase/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" title="åˆ†ç±»äº è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</a></div><span><a href="/2021/08/16/ComputerBase/ComputerNetworks/TCPUDP%E4%BC%A0%E8%BE%93%E5%B1%82%E5%8D%8F%E8%AE%AE/" title="TCP&#x2F;UDPä¼ è¾“å±‚åè®®">TCP/UDPä¼ è¾“å±‚åè®®</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CPPBase/" title="åˆ†ç±»äº C++åŸºç¡€">C++åŸºç¡€</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="åˆ†ç±»äº è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a> <i class="ic i-angle-right"></i> <a href="/categories/CPPBase/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%A1%8C%E4%B8%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/" title="åˆ†ç±»äº è¡Œä¸ºå‹æ¨¡å¼">è¡Œä¸ºå‹æ¨¡å¼</a></div><span><a href="/2021/08/21/CPPBase/DesignPattern/State/" title="çŠ¶æ€æ¨¡å¼">çŠ¶æ€æ¨¡å¼</a></span></li></ul></div><div><h2>æœ€æ–°è¯„è®º</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">-YIFEI- @ Afei's Blog</span></div><div class="powered-by">åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/11/06/UE4/UE4CPP/Unreal GCè¿‡ç¨‹/",favicon:{show:"ï¼ˆâ—Â´3ï½€â—ï¼‰ã‚„ã‚Œã‚„ã‚Œã ãœ",hide:"(Â´Ğ”ï½€)å¤§å¤‰ã ï¼"},search:{placeholder:"æ–‡ç« æœç´¢",empty:"å…³äº ã€Œ ${query} ã€ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœåˆ°",stats:"${time} ms å†…æ‰¾åˆ° ${hits} æ¡ç»“æœ"},valine:!0,fancybox:!0,copyright:'å¤åˆ¶æˆåŠŸï¼Œè½¬è½½è¯·éµå®ˆ <i class="ic i-creative-commons"></i>BY-NC-SA åè®®ã€‚',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>